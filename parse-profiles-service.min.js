/**
 * themeans-core - 
 * @version v0.1.0 - 2015-04-07
 * @link 
 * @license 
 */
"use strict";angular.module("tm.parseProfiles",["angular-md5","tm.parse","tm.localstorage","tm.parseAccounts"]).factory("Profile",["Parse",function(a){return a.Object.extend("Profile")}]).factory("Follow",["Parse",function(a){return a.Object.extend("Follow")}]).factory("Connection",["Parse",function(a){return a.Object.extend("Connection")}]).run(["$rootScope","tmProfiles",function(a,b){b.setRootScope(a)}]).provider("tmProfiles",function(){var a={profileCacheKey:"User/Profile",profileEditCacheKey:"User/Profile/Edit",profilesCacheKey:"User/Profiles",connectionsCacheKey:"User/Connections",connectionsEditCacheKey:"User/Connections/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["$q","Profile","Follow","Parse","tmLocalStorage","$timeout","md5","Connection","tmAccounts","$log",function(b,c,d,e,f,g,h,i,j,k){function l(d,h){var i,j,l,m=b.defer(),o=new e.Query(c),p=a.profileCacheKey;return h&&(p=a.profileEditCacheKey),g(function(){l=f.getObject(p),m.notify(l)},0),o.get(d,{success:function(a){j=a.getNgModel(),h&&(j=a.getNgFormModel()),f.setObject(p,j),i=f.getObject(p),m.resolve(i)},error:function(a,b){return k.error("Parse Query Error: "+b.message,b.code),119===b.code?n(m,"Profile"):void m.reject({message:"Please try again in a few moments, or contact support."})}}),m.promise}function m(d){var h,i=b.defer(),j=new e.Query(c),l=a.profilesCacheKey,m=[];g(function(){h=f.getObject(l,[]),i.notify(h)},0);for(var o=arguments[1]?arguments[1]:[],p=0;p<o.length;p++)j.include(o[p]);return j.limit(1e3),j.ascending("businessName"),j.find({success:function(a){if(d)for(var b=0;b<a.length;b++)a[b].get("user")?a[b].get("user").id!==e.User.current().id&&m.push(a[b]):k.warn("Profiles are being created without Parse Users, or something is wrong with profile 'user' pointers.");else m=a;f.setObject(l,e.serialiseArrayForDisplay(m)),m=f.getObject(l,[]),i.resolve(m)},error:function(a){return k.error("Parse Error: "+a.message,a.code),119===a.code?n(i,"Profile"):void i.reject({message:"Please try again in a few moments, or contact support."})}}),i.promise}function n(a,b){return b=b?" on a "+b:"",e.User.current()?void j.getUserRoles(e.User.current()).then(function(){return a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+b})},function(){return f.clear(),e.User.logOut(),a.reject({title:"Your account is missing or something is wrong with authorisation.",message:"Please try logging in again or contacting support"})}):a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+b})}function o(c){var d=b.defer(),g=new e.Query(i),h=a.connectionsCacheKey;return c&&(h=a.connectionsEditCacheKey),g.include("receiver"),g.include("sender"),g.descending("updatedAt"),g.find({success:function(a){var b,g=[];if(c)return g=a.map(function(a){return a.getNgFormModel()}),f.setObject(h,g),d.resolve(g);g=a.map(function(a){return b=a.getNgModel(),b.connection=b.sender.user.objectId===e.User.current().id?b.receiver:b.sender,delete b.receiver,delete b.sender,"pending"===b.requestStatus&&delete b.connection.objectId,b});var i=[],j=[];return g.forEach(function(a){return"pending"===a.requestStatus?i.push(a):j.push(a)}),p&&p.GLOBALS&&p.GLOBALS.events&&p.GLOBALS.events.updateConnectionsBadge&&p.$broadcast(p.GLOBALS.events.updateConnectionsBadge,{pendingCount:i.length}),f.setObject(h,g),d.resolve({acceptedConnections:j,pendingConnections:i})},error:function(a){k.error("Parse Query Error: "+a.message,a.code),d.reject({message:"Something went wrong, please contact system admin."})}}),d.promise}var p;return this.setRootScope=function(a){p=a},this.getProfileByIdForEditing=function(a){return l(a,!0)},this.getProfileByIdForDisplay=function(a){return l(a,!1)},this.getProfiles=function(){return m(arguments)},this.getNeighbouringProfiles=function(){return m(!0,arguments)},this.updateProfile=function(d){var e=b.defer(),g=new c(d,{ngModel:!0,resetOpsQueue:!1}),h=a.profileEditCacheKey;return g.save(null,{success:function(a){f.setObject(h,a.getNgFormModel()),a=f.getObject(h),e.resolve(a)},error:function(a,b){k.error("Parse Save Error: "+b.message,b.code),e.reject({message:"Please try again in a few moments, or contact support."})}}),e.promise},this.followProfile=function(a,f){a=new c(a,{ngModel:!0,resetOpsQueue:!1});var g=b.defer(),i=new d,j=new e.ACL,l=f.get("profile"),m=h.createHash([a.id,l.id].sort().join(""));return i.set("follower",l),i.set("following",a),i.set("profileIdsHash",m),j.setPublicReadAccess(!0),j.setWriteAccess(f,!0),i.setACL(j),i.save().then(function(){g.resolve()},function(a){k.error("Parse Save Error: "+a.message,a.code),g.reject({message:"Please try again in a few moments, or contact support."})}),g.promise},this.destroyProfileRelation=function(a,c){var f,g=b.defer();if(!e.User.current())return g.reject({message:"You need to be logged in to connect with a profile."});switch(c){case"Follow":f=d;break;case"Connection":f=i}var j=[a,e.User.current().get("profile").id],l=new e.Query(f),m=h.createHash(j.sort().join(""));return l.equalTo("profileIdsHash",m),l.find({success:function(a){function b(a){a.destroy({success:function(){},error:function(a,b){k.error("Parse Destroy Error: "+b.message,b.code),g.reject({message:"Please try again in a few moments, or contact support."})}})}if(!a.length)return k.error("No Parse "+c+" object found."),void g.reject({message:"Please contact support"});for(var d=0;d<a.length;d++)b(a[d]),d===a.length-1&&g.resolve()},error:function(a,b){k.error("Parse Query Error: "+b.message,b.code),g.reject({message:"Please try again in a few moments, or contact support."})}}),g.promise},this.checkIfFollowExists=function(a){var c,f=b.defer(),g=new e.Query(d);return c=h.createHash(a.sort().join("")),g.equalTo("profileIdsHash",c),g.find({success:function(a){return a.length?void f.resolve(!0):f.resolve(!1)},error:function(a){k.error("Parse Query Error: "+a.message,a.code),f.reject({message:"Please try again in a few moments, or contact support."})}}),f.promise},this.connectWithProfile=function(a,d){var f=b.defer();if(!e.User.current())return f.reject({message:"You need to be logged in to connect with a Profile"});var g=e.User.current().id,l=e.User.current().get("profile"),m=a.user.objectId,n=new c,o=new i,p=new e.ACL,q=h.createHash([l.id,a.objectId].sort().join(""));return n.id=a.objectId,p.setReadAccess(g,!0),p.setWriteAccess(g,!0),p.setReadAccess(m,!0),p.setWriteAccess(m,!0),o.setACL(p),o.set("sender",l),o.set("receiver",n),o.set("profileIdsHash",q),o.set("requestStatus","accepted"),j.isUserInRole(d)&&o.set("requestStatus","pending"),o.save({success:function(a){f.resolve(a.getNgModel())},error:function(a){k.error("Parse Query Error: "+a.message,a.code),f.reject({message:"Please try again in a few moments, or contact support."})}}),f.promise},this.acceptConnectionRequest=function(a){function c(a){k.error("Parse Error: "+a.message,a.code),d.reject({message:"Please try again in a few moments, or contact support."})}var d=b.defer(),f=new e.Query(i);return e.User.current()&&j.isUserInRole("user")?(f.get(a).then(function(a){a.set("requestStatus","accepted"),a.save().then(function(a){var b=a.getNgModel();d.resolve(b)},c)},c),d.promise):d.reject({message:"You are not permitted to perform this action."})},this.checkIfConnectionExists=function(a){var c=b.defer();if(!e.User.current())return g(function(){c.resolve({noCurrentUser:!0})},0),c.promise;var d=new e.Query(i),f=[a,e.User.current().get("profile").id],j=h.createHash(f.sort().join(""));return d.equalTo("profileIdsHash",j),d.find({success:function(a){return a.length?a[0]&&"pending"===a[0].get("requestStatus")?c.resolve("pending"):a[0]&&"accepted"===a[0].get("requestStatus")?c.resolve("accepted"):(k.info("Parse Error",a),void c.reject({message:"Please try again in a few moments, or contact support."})):c.resolve("none")},error:function(a){k.error("Parse Query Error: "+a.message,a.code),c.reject({message:"Please try again in a few moments, or contact support."})}}),c.promise},this.getConnectionsForDisplay=function(){return o(!1)},this.getConnectionsForEdit=function(){return o(!0)},this}],this}),angular.module("tm.parseProfiles",["angular-md5","tm.parse","tm.localstorage","tm.parseAccounts"]).factory("Profile",["Parse",function(a){return a.Object.extend("Profile")}]).factory("Follow",["Parse",function(a){return a.Object.extend("Follow")}]).factory("Connection",["Parse",function(a){return a.Object.extend("Connection")}]).run(["$rootScope","tmProfiles",function(a,b){b.setRootScope(a)}]).provider("tmProfiles",function(){var a={profileCacheKey:"User/Profile",profileEditCacheKey:"User/Profile/Edit",profilesCacheKey:"User/Profiles",connectionsCacheKey:"User/Connections",connectionsEditCacheKey:"User/Connections/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["$q","Profile","Follow","Parse","tmLocalStorage","$timeout","md5","Connection","tmAccounts","$log",function(b,c,d,e,f,g,h,i,j,k){function l(d,h){var i,j,l,m=b.defer(),o=new e.Query(c),p=a.profileCacheKey;return h&&(p=a.profileEditCacheKey),g(function(){l=f.getObject(p),m.notify(l)},0),o.get(d,{success:function(a){j=a.getNgModel(),h&&(j=a.getNgFormModel()),f.setObject(p,j),i=f.getObject(p),m.resolve(i)},error:function(a,b){return k.error("Parse Query Error: "+b.message,b.code),119===b.code?n(m,"Profile"):void m.reject({message:"Please try again in a few moments, or contact support."})}}),m.promise}function m(d){var h,i=b.defer(),j=new e.Query(c),l=a.profilesCacheKey,m=[];g(function(){h=f.getObject(l,[]),i.notify(h)},0);for(var o=arguments[1]?arguments[1]:[],p=0;p<o.length;p++)j.include(o[p]);return j.limit(1e3),j.ascending("businessName"),j.find({success:function(a){if(d)for(var b=0;b<a.length;b++)a[b].get("user")?a[b].get("user").id!==e.User.current().id&&m.push(a[b]):k.warn("Profiles are being created without Parse Users, or something is wrong with profile 'user' pointers.");else m=a;f.setObject(l,e.serialiseArrayForDisplay(m)),m=f.getObject(l,[]),i.resolve(m)},error:function(a){return k.error("Parse Error: "+a.message,a.code),119===a.code?n(i,"Profile"):void i.reject({message:"Please try again in a few moments, or contact support."})}}),i.promise}function n(a,b){return b=b?" on a "+b:"",e.User.current()?void j.getUserRoles(e.User.current()).then(function(){return a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+b})},function(){return f.clear(),e.User.logOut(),a.reject({title:"Your account is missing or something is wrong with authorisation.",message:"Please try logging in again or contacting support"})}):a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+b})}function o(c){var d=b.defer(),g=new e.Query(i),h=a.connectionsCacheKey;return c&&(h=a.connectionsEditCacheKey),g.include("receiver"),g.include("sender"),g.descending("updatedAt"),g.find({success:function(a){var b,g=[];if(c)return g=a.map(function(a){return a.getNgFormModel()}),f.setObject(h,g),d.resolve(g);g=a.map(function(a){return b=a.getNgModel(),b.connection=b.sender.user.objectId===e.User.current().id?b.receiver:b.sender,delete b.receiver,delete b.sender,"pending"===b.requestStatus&&delete b.connection.objectId,b});var i=[],j=[];return g.forEach(function(a){return"pending"===a.requestStatus?i.push(a):j.push(a)}),p&&p.GLOBALS&&p.GLOBALS.events&&p.GLOBALS.events.updateConnectionsBadge&&p.$broadcast(p.GLOBALS.events.updateConnectionsBadge,{pendingCount:i.length}),f.setObject(h,g),d.resolve({acceptedConnections:j,pendingConnections:i})},error:function(a){k.error("Parse Query Error: "+a.message,a.code),d.reject({message:"Something went wrong, please contact system admin."})}}),d.promise}var p;return this.setRootScope=function(a){p=a},this.getProfileByIdForEditing=function(a){return l(a,!0)},this.getProfileByIdForDisplay=function(a){return l(a,!1)},this.getProfiles=function(){return m(arguments)},this.getNeighbouringProfiles=function(){return m(!0,arguments)},this.updateProfile=function(d){var e=b.defer(),g=new c(d,{ngModel:!0,resetOpsQueue:!1}),h=a.profileEditCacheKey;return g.save(null,{success:function(a){f.setObject(h,a.getNgFormModel()),a=f.getObject(h),e.resolve(a)},error:function(a,b){k.error("Parse Save Error: "+b.message,b.code),e.reject({message:"Please try again in a few moments, or contact support."})}}),e.promise},this.followProfile=function(a,f){a=new c(a,{ngModel:!0,resetOpsQueue:!1});var g=b.defer(),i=new d,j=new e.ACL,l=f.get("profile"),m=h.createHash([a.id,l.id].sort().join(""));return i.set("follower",l),i.set("following",a),i.set("profileIdsHash",m),j.setPublicReadAccess(!0),j.setWriteAccess(f,!0),i.setACL(j),i.save().then(function(){g.resolve()},function(a){k.error("Parse Save Error: "+a.message,a.code),g.reject({message:"Please try again in a few moments, or contact support."})}),g.promise},this.destroyProfileRelation=function(a,c){var f,g=b.defer();if(!e.User.current())return g.reject({message:"You need to be logged in to connect with a profile."});switch(c){case"Follow":f=d;break;case"Connection":f=i}var j=[a,e.User.current().get("profile").id],l=new e.Query(f),m=h.createHash(j.sort().join(""));return l.equalTo("profileIdsHash",m),l.find({success:function(a){function b(a){a.destroy({success:function(){},error:function(a,b){k.error("Parse Destroy Error: "+b.message,b.code),g.reject({message:"Please try again in a few moments, or contact support."})}})}if(!a.length)return k.error("No Parse "+c+" object found."),void g.reject({message:"Please contact support"});for(var d=0;d<a.length;d++)b(a[d]),d===a.length-1&&g.resolve()},error:function(a,b){k.error("Parse Query Error: "+b.message,b.code),g.reject({message:"Please try again in a few moments, or contact support."})}}),g.promise},this.checkIfFollowExists=function(a){var c,f=b.defer(),g=new e.Query(d);return c=h.createHash(a.sort().join("")),g.equalTo("profileIdsHash",c),g.find({success:function(a){return a.length?void f.resolve(!0):f.resolve(!1)},error:function(a){k.error("Parse Query Error: "+a.message,a.code),f.reject({message:"Please try again in a few moments, or contact support."})}}),f.promise},this.connectWithProfile=function(a,d){var f=b.defer();if(!e.User.current())return f.reject({message:"You need to be logged in to connect with a Profile"});var g=e.User.current().id,l=e.User.current().get("profile"),m=a.user.objectId,n=new c,o=new i,p=new e.ACL,q=h.createHash([l.id,a.objectId].sort().join(""));return n.id=a.objectId,p.setReadAccess(g,!0),p.setWriteAccess(g,!0),p.setReadAccess(m,!0),p.setWriteAccess(m,!0),o.setACL(p),o.set("sender",l),o.set("receiver",n),o.set("profileIdsHash",q),o.set("requestStatus","accepted"),j.isUserInRole(d)&&o.set("requestStatus","pending"),o.save({success:function(a){f.resolve(a.getNgModel())},error:function(a){k.error("Parse Query Error: "+a.message,a.code),f.reject({message:"Please try again in a few moments, or contact support."})}}),f.promise},this.acceptConnectionRequest=function(a){function c(a){k.error("Parse Error: "+a.message,a.code),d.reject({message:"Please try again in a few moments, or contact support."})}var d=b.defer(),f=new e.Query(i);return e.User.current()&&j.isUserInRole("user")?(f.get(a).then(function(a){a.set("requestStatus","accepted"),a.save().then(function(a){var b=a.getNgModel();d.resolve(b)},c)},c),d.promise):d.reject({message:"You are not permitted to perform this action."})},this.checkIfConnectionExists=function(a){var c=b.defer();if(!e.User.current())return g(function(){c.resolve({noCurrentUser:!0})},0),c.promise;var d=new e.Query(i),f=[a,e.User.current().get("profile").id],j=h.createHash(f.sort().join(""));return d.equalTo("profileIdsHash",j),d.find({success:function(a){return a.length?a[0]&&"pending"===a[0].get("requestStatus")?c.resolve("pending"):a[0]&&"accepted"===a[0].get("requestStatus")?c.resolve("accepted"):(k.info("Parse Error",a),void c.reject({message:"Please try again in a few moments, or contact support."})):c.resolve("none")},error:function(a){k.error("Parse Query Error: "+a.message,a.code),c.reject({message:"Please try again in a few moments, or contact support."})}}),c.promise},this.getConnectionsForDisplay=function(){return o(!1)},this.getConnectionsForEdit=function(){return o(!0)},this}],this}),angular.module("tm.parseProfiles",["angular-md5","tm.parse","tm.localstorage","tm.parseAccounts"]).factory("Profile",["Parse",function(a){return a.Object.extend("Profile")}]).factory("Follow",["Parse",function(a){return a.Object.extend("Follow")}]).factory("Connection",["Parse",function(a){return a.Object.extend("Connection")}]).run(["$rootScope","tmProfiles",function(a,b){b.setRootScope(a)}]).provider("tmProfiles",function(){var a={profileCacheKey:"User/Profile",profileEditCacheKey:"User/Profile/Edit",profilesCacheKey:"User/Profiles",connectionsCacheKey:"User/Connections",connectionsEditCacheKey:"User/Connections/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["$q","Profile","Follow","Parse","tmLocalStorage","$timeout","md5","Connection","tmAccounts","$log",function(b,c,d,e,f,g,h,i,j,k){function l(d,h){var i,j,l,m=b.defer(),o=new e.Query(c),p=a.profileCacheKey;return h&&(p=a.profileEditCacheKey),g(function(){l=f.getObject(p),m.notify(l)},0),o.get(d,{success:function(a){j=a.getNgModel(),h&&(j=a.getNgFormModel()),f.setObject(p,j),i=f.getObject(p),m.resolve(i)},error:function(a,b){return k.error("Parse Query Error: "+b.message,b.code),119===b.code?n(m,"Profile"):void m.reject({message:"Please try again in a few moments, or contact support."})}}),m.promise}function m(d){var h,i=b.defer(),j=new e.Query(c),l=a.profilesCacheKey,m=[];g(function(){h=f.getObject(l,[]),i.notify(h)},0);for(var o=arguments[1]?arguments[1]:[],p=0;p<o.length;p++)j.include(o[p]);return j.limit(1e3),j.ascending("businessName"),j.find({success:function(a){if(d)for(var b=0;b<a.length;b++)a[b].get("user")?a[b].get("user").id!==e.User.current().id&&m.push(a[b]):k.warn("Profiles are being created without Parse Users, or something is wrong with profile 'user' pointers.");else m=a;f.setObject(l,e.serialiseArrayForDisplay(m)),m=f.getObject(l,[]),i.resolve(m)},error:function(a){return k.error("Parse Error: "+a.message,a.code),119===a.code?n(i,"Profile"):void i.reject({message:"Please try again in a few moments, or contact support."})}}),i.promise}function n(a,b){return b=b?" on a "+b:"",e.User.current()?void j.getUserRoles(e.User.current()).then(function(){return a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+b})},function(){return f.clear(),e.User.logOut(),a.reject({title:"Your account is missing or something is wrong with authorisation.",message:"Please try logging in again or contacting support"})}):a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+b})}function o(c){var d=b.defer(),g=new e.Query(i),h=a.connectionsCacheKey;return c&&(h=a.connectionsEditCacheKey),g.include("receiver"),g.include("sender"),g.descending("updatedAt"),g.find({success:function(a){var b,g=[];if(c)return g=a.map(function(a){return a.getNgFormModel()}),f.setObject(h,g),d.resolve(g);g=a.map(function(a){return b=a.getNgModel(),b.connection=b.sender.user.objectId===e.User.current().id?b.receiver:b.sender,delete b.receiver,delete b.sender,"pending"===b.requestStatus&&delete b.connection.objectId,b});var i=[],j=[];return g.forEach(function(a){return"pending"===a.requestStatus?i.push(a):j.push(a)}),p&&p.GLOBALS&&p.GLOBALS.events&&p.GLOBALS.events.updateConnectionsBadge&&p.$broadcast(p.GLOBALS.events.updateConnectionsBadge,{pendingCount:i.length}),f.setObject(h,g),d.resolve({acceptedConnections:j,pendingConnections:i})},error:function(a){k.error("Parse Query Error: "+a.message,a.code),d.reject({message:"Something went wrong, please contact system admin."})}}),d.promise}var p;return this.setRootScope=function(a){p=a},this.getProfileByIdForEditing=function(a){return l(a,!0)},this.getProfileByIdForDisplay=function(a){return l(a,!1)},this.getProfiles=function(){return m(arguments)},this.getNeighbouringProfiles=function(){return m(!0,arguments)},this.updateProfile=function(d){var e=b.defer(),g=new c(d,{ngModel:!0,resetOpsQueue:!1}),h=a.profileEditCacheKey;return g.save(null,{success:function(a){f.setObject(h,a.getNgFormModel()),a=f.getObject(h),e.resolve(a)},error:function(a,b){k.error("Parse Save Error: "+b.message,b.code),e.reject({message:"Please try again in a few moments, or contact support."})}}),e.promise},this.followProfile=function(a,f){a=new c(a,{ngModel:!0,resetOpsQueue:!1});var g=b.defer(),i=new d,j=new e.ACL,l=f.get("profile"),m=h.createHash([a.id,l.id].sort().join(""));return i.set("follower",l),i.set("following",a),i.set("profileIdsHash",m),j.setPublicReadAccess(!0),j.setWriteAccess(f,!0),i.setACL(j),i.save().then(function(){g.resolve()},function(a){k.error("Parse Save Error: "+a.message,a.code),g.reject({message:"Please try again in a few moments, or contact support."})}),g.promise},this.destroyProfileRelation=function(a,c){var f,g=b.defer();if(!e.User.current())return g.reject({message:"You need to be logged in to connect with a profile."});switch(c){case"Follow":f=d;break;case"Connection":f=i}var j=[a,e.User.current().get("profile").id],l=new e.Query(f),m=h.createHash(j.sort().join(""));return l.equalTo("profileIdsHash",m),l.find({success:function(a){function b(a){a.destroy({success:function(){},error:function(a,b){k.error("Parse Destroy Error: "+b.message,b.code),g.reject({message:"Please try again in a few moments, or contact support."})}})}if(!a.length)return k.error("No Parse "+c+" object found."),void g.reject({message:"Please contact support"});for(var d=0;d<a.length;d++)b(a[d]),d===a.length-1&&g.resolve()},error:function(a,b){k.error("Parse Query Error: "+b.message,b.code),g.reject({message:"Please try again in a few moments, or contact support."})}}),g.promise},this.checkIfFollowExists=function(a){var c,f=b.defer(),g=new e.Query(d);return c=h.createHash(a.sort().join("")),g.equalTo("profileIdsHash",c),g.find({success:function(a){return a.length?void f.resolve(!0):f.resolve(!1)},error:function(a){k.error("Parse Query Error: "+a.message,a.code),f.reject({message:"Please try again in a few moments, or contact support."})}}),f.promise},this.connectWithProfile=function(a,d){var f=b.defer();if(!e.User.current())return f.reject({message:"You need to be logged in to connect with a Profile"});var g=e.User.current().id,l=e.User.current().get("profile"),m=a.user.objectId,n=new c,o=new i,p=new e.ACL,q=h.createHash([l.id,a.objectId].sort().join(""));return n.id=a.objectId,p.setReadAccess(g,!0),p.setWriteAccess(g,!0),p.setReadAccess(m,!0),p.setWriteAccess(m,!0),o.setACL(p),o.set("sender",l),o.set("receiver",n),o.set("profileIdsHash",q),o.set("requestStatus","accepted"),j.isUserInRole(d)&&o.set("requestStatus","pending"),o.save({success:function(a){f.resolve(a.getNgModel())},error:function(a){k.error("Parse Query Error: "+a.message,a.code),f.reject({message:"Please try again in a few moments, or contact support."})}}),f.promise},this.acceptConnectionRequest=function(a){function c(a){k.error("Parse Error: "+a.message,a.code),d.reject({message:"Please try again in a few moments, or contact support."})}var d=b.defer(),f=new e.Query(i);return e.User.current()&&j.isUserInRole("user")?(f.get(a).then(function(a){a.set("requestStatus","accepted"),a.save().then(function(a){var b=a.getNgModel();d.resolve(b)},c)},c),d.promise):d.reject({message:"You are not permitted to perform this action."})},this.checkIfConnectionExists=function(a){var c=b.defer();if(!e.User.current())return g(function(){c.resolve({noCurrentUser:!0})},0),c.promise;var d=new e.Query(i),f=[a,e.User.current().get("profile").id],j=h.createHash(f.sort().join(""));return d.equalTo("profileIdsHash",j),d.find({success:function(a){return a.length?a[0]&&"pending"===a[0].get("requestStatus")?c.resolve("pending"):a[0]&&"accepted"===a[0].get("requestStatus")?c.resolve("accepted"):(k.info("Parse Error",a),void c.reject({message:"Please try again in a few moments, or contact support."})):c.resolve("none")},error:function(a){k.error("Parse Query Error: "+a.message,a.code),c.reject({message:"Please try again in a few moments, or contact support."})}}),c.promise},this.getConnectionsForDisplay=function(){return o(!1)},this.getConnectionsForEdit=function(){return o(!0)},this}],this}),angular.module("tm.parseProfiles",["angular-md5","tm.parse","tm.localstorage","tm.parseAccounts"]).factory("Profile",["Parse",function(a){return a.Object.extend("Profile")}]).factory("Follow",["Parse",function(a){return a.Object.extend("Follow")}]).factory("Connection",["Parse",function(a){return a.Object.extend("Connection")}]).run(["$rootScope","tmProfiles",function(a,b){b.setRootScope(a)}]).provider("tmProfiles",function(){var a={profileCacheKey:"User/Profile",profileEditCacheKey:"User/Profile/Edit",profilesCacheKey:"User/Profiles",connectionsCacheKey:"User/Connections",connectionsEditCacheKey:"User/Connections/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["$q","Profile","Follow","Parse","tmLocalStorage","$timeout","md5","Connection","tmAccounts","$log",function(b,c,d,e,f,g,h,i,j,k){function l(d,h){var i,j,l,m=b.defer(),o=new e.Query(c),p=a.profileCacheKey;return h&&(p=a.profileEditCacheKey),g(function(){l=f.getObject(p),m.notify(l)},0),o.get(d,{success:function(a){j=a.getNgModel(),h&&(j=a.getNgFormModel()),f.setObject(p,j),i=f.getObject(p),m.resolve(i)},error:function(a,b){return k.error("Parse Query Error: "+b.message,b.code),119===b.code?n(m,"Profile"):void m.reject({message:"Please try again in a few moments, or contact support."})}}),m.promise}function m(d){var h,i=b.defer(),j=new e.Query(c),l=a.profilesCacheKey,m=[];g(function(){h=f.getObject(l,[]),i.notify(h)},0);for(var o=arguments[1]?arguments[1]:[],p=0;p<o.length;p++)j.include(o[p]);return j.limit(1e3),j.ascending("businessName"),j.find({success:function(a){if(d)for(var b=0;b<a.length;b++)a[b].get("user")?a[b].get("user").id!==e.User.current().id&&m.push(a[b]):k.warn("Profiles are being created without Parse Users, or something is wrong with profile 'user' pointers.");else m=a;f.setObject(l,e.serialiseArrayForDisplay(m)),m=f.getObject(l,[]),i.resolve(m)},error:function(a){return k.error("Parse Error: "+a.message,a.code),119===a.code?n(i,"Profile"):void i.reject({message:"Please try again in a few moments, or contact support."})}}),i.promise}function n(a,b){return b=b?" on a "+b:"",e.User.current()?void j.getUserRoles(e.User.current()).then(function(){return a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+b})},function(){return f.clear(),e.User.logOut(),a.reject({title:"Your account is missing or something is wrong with authorisation.",message:"Please try logging in again or contacting support"})}):a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+b})}function o(c){var d=b.defer(),g=new e.Query(i),h=a.connectionsCacheKey;return c&&(h=a.connectionsEditCacheKey),g.include("receiver"),g.include("sender"),g.descending("updatedAt"),g.find({success:function(a){var b,g=[];if(c)return g=a.map(function(a){return a.getNgFormModel()}),f.setObject(h,g),d.resolve(g);g=a.map(function(a){return b=a.getNgModel(),b.connection=b.sender.user.objectId===e.User.current().id?b.receiver:b.sender,delete b.receiver,delete b.sender,"pending"===b.requestStatus&&delete b.connection.objectId,b});var i=[],j=[];return g.forEach(function(a){return"pending"===a.requestStatus?i.push(a):j.push(a)}),p&&p.GLOBALS&&p.GLOBALS.events&&p.GLOBALS.events.updateConnectionsBadge&&p.$broadcast(p.GLOBALS.events.updateConnectionsBadge,{pendingCount:i.length}),f.setObject(h,g),d.resolve({acceptedConnections:j,pendingConnections:i})},error:function(a){k.error("Parse Query Error: "+a.message,a.code),d.reject({message:"Something went wrong, please contact system admin."})}}),d.promise}var p;return this.setRootScope=function(a){p=a},this.getProfileByIdForEditing=function(a){return l(a,!0)},this.getProfileByIdForDisplay=function(a){return l(a,!1)},this.getProfiles=function(){return m(arguments)},this.getNeighbouringProfiles=function(){return m(!0,arguments)},this.updateProfile=function(d){var e=b.defer(),g=new c(d,{ngModel:!0,resetOpsQueue:!1}),h=a.profileEditCacheKey;return g.save(null,{success:function(a){f.setObject(h,a.getNgFormModel()),a=f.getObject(h),e.resolve(a)},error:function(a,b){k.error("Parse Save Error: "+b.message,b.code),e.reject({message:"Please try again in a few moments, or contact support."})}}),e.promise},this.followProfile=function(a,f){a=new c(a,{ngModel:!0,resetOpsQueue:!1});var g=b.defer(),i=new d,j=new e.ACL,l=f.get("profile"),m=h.createHash([a.id,l.id].sort().join(""));return i.set("follower",l),i.set("following",a),i.set("profileIdsHash",m),j.setPublicReadAccess(!0),j.setWriteAccess(f,!0),i.setACL(j),i.save().then(function(){g.resolve()},function(a){k.error("Parse Save Error: "+a.message,a.code),g.reject({message:"Please try again in a few moments, or contact support."})}),g.promise},this.destroyProfileRelation=function(a,c){var f,g=b.defer();if(!e.User.current())return g.reject({message:"You need to be logged in to connect with a profile."});switch(c){case"Follow":f=d;break;case"Connection":f=i}var j=[a,e.User.current().get("profile").id],l=new e.Query(f),m=h.createHash(j.sort().join(""));return l.equalTo("profileIdsHash",m),l.find({success:function(a){function b(a){a.destroy({success:function(){},error:function(a,b){k.error("Parse Destroy Error: "+b.message,b.code),g.reject({message:"Please try again in a few moments, or contact support."})}})}if(!a.length)return k.error("No Parse "+c+" object found."),void g.reject({message:"Please contact support"});for(var d=0;d<a.length;d++)b(a[d]),d===a.length-1&&g.resolve()},error:function(a,b){k.error("Parse Query Error: "+b.message,b.code),g.reject({message:"Please try again in a few moments, or contact support."})}}),g.promise},this.checkIfFollowExists=function(a){var c,f=b.defer(),g=new e.Query(d);return c=h.createHash(a.sort().join("")),g.equalTo("profileIdsHash",c),g.find({success:function(a){return a.length?void f.resolve(!0):f.resolve(!1)},error:function(a){k.error("Parse Query Error: "+a.message,a.code),f.reject({message:"Please try again in a few moments, or contact support."})}}),f.promise},this.connectWithProfile=function(a,d){var f=b.defer();if(!e.User.current())return f.reject({message:"You need to be logged in to connect with a Profile"});var g=e.User.current().id,l=e.User.current().get("profile"),m=a.user.objectId,n=new c,o=new i,p=new e.ACL,q=h.createHash([l.id,a.objectId].sort().join(""));return n.id=a.objectId,p.setReadAccess(g,!0),p.setWriteAccess(g,!0),p.setReadAccess(m,!0),p.setWriteAccess(m,!0),o.setACL(p),o.set("sender",l),o.set("receiver",n),o.set("profileIdsHash",q),o.set("requestStatus","accepted"),j.isUserInRole(d)&&o.set("requestStatus","pending"),o.save({success:function(a){f.resolve(a.getNgModel())},error:function(a){k.error("Parse Query Error: "+a.message,a.code),f.reject({message:"Please try again in a few moments, or contact support."})}}),f.promise},this.acceptConnectionRequest=function(a){function c(a){k.error("Parse Error: "+a.message,a.code),d.reject({message:"Please try again in a few moments, or contact support."})}var d=b.defer(),f=new e.Query(i);return e.User.current()&&j.isUserInRole("user")?(f.get(a).then(function(a){a.set("requestStatus","accepted"),a.save().then(function(a){var b=a.getNgModel();d.resolve(b)},c)},c),d.promise):d.reject({message:"You are not permitted to perform this action."})},this.checkIfConnectionExists=function(a){var c=b.defer();if(!e.User.current())return g(function(){c.resolve({noCurrentUser:!0})},0),c.promise;var d=new e.Query(i),f=[a,e.User.current().get("profile").id],j=h.createHash(f.sort().join(""));return d.equalTo("profileIdsHash",j),d.find({success:function(a){return a.length?a[0]&&"pending"===a[0].get("requestStatus")?c.resolve("pending"):a[0]&&"accepted"===a[0].get("requestStatus")?c.resolve("accepted"):(k.info("Parse Error",a),
void c.reject({message:"Please try again in a few moments, or contact support."})):c.resolve("none")},error:function(a){k.error("Parse Query Error: "+a.message,a.code),c.reject({message:"Please try again in a few moments, or contact support."})}}),c.promise},this.getConnectionsForDisplay=function(){return o(!1)},this.getConnectionsForEdit=function(){return o(!0)},this}],this}),angular.module("tm.parseProfiles",["angular-md5","tm.parse","tm.localstorage","tm.parseAccounts"]).factory("Profile",["Parse",function(a){return a.Object.extend("Profile")}]).factory("Follow",["Parse",function(a){return a.Object.extend("Follow")}]).factory("Connection",["Parse",function(a){return a.Object.extend("Connection")}]).run(["$rootScope","tmProfiles",function(a,b){b.setRootScope(a)}]).provider("tmProfiles",function(){var a={profileCacheKey:"User/Profile",profileEditCacheKey:"User/Profile/Edit",profilesCacheKey:"User/Profiles",connectionsCacheKey:"User/Connections",connectionsEditCacheKey:"User/Connections/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["$q","Profile","Follow","Parse","tmLocalStorage","$timeout","md5","Connection","tmAccounts","$log",function(b,c,d,e,f,g,h,i,j,k){function l(d,h){var i,j,l,m=b.defer(),o=new e.Query(c),p=a.profileCacheKey;return h&&(p=a.profileEditCacheKey),g(function(){l=f.getObject(p),m.notify(l)},0),o.get(d,{success:function(a){j=a.getNgModel(),h&&(j=a.getNgFormModel()),f.setObject(p,j),i=f.getObject(p),m.resolve(i)},error:function(a,b){return k.error("Parse Query Error: "+b.message,b.code),119===b.code?n(m,"Profile"):void m.reject({message:"Please try again in a few moments, or contact support."})}}),m.promise}function m(d){var h,i=b.defer(),j=new e.Query(c),l=a.profilesCacheKey,m=[];g(function(){h=f.getObject(l,[]),i.notify(h)},0);for(var o=arguments[1]?arguments[1]:[],p=0;p<o.length;p++)j.include(o[p]);return j.limit(1e3),j.ascending("businessName"),j.find({success:function(a){if(d)for(var b=0;b<a.length;b++)a[b].get("user")?a[b].get("user").id!==e.User.current().id&&m.push(a[b]):k.warn("Profiles are being created without Parse Users, or something is wrong with profile 'user' pointers.");else m=a;f.setObject(l,e.serialiseArrayForDisplay(m)),m=f.getObject(l,[]),i.resolve(m)},error:function(a){return k.error("Parse Error: "+a.message,a.code),119===a.code?n(i,"Profile"):void i.reject({message:"Please try again in a few moments, or contact support."})}}),i.promise}function n(a,b){return b=b?" on a "+b:"",e.User.current()?void j.getUserRoles(e.User.current()).then(function(){return a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+b})},function(){return f.clear(),e.User.logOut(),a.reject({title:"Your account is missing or something is wrong with authorisation.",message:"Please try logging in again or contacting support"})}):a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+b})}function o(c){var d=b.defer(),g=new e.Query(i),h=a.connectionsCacheKey;return c&&(h=a.connectionsEditCacheKey),g.include("receiver"),g.include("sender"),g.descending("updatedAt"),g.find({success:function(a){var b,g=[];if(c)return g=a.map(function(a){return a.getNgFormModel()}),f.setObject(h,g),d.resolve(g);g=a.map(function(a){return b=a.getNgModel(),b.connection=b.sender.user.objectId===e.User.current().id?b.receiver:b.sender,delete b.receiver,delete b.sender,"pending"===b.requestStatus&&delete b.connection.objectId,b});var i=[],j=[];return g.forEach(function(a){return"pending"===a.requestStatus?i.push(a):j.push(a)}),p&&p.GLOBALS&&p.GLOBALS.events&&p.GLOBALS.events.updateConnectionsBadge&&p.$broadcast(p.GLOBALS.events.updateConnectionsBadge,{pendingCount:i.length}),f.setObject(h,g),d.resolve({acceptedConnections:j,pendingConnections:i})},error:function(a){k.error("Parse Query Error: "+a.message,a.code),d.reject({message:"Something went wrong, please contact system admin."})}}),d.promise}var p;return this.setRootScope=function(a){p=a},this.getProfileByIdForEditing=function(a){return l(a,!0)},this.getProfileByIdForDisplay=function(a){return l(a,!1)},this.getProfiles=function(){return m(arguments)},this.getNeighbouringProfiles=function(){return m(!0,arguments)},this.updateProfile=function(d){var e=b.defer(),g=new c(d,{ngModel:!0,resetOpsQueue:!1}),h=a.profileEditCacheKey;return g.save(null,{success:function(a){f.setObject(h,a.getNgFormModel()),a=f.getObject(h),e.resolve(a)},error:function(a,b){k.error("Parse Save Error: "+b.message,b.code),e.reject({message:"Please try again in a few moments, or contact support."})}}),e.promise},this.followProfile=function(a,f){a=new c(a,{ngModel:!0,resetOpsQueue:!1});var g=b.defer(),i=new d,j=new e.ACL,l=f.get("profile"),m=h.createHash([a.id,l.id].sort().join(""));return i.set("follower",l),i.set("following",a),i.set("profileIdsHash",m),j.setPublicReadAccess(!0),j.setWriteAccess(f,!0),i.setACL(j),i.save().then(function(){g.resolve()},function(a){k.error("Parse Save Error: "+a.message,a.code),g.reject({message:"Please try again in a few moments, or contact support."})}),g.promise},this.destroyProfileRelation=function(a,c){var f,g=b.defer();if(!e.User.current())return g.reject({message:"You need to be logged in to connect with a profile."});switch(c){case"Follow":f=d;break;case"Connection":f=i}var j=[a,e.User.current().get("profile").id],l=new e.Query(f),m=h.createHash(j.sort().join(""));return l.equalTo("profileIdsHash",m),l.find({success:function(a){function b(a){a.destroy({success:function(){},error:function(a,b){k.error("Parse Destroy Error: "+b.message,b.code),g.reject({message:"Please try again in a few moments, or contact support."})}})}if(!a.length)return k.error("No Parse "+c+" object found."),void g.reject({message:"Please contact support"});for(var d=0;d<a.length;d++)b(a[d]),d===a.length-1&&g.resolve()},error:function(a,b){k.error("Parse Query Error: "+b.message,b.code),g.reject({message:"Please try again in a few moments, or contact support."})}}),g.promise},this.checkIfFollowExists=function(a){var c,f=b.defer(),g=new e.Query(d);return c=h.createHash(a.sort().join("")),g.equalTo("profileIdsHash",c),g.find({success:function(a){return a.length?void f.resolve(!0):f.resolve(!1)},error:function(a){k.error("Parse Query Error: "+a.message,a.code),f.reject({message:"Please try again in a few moments, or contact support."})}}),f.promise},this.connectWithProfile=function(a,d){var f=b.defer();if(!e.User.current())return f.reject({message:"You need to be logged in to connect with a Profile"});var g=e.User.current().id,l=e.User.current().get("profile"),m=a.user.objectId,n=new c,o=new i,p=new e.ACL,q=h.createHash([l.id,a.objectId].sort().join(""));return n.id=a.objectId,p.setReadAccess(g,!0),p.setWriteAccess(g,!0),p.setReadAccess(m,!0),p.setWriteAccess(m,!0),o.setACL(p),o.set("sender",l),o.set("receiver",n),o.set("profileIdsHash",q),o.set("requestStatus","accepted"),j.isUserInRole(d)&&o.set("requestStatus","pending"),o.save({success:function(a){f.resolve(a.getNgModel())},error:function(a){k.error("Parse Query Error: "+a.message,a.code),f.reject({message:"Please try again in a few moments, or contact support."})}}),f.promise},this.acceptConnectionRequest=function(a){function c(a){k.error("Parse Error: "+a.message,a.code),d.reject({message:"Please try again in a few moments, or contact support."})}var d=b.defer(),f=new e.Query(i);return e.User.current()&&j.isUserInRole("user")?(f.get(a).then(function(a){a.set("requestStatus","accepted"),a.save().then(function(a){var b=a.getNgModel();d.resolve(b)},c)},c),d.promise):d.reject({message:"You are not permitted to perform this action."})},this.checkIfConnectionExists=function(a){var c=b.defer();if(!e.User.current())return g(function(){c.resolve({noCurrentUser:!0})},0),c.promise;var d=new e.Query(i),f=[a,e.User.current().get("profile").id],j=h.createHash(f.sort().join(""));return d.equalTo("profileIdsHash",j),d.find({success:function(a){return a.length?a[0]&&"pending"===a[0].get("requestStatus")?c.resolve("pending"):a[0]&&"accepted"===a[0].get("requestStatus")?c.resolve("accepted"):(k.info("Parse Error",a),void c.reject({message:"Please try again in a few moments, or contact support."})):c.resolve("none")},error:function(a){k.error("Parse Query Error: "+a.message,a.code),c.reject({message:"Please try again in a few moments, or contact support."})}}),c.promise},this.getConnectionsForDisplay=function(){return o(!1)},this.getConnectionsForEdit=function(){return o(!0)},this}],this}),angular.module("tm.parseProfiles",["angular-md5","tm.parse","tm.localstorage","tm.parseAccounts"]).factory("Profile",["Parse",function(a){return a.Object.extend("Profile")}]).factory("Follow",["Parse",function(a){return a.Object.extend("Follow")}]).factory("Connection",["Parse",function(a){return a.Object.extend("Connection")}]).run(["$rootScope","tmProfiles",function(a,b){b.setRootScope(a)}]).provider("tmProfiles",function(){var a={profileCacheKey:"User/Profile",profileEditCacheKey:"User/Profile/Edit",profilesCacheKey:"User/Profiles",connectionsCacheKey:"User/Connections",connectionsEditCacheKey:"User/Connections/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["$q","Profile","Follow","Parse","tmLocalStorage","$timeout","md5","Connection","tmAccounts","$log",function(b,c,d,e,f,g,h,i,j,k){function l(d,h){var i,j,l,m=b.defer(),o=new e.Query(c),p=a.profileCacheKey;return h&&(p=a.profileEditCacheKey),g(function(){l=f.getObject(p),m.notify(l)},0),o.get(d,{success:function(a){j=a.getNgModel(),h&&(j=a.getNgFormModel()),f.setObject(p,j),i=f.getObject(p),m.resolve(i)},error:function(a,b){return k.error("Parse Query Error: "+b.message,b.code),119===b.code?n(m,"Profile"):void m.reject({message:"Please try again in a few moments, or contact support."})}}),m.promise}function m(d){var h,i=b.defer(),j=new e.Query(c),l=a.profilesCacheKey,m=[];g(function(){h=f.getObject(l,[]),i.notify(h)},0);for(var o=arguments[1]?arguments[1]:[],p=0;p<o.length;p++)j.include(o[p]);return j.find({success:function(a){if(d)for(var b=0;b<a.length;b++)a[b].get("user")?a[b].get("user").id!==e.User.current().id&&m.push(a[b]):k.warn("Profiles are being created without Parse Users, or something is wrong with profile 'user' pointers.");else m=a;f.setObject(l,e.serialiseArrayForDisplay(m)),m=f.getObject(l,[]),i.resolve(m)},error:function(a){return k.error("Parse Error: "+a.message,a.code),119===a.code?n(i,"Profile"):void i.reject({message:"Please try again in a few moments, or contact support."})}}),i.promise}function n(a,b){return b=b?" on a "+b:"",e.User.current()?void j.getUserRoles(e.User.current()).then(function(){return a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+b})},function(){return f.clear(),e.User.logOut(),a.reject({title:"Your account is missing or something is wrong with authorisation.",message:"Please try logging in again or contacting support"})}):a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+b})}function o(c){var d=b.defer(),g=new e.Query(i),h=a.connectionsCacheKey;return c&&(h=a.connectionsEditCacheKey),g.include("receiver"),g.include("sender"),g.descending("updatedAt"),g.find({success:function(a){var b,g=[];if(c)return g=a.map(function(a){return a.getNgFormModel()}),f.setObject(h,g),d.resolve(g);g=a.map(function(a){return b=a.getNgModel(),b.connection=b.sender.user.objectId===e.User.current().id?b.receiver:b.sender,delete b.receiver,delete b.sender,"pending"===b.requestStatus&&delete b.connection.objectId,b});var i=[],j=[];return g.forEach(function(a){return"pending"===a.requestStatus?i.push(a):j.push(a)}),p&&p.GLOBALS&&p.GLOBALS.events&&p.GLOBALS.events.updateConnectionsBadge&&p.$broadcast(p.GLOBALS.events.updateConnectionsBadge,{pendingCount:i.length}),f.setObject(h,g),d.resolve({acceptedConnections:j,pendingConnections:i})},error:function(a){k.error("Parse Query Error: "+a.message,a.code),d.reject({message:"Something went wrong, please contact system admin."})}}),d.promise}var p;return this.setRootScope=function(a){p=a},this.getProfileByIdForEditing=function(a){return l(a,!0)},this.getProfileByIdForDisplay=function(a){return l(a,!1)},this.getProfiles=function(){return m(arguments)},this.getNeighbouringProfiles=function(){return m(!0,arguments)},this.updateProfile=function(d){var e=b.defer(),g=new c(d,{ngModel:!0,resetOpsQueue:!1}),h=a.profileEditCacheKey;return g.save(null,{success:function(a){f.setObject(h,a.getNgFormModel()),a=f.getObject(h),e.resolve(a)},error:function(a,b){k.error("Parse Save Error: "+b.message,b.code),e.reject({message:"Please try again in a few moments, or contact support."})}}),e.promise},this.followProfile=function(a,f){a=new c(a,{ngModel:!0,resetOpsQueue:!1});var g=b.defer(),i=new d,j=new e.ACL,l=f.get("profile"),m=h.createHash([a.id,l.id].sort().join(""));return i.set("follower",l),i.set("following",a),i.set("profileIdsHash",m),j.setPublicReadAccess(!0),j.setWriteAccess(f,!0),i.setACL(j),i.save().then(function(){g.resolve()},function(a){k.error("Parse Save Error: "+a.message,a.code),g.reject({message:"Please try again in a few moments, or contact support."})}),g.promise},this.destroyProfileRelation=function(a,c){var f,g=b.defer();if(!e.User.current())return g.reject({message:"You need to be logged in to connect with a profile."});switch(c){case"Follow":f=d;break;case"Connection":f=i}var j=[a,e.User.current().get("profile").id],l=new e.Query(f),m=h.createHash(j.sort().join(""));return l.equalTo("profileIdsHash",m),l.find({success:function(a){function b(a){a.destroy({success:function(){},error:function(a,b){k.error("Parse Destroy Error: "+b.message,b.code),g.reject({message:"Please try again in a few moments, or contact support."})}})}if(!a.length)return k.error("No Parse "+c+" object found."),void g.reject({message:"Please contact support"});for(var d=0;d<a.length;d++)b(a[d]),d===a.length-1&&g.resolve()},error:function(a,b){k.error("Parse Query Error: "+b.message,b.code),g.reject({message:"Please try again in a few moments, or contact support."})}}),g.promise},this.checkIfFollowExists=function(a){var c,f=b.defer(),g=new e.Query(d);return c=h.createHash(a.sort().join("")),g.equalTo("profileIdsHash",c),g.find({success:function(a){return a.length?void f.resolve(!0):f.resolve(!1)},error:function(a){k.error("Parse Query Error: "+a.message,a.code),f.reject({message:"Please try again in a few moments, or contact support."})}}),f.promise},this.connectWithProfile=function(a,d){var f=b.defer();if(!e.User.current())return f.reject({message:"You need to be logged in to connect with a Profile"});var g=e.User.current().id,l=e.User.current().get("profile"),m=a.user.objectId,n=new c,o=new i,p=new e.ACL,q=h.createHash([l.id,a.objectId].sort().join(""));return n.id=a.objectId,p.setReadAccess(g,!0),p.setWriteAccess(g,!0),p.setReadAccess(m,!0),p.setWriteAccess(m,!0),o.setACL(p),o.set("sender",l),o.set("receiver",n),o.set("profileIdsHash",q),o.set("requestStatus","accepted"),j.isUserInRole(d)&&o.set("requestStatus","pending"),o.save({success:function(a){f.resolve(a.getNgModel())},error:function(a){k.error("Parse Query Error: "+a.message,a.code),f.reject({message:"Please try again in a few moments, or contact support."})}}),f.promise},this.acceptConnectionRequest=function(a){function c(a){k.error("Parse Error: "+a.message,a.code),d.reject({message:"Please try again in a few moments, or contact support."})}var d=b.defer(),f=new e.Query(i);return e.User.current()&&j.isUserInRole("user")?(f.get(a).then(function(a){a.set("requestStatus","accepted"),a.save().then(function(a){var b=a.getNgModel();d.resolve(b)},c)},c),d.promise):d.reject({message:"You are not permitted to perform this action."})},this.checkIfConnectionExists=function(a){var c=b.defer();if(!e.User.current())return g(function(){c.resolve({noCurrentUser:!0})},0),c.promise;var d=new e.Query(i),f=[a,e.User.current().get("profile").id],j=h.createHash(f.sort().join(""));return d.equalTo("profileIdsHash",j),d.find({success:function(a){return a.length?a[0]&&"pending"===a[0].get("requestStatus")?c.resolve("pending"):a[0]&&"accepted"===a[0].get("requestStatus")?c.resolve("accepted"):(k.info("Parse Error",a),void c.reject({message:"Please try again in a few moments, or contact support."})):c.resolve("none")},error:function(a){k.error("Parse Query Error: "+a.message,a.code),c.reject({message:"Please try again in a few moments, or contact support."})}}),c.promise},this.getConnectionsForDisplay=function(){return o(!1)},this.getConnectionsForEdit=function(){return o(!0)},this}],this}),angular.module("tm.parseProfiles",["angular-md5","tm.parse","tm.localstorage","tm.parseAccounts"]).factory("Profile",["Parse",function(a){return a.Object.extend("Profile")}]).factory("Follow",["Parse",function(a){return a.Object.extend("Follow")}]).factory("Connection",["Parse",function(a){return a.Object.extend("Connection")}]).run(["$rootScope","tmProfiles",function(a,b){b.setRootScope(a)}]).provider("tmProfiles",function(){var a={profileCacheKey:"User/Profile",profileEditCacheKey:"User/Profile/Edit",profilesCacheKey:"User/Profiles",connectionsCacheKey:"User/Connections",connectionsEditCacheKey:"User/Connections/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["$q","Profile","Follow","Parse","tmLocalStorage","$timeout","md5","Connection","tmAccounts","$log",function(b,c,d,e,f,g,h,i,j,k){function l(d,h){var i,j,l,m=b.defer(),o=new e.Query(c),p=a.profileCacheKey;return h&&(p=a.profileEditCacheKey),g(function(){l=f.getObject(p),m.notify(l)},0),o.get(d,{success:function(a){j=a.getNgModel(),h&&(j=a.getNgFormModel()),f.setObject(p,j),i=f.getObject(p),m.resolve(i)},error:function(a,b){return k.error("Parse Query Error: "+b.message,b.code),119===b.code?n(m,"Profile"):void m.reject({message:"Please try again in a few moments, or contact support."})}}),m.promise}function m(d){var h,i=b.defer(),j=new e.Query(c),l=a.profilesCacheKey,m=[];g(function(){h=f.getObject(l,[]),i.notify(h)},0);for(var o=arguments[1]?arguments[1]:[],p=0;p<o.length;p++)j.include(o[p]);return j.find({success:function(a){if(d)for(var b=0;b<a.length;b++)a[b].get("user")?a[b].get("user").id!==e.User.current().id&&m.push(a[b]):k.warn("Profiles are being created without Parse Users, or something is wrong with profile 'user' pointers.");else m=a;f.setObject(l,e.serialiseArrayForDisplay(m)),m=f.getObject(l,[]),i.resolve(m)},error:function(a){return k.error("Parse Error: "+a.message,a.code),119===a.code?n(i,"Profile"):void i.reject({message:"Please try again in a few moments, or contact support."})}}),i.promise}function n(a,b){return b=b?" on a "+b:"",e.User.current()?void j.getUserRoles(e.User.current()).then(function(){return a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+b})},function(){return f.clear(),e.User.logOut(),a.reject({title:"Your account is missing or something is wrong with authorisation.",message:"Please try logging in again or contacting support"})}):a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+b})}function o(c){var d=b.defer(),g=new e.Query(i),h=a.connectionsCacheKey;return c&&(h=a.connectionsEditCacheKey),g.include("receiver"),g.include("sender"),g.descending("updatedAt"),g.find({success:function(a){var b,g=[];if(c)return g=a.map(function(a){return a.getNgFormModel()}),f.setObject(h,g),d.resolve(g);g=a.map(function(a){return b=a.getNgModel(),b.connection=b.sender.user.objectId===e.User.current().id?b.receiver:b.sender,delete b.receiver,delete b.sender,"pending"===b.requestStatus&&delete b.connection.objectId,b});var i=[],j=[];return g.forEach(function(a){return"pending"===a.requestStatus?i.push(a):j.push(a)}),p&&p.GLOBALS&&p.GLOBALS.events&&p.GLOBALS.events.updateConnectionsBadge&&p.$broadcast(p.GLOBALS.events.updateConnectionsBadge,{pendingCount:i.length}),f.setObject(h,g),d.resolve({acceptedConnections:j,pendingConnections:i})},error:function(a){k.error("Parse Query Error: "+a.message,a.code),d.reject({message:"Something went wrong, please contact system admin."})}}),d.promise}var p;return this.setRootScope=function(a){p=a},this.getProfileByIdForEditing=function(a){return l(a,!0)},this.getProfileByIdForDisplay=function(a){return l(a,!1)},this.getProfiles=function(){return m(arguments)},this.getNeighbouringProfiles=function(){return m(!0,arguments)},this.updateProfile=function(d){var e=b.defer(),g=new c(d,{ngModel:!0,resetOpsQueue:!1}),h=a.profileEditCacheKey;return g.save(null,{success:function(a){f.setObject(h,a.getNgFormModel()),a=f.getObject(h),e.resolve(a)},error:function(a,b){k.error("Parse Save Error: "+b.message,b.code),e.reject({message:"Please try again in a few moments, or contact support."})}}),e.promise},this.followProfile=function(a,f){a=new c(a,{ngModel:!0,resetOpsQueue:!1});var g=b.defer(),i=new d,j=new e.ACL,l=f.get("profile"),m=h.createHash([a.id,l.id].sort().join(""));return i.set("follower",l),i.set("following",a),i.set("profileIdsHash",m),j.setPublicReadAccess(!0),j.setWriteAccess(f,!0),i.setACL(j),i.save().then(function(){g.resolve()},function(a){k.error("Parse Save Error: "+a.message,a.code),g.reject({message:"Please try again in a few moments, or contact support."})}),g.promise},this.destroyProfileRelation=function(a,c){var f,g=b.defer();if(!e.User.current())return g.reject({message:"You need to be logged in to connect with a profile."});switch(c){case"Follow":f=d;break;case"Connection":f=i}var j=[a,e.User.current().get("profile").id],l=new e.Query(f),m=h.createHash(j.sort().join(""));return l.equalTo("profileIdsHash",m),l.find({success:function(a){function b(a){a.destroy({success:function(){},error:function(a,b){k.error("Parse Destroy Error: "+b.message,b.code),g.reject({message:"Please try again in a few moments, or contact support."})}})}if(!a.length)return k.error("No Parse "+c+" object found."),void g.reject({message:"Please contact support"});for(var d=0;d<a.length;d++)b(a[d]),d===a.length-1&&g.resolve()},error:function(a,b){k.error("Parse Query Error: "+b.message,b.code),g.reject({message:"Please try again in a few moments, or contact support."})}}),g.promise},this.checkIfFollowExists=function(a){var c,f=b.defer(),g=new e.Query(d);return c=h.createHash(a.sort().join("")),g.equalTo("profileIdsHash",c),g.find({success:function(a){return a.length?void f.resolve(!0):f.resolve(!1)},error:function(a){k.error("Parse Query Error: "+a.message,a.code),f.reject({message:"Please try again in a few moments, or contact support."})}}),f.promise},this.connectWithProfile=function(a,d){var f=b.defer();if(!e.User.current())return f.reject({message:"You need to be logged in to connect with a Profile"});var g=e.User.current().id,l=e.User.current().get("profile"),m=a.user.objectId,n=new c,o=new i,p=new e.ACL,q=h.createHash([l.id,a.objectId].sort().join(""));return n.id=a.objectId,p.setReadAccess(g,!0),p.setWriteAccess(g,!0),p.setReadAccess(m,!0),p.setWriteAccess(m,!0),o.setACL(p),o.set("sender",l),o.set("receiver",n),o.set("profileIdsHash",q),o.set("requestStatus","accepted"),j.isUserInRole(d)&&o.set("requestStatus","pending"),o.save({success:function(a){f.resolve(a.getNgModel())},error:function(a){k.error("Parse Query Error: "+a.message,a.code),f.reject({message:"Please try again in a few moments, or contact support."})}}),f.promise},this.acceptConnectionRequest=function(a){function c(a){k.error("Parse Error: "+a.message,a.code),d.reject({message:"Please try again in a few moments, or contact support."})}var d=b.defer(),f=new e.Query(i);return e.User.current()&&j.isUserInRole("user")?(f.get(a).then(function(a){a.set("requestStatus","accepted"),a.save().then(function(a){var b=a.getNgModel();d.resolve(b)},c)},c),d.promise):d.reject({message:"You are not permitted to perform this action."})},this.checkIfConnectionExists=function(a){var c=b.defer();if(!e.User.current())return g(function(){c.resolve({noCurrentUser:!0})},0),c.promise;var d=new e.Query(i),f=[a,e.User.current().get("profile").id],j=h.createHash(f.sort().join(""));return d.equalTo("profileIdsHash",j),d.find({success:function(a){return a.length?a[0]&&"pending"===a[0].get("requestStatus")?c.resolve("pending"):a[0]&&"accepted"===a[0].get("requestStatus")?c.resolve("accepted"):(k.info("Parse Error",a),void c.reject({message:"Please try again in a few moments, or contact support."})):c.resolve("none")},error:function(a){k.error("Parse Query Error: "+a.message,a.code),c.reject({message:"Please try again in a few moments, or contact support."})}}),c.promise},this.getConnectionsForDisplay=function(){return o(!1)},this.getConnectionsForEdit=function(){return o(!0)},this}],this});