/**
 * themeans-core - 
 * @version v0.1.0 - 2015-04-04
 * @link 
 * @license 
 */
"use strict";angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){return a.Object.extend("MessageThread")}]).factory("Message",["Parse",function(a){return a.Object.extend("Message")}]).run(["$rootScope","tmMessages",function(a,b){b.setRootScope(a)}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit",profilesForbiddenDisplayName:"No Name Available"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5","$log","Profile","tmAccounts","$document",function(b,c,d,e,f,g,h,i,j,k){function l(a){var d=c.defer(),e=new b.Query(f);return e.include("profiles"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),d.reject(a)}}),d.promise}function m(g){var h,j,k=c.defer(),l=new b.Query(f),m=a.messageThreadsCacheKey;return g&&(m=a.messageThreadsEditCacheKey),d(function(){j=e.getObject(m,[]),k.notify(j)},0),l.include("profiles"),l.find().then(function(b){function c(){b.forEach(function(b){var d=b.get("profiles").indexOf(null);d>=0&&(i.warn("User does not have permissions to view sender or recipient profile(s) for MessageThread/"+b.id),b.get("profiles").splice(d,1,{fullName:a.profilesForbiddenDisplayName}),c())})}c(),h=n(b,g),e.setObject(m,h),p(!1).then(function(a){a.length>0&&h.forEach(function(b){a.forEach(function(a){b.objectId===a.get("thread").id&&(b.unreadMessage=!0)})}),h.sort(function(a,b){return a.unreadMessage===b.unreadMessage?0:a.unreadMessage?-1:1}),k.resolve(h)})},function(a){return i.error("Parse Query Error: "+a.message,a.code),119===a.code?q(k,"MessageThread"):void k.reject(a)}),k.promise}function n(a,c){var d,e,f=b.User.current().get("profile"),g=[];return g=a.map(function(a){return e=c?a.getNgFormModel():a.getNgModel(),e.recipients=[],d=e.profiles,d.forEach(function(a){a.objectId!==f.id&&e.recipients.push(a)}),e})}function o(f,g){var h,j,k,m,n=c.defer(),o=a.messagesCacheKey+"/"+f;return g&&(o=a.messagesEditCacheKey+"/"+f),d(function(){m=e.getObject(o),n.notify(m)},0),l(f).then(function(d){h=d.relation("messages"),j=h.query(),j.ascending("createdAt"),j.include("sender"),j.include("recipients"),j.find({success:function(d){var f=[];k=d.map(function(c){return c.get("recipients").forEach(function(a){a.profile.id===b.User.current().get("profile").id&&(a.viewed=!0)}),f.push(c.save()),c.get("sender")||c.set("sender",{fullName:a.profilesForbiddenDisplayName}),g?c.getNgFormModel():c.getNgModel()}),e.setObject(o,k),k=e.getObject(o),c.all(f).then(function(){n.resolve(k)},function(a){i.error("Parse Save Error: "+a.message,a.code),n.resole(k)})},error:function(a){i.error("Parse Query Error: "+a.message,a.code),n.reject(a)}})},function(a){n.reject(a)}),n.promise}function p(a,d){var e,f=c.defer(),h=new b.Query(g);return d&&d.length||(d=[{profile:b.User.current().get("profile"),viewed:!1}]),e={success:function(b){a&&"number"==typeof b&&v&&v.GLOBALS&&v.GLOBALS.events&&v.GLOBALS.events.updateMessageBadge&&v.$broadcast(v.GLOBALS.events.updateMessageBadge,{unreadCount:b}),f.resolve(b)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),f.resolve()}},h.containedIn("recipients",d),a?h.count(e):h.find(e),f.promise}function q(a,c){return c=c?" on a "+c:"",b.User.current()?void k.getUserRoles(b.User.current()).then(function(){return a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+c})},function(){return e.clear(),b.User.logOut(),a.reject({title:"Your account is missing or something is wrong with authorisation.",message:"Please try logging in again or contacting support"})}):a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+c})}function r(a){var d,e=c.defer(),g=new b.Query(f);return d=a.map(function(a){return a.id}),g.equalTo("profileIdsHash",t(d)),g.find({success:function(a){return a.length>1?e.reject({message:"There are duplicate threads. Please contact system admin."}):a.length?void e.resolve(a):e.resolve(!1)},error:function(a){e.reject(a)}}),e.promise}function s(a,d){var e=c.defer(),g=new b.ACL,h=[];a.length!==d.length&&i.error("Error with message thread participants in createThread(): participantProfiles.length is not equal to userIds to length");for(var j=new f({profiles:[]}),k=0;k<a.length;k++)g.setReadAccess(d[k],!0),g.setWriteAccess(d[k],!0),j.get("profiles").push(a[k]),h.push(a[k].id);return j.setACL(g),j.set("profileIdsHash",t(h)),j.save({success:function(a){e.resolve(a)},error:function(a,b){e.reject(b)}}),e.promise}function t(a){return h.createHash(a.sort().join(""))}function u(a,b){function d(a){e.reject(a)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.set("sender",b.get("sender")),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var v;return this.setRootScope=function(a){v=a},this.getThreadsForEditing=function(){return m(!0)},this.getThreadsForDisplay=function(){return m(!1)},this.getMessagesFromThreadForEditing=function(a){return o(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return o(a,!1)},this.updateMessageBadge=function(a){return p(!0,a)},this.getThreadsWithUnreadMessages=function(a){return p(!1,a)},this.respond=function(a,d){function e(a){i.error("Parse Error: "+a.message,a.code),g.reject(a)}var f,g=c.defer();return l(a).then(function(a){d.sender=b.User.current().get("profile"),d.recipients=n([a],!0)[0].recipients,d.recipients=d.recipients.map(function(a){return f={profile:a,viewed:!1}}),u(a,d).then(function(){o(a.id,!1).then(function(a){g.resolve(a)},e)},e)},e),g.promise},this.send=function(a){function d(a){i.error("Parse Error: "+a.message,a.code),g.reject(a)}var e,f,g=c.defer(),h=[],k=[];return a.recipients=a.recipients.map(function(a){return e=new j,e.id=a.objectId,h.push(a.user.objectId),k.push(e),f={profile:e,viewed:!1}}),h.push(b.User.current().id),k.push(a.sender),r(k).then(function(b){b?u(b[0],a).then(function(){g.resolve()},d):s(k,h).then(function(b){u(b,a).then(function(){g.resolve()},d)},d)},d),g.promise},this}],this}),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){return a.Object.extend("MessageThread")}]).factory("Message",["Parse",function(a){return a.Object.extend("Message")}]).run(["$rootScope","tmMessages",function(a,b){b.setRootScope(a)}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit",profilesForbiddenDisplayName:"No Name Available"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5","$log","Profile","tmAccounts","$document",function(b,c,d,e,f,g,h,i,j,k){function l(a){var d=c.defer(),e=new b.Query(f);return e.include("profiles"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),d.reject(a)}}),d.promise}function m(g){var h,j,k=c.defer(),l=new b.Query(f),m=a.messageThreadsCacheKey;return g&&(m=a.messageThreadsEditCacheKey),d(function(){j=e.getObject(m,[]),k.notify(j)},0),l.include("profiles"),l.find().then(function(b){function c(){b.forEach(function(b){var d=b.get("profiles").indexOf(null);d>=0&&(i.warn("User does not have permissions to view sender or recipient profile(s) for MessageThread/"+b.id),b.get("profiles").splice(d,1,{fullName:a.profilesForbiddenDisplayName}),c())})}c(),h=n(b,g),e.setObject(m,h),p(!1).then(function(a){a.length>0&&h.forEach(function(b){a.forEach(function(a){b.objectId===a.get("thread").id&&(b.unreadMessage=!0)})}),h.sort(function(a,b){return a.unreadMessage===b.unreadMessage?0:a.unreadMessage?-1:1}),k.resolve(h)})},function(a){return i.error("Parse Query Error: "+a.message,a.code),119===a.code?q(k,"MessageThread"):void k.reject(a)}),k.promise}function n(a,c){var d,e,f=b.User.current().get("profile"),g=[];return g=a.map(function(a){return e=c?a.getNgFormModel():a.getNgModel(),e.recipients=[],d=e.profiles,d.forEach(function(a){a.objectId!==f.id&&e.recipients.push(a)}),e})}function o(f,g){var h,j,k,m,n=c.defer(),o=a.messagesCacheKey+"/"+f;return g&&(o=a.messagesEditCacheKey+"/"+f),d(function(){m=e.getObject(o),n.notify(m)},0),l(f).then(function(d){h=d.relation("messages"),j=h.query(),j.ascending("createdAt"),j.include("sender"),j.include("recipients"),j.find({success:function(d){var f=[];k=d.map(function(c){return c.get("recipients").forEach(function(a){a.profile.id===b.User.current().get("profile").id&&(a.viewed=!0)}),f.push(c.save()),c.get("sender")||c.set("sender",{fullName:a.profilesForbiddenDisplayName}),g?c.getNgFormModel():c.getNgModel()}),e.setObject(o,k),k=e.getObject(o),c.all(f).then(function(){n.resolve(k)},function(a){i.error("Parse Save Error: "+a.message,a.code),n.resole(k)})},error:function(a){i.error("Parse Query Error: "+a.message,a.code),n.reject(a)}})},function(a){n.reject(a)}),n.promise}function p(a,d){var e,f=c.defer(),h=new b.Query(g);return d&&d.length||(d=[{profile:b.User.current().get("profile"),viewed:!1}]),e={success:function(b){a&&"number"==typeof b&&v&&v.GLOBALS&&v.GLOBALS.events&&v.GLOBALS.events.updateMessageBadge&&v.$broadcast(v.GLOBALS.events.updateMessageBadge,{unreadCount:b}),f.resolve(b)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),f.resolve()}},h.containedIn("recipients",d),a?h.count(e):h.find(e),f.promise}function q(a,c){return c=c?" on a "+c:"",b.User.current()?void k.getUserRoles(b.User.current()).then(function(){return a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+c})},function(){return e.clear(),b.User.logOut(),a.reject({title:"Your account is missing or something is wrong with authorisation.",message:"Please try logging in again or contacting support"})}):a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+c})}function r(a){var d,e=c.defer(),g=new b.Query(f);return d=a.map(function(a){return a.id}),g.equalTo("profileIdsHash",t(d)),g.find({success:function(a){return a.length>1?e.reject({message:"There are duplicate threads. Please contact system admin."}):a.length?void e.resolve(a):e.resolve(!1)},error:function(a){e.reject(a)}}),e.promise}function s(a,d){var e=c.defer(),g=new b.ACL,h=[];a.length!==d.length&&i.error("Error with message thread participants in createThread(): participantProfiles.length is not equal to userIds to length");for(var j=new f({profiles:[]}),k=0;k<a.length;k++)g.setReadAccess(d[k],!0),g.setWriteAccess(d[k],!0),j.get("profiles").push(a[k]),h.push(a[k].id);return j.setACL(g),j.set("profileIdsHash",t(h)),j.save({success:function(a){e.resolve(a)},error:function(a,b){e.reject(b)}}),e.promise}function t(a){return h.createHash(a.sort().join(""))}function u(a,b){function d(a){e.reject(a)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.set("sender",b.get("sender")),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var v;return this.setRootScope=function(a){v=a},this.getThreadsForEditing=function(){return m(!0)},this.getThreadsForDisplay=function(){return m(!1)},this.getMessagesFromThreadForEditing=function(a){return o(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return o(a,!1)},this.updateMessageBadge=function(a){return p(!0,a)},this.getThreadsWithUnreadMessages=function(a){return p(!1,a)},this.respond=function(a,d){function e(a){i.error("Parse Error: "+a.message,a.code),g.reject(a)}var f,g=c.defer();return l(a).then(function(a){d.sender=b.User.current().get("profile"),d.recipients=n([a],!0)[0].recipients,d.recipients=d.recipients.map(function(a){return f={profile:a,viewed:!1}}),u(a,d).then(function(){o(a.id,!1).then(function(a){g.resolve(a)},e)},e)},e),g.promise},this.send=function(a){function d(a){i.error("Parse Error: "+a.message,a.code),g.reject(a)}var e,f,g=c.defer(),h=[],k=[];return a.recipients=a.recipients.map(function(a){return e=new j,e.id=a.objectId,h.push(a.user.objectId),k.push(e),f={profile:e,viewed:!1}}),h.push(b.User.current().id),k.push(a.sender),r(k).then(function(b){b?u(b[0],a).then(function(){g.resolve()},d):s(k,h).then(function(b){u(b,a).then(function(){g.resolve()},d)},d)},d),g.promise},this}],this}),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){return a.Object.extend("MessageThread")}]).factory("Message",["Parse",function(a){return a.Object.extend("Message")}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5","$log","Profile","tmAccounts",function(b,c,d,e,f,g,h,i,j,k){function l(a){var d=c.defer(),e=new b.Query(f);return e.include("profiles"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),d.reject(a)}}),d.promise}function m(g){var h,j,k=c.defer(),l=new b.Query(f),m=a.messageThreadsCacheKey;return g&&(m=a.messageThreadsEditCacheKey),d(function(){j=e.getObject(m,[]),k.notify(j)},0),l.include("profiles"),l.find().then(function(a){function b(){a.forEach(function(a){var c=a.get("profiles").indexOf(null);c>=0&&(i.warn("User does not have permissions to view sender or recipient profile(s) for MessageThread/"+a.id),a.get("profiles").splice(c,1,{fullName:"No Name Available"}),b())})}b(),h=n(a,g),e.setObject(m,h),p(!1).then(function(a){a.length>0&&h.forEach(function(b){a.forEach(function(a){b.objectId===a.get("thread").id&&(b.unreadMessage=!0)})}),h.sort(function(a,b){return a.unreadMessage===b.unreadMessage?0:a.unreadMessage?-1:1}),k.resolve(h)})},function(a){return i.error("Parse Query Error: "+a.message,a.code),119===a.code?q(k,"MessageThread"):void k.reject(a)}),k.promise}function n(a,c){var d,e,f=b.User.current().get("profile"),g=[];return g=a.map(function(a){return e=c?a.getNgFormModel():a.getNgModel(),e.recipients=[],d=e.profiles,d.forEach(function(a){a.objectId!==f.id&&e.recipients.push(a)}),e})}function o(f,g){var h,j,k,m,n=c.defer(),o=a.messagesCacheKey+"/"+f;return g&&(o=a.messagesEditCacheKey+"/"+f),d(function(){m=e.getObject(o),n.notify(m)},0),l(f).then(function(a){h=a.relation("messages"),j=h.query(),j.ascending("createdAt"),j.include("sender"),j.include("recipients"),j.find({success:function(a){var d=[];k=a.map(function(a){return a.get("recipients").forEach(function(a){a.profile.id===b.User.current().get("profile").id&&(a.viewed=!0)}),d.push(a.save()),g?a.getNgFormModel():a.getNgModel()}),e.setObject(o,k),k=e.getObject(o),c.all(d).then(function(){n.resolve(k)},function(a){i.error("Parse Save Error: "+a.message,a.code)})},error:function(a){i.error("Parse Query Error: "+a.message,a.code),n.reject(a)}})},function(a){n.reject(a)}),n.promise}function p(a,d){var e,f=c.defer(),h=new b.Query(g);return d&&d.length||(d=[{profile:b.User.current().get("profile"),viewed:!1}]),e={success:function(a){f.resolve(a)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),f.resolve()}},h.containedIn("recipients",d),a?h.count(e):h.find(e),f.promise}function q(a,c){return c=c?" on a "+c:"",b.User.current()?void k.getUserRoles(b.User.current()).then(function(){return a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+c})},function(){return e.clear(),b.User.logOut(),a.reject({title:"Your account is missing or something is wrong with authorisation.",message:"Please try logging in again or contacting support"})}):a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+c})}function r(a){var d,e=c.defer(),g=new b.Query(f);return d=a.map(function(a){return a.id}),g.equalTo("profileIdsHash",t(d)),g.find({success:function(a){return a.length>1?e.reject({message:"There are duplicate threads. Please contact system admin."}):a.length?void e.resolve(a):e.resolve(!1)},error:function(a){e.reject(a)}}),e.promise}function s(a,d){var e=c.defer(),g=new b.ACL,h=[];a.length!==d.length&&i.error("Error with message thread participants in createThread(): participantProfiles.length is not equal to userIds to length");for(var j=new f({profiles:[]}),k=0;k<a.length;k++)g.setReadAccess(d[k],!0),g.setWriteAccess(d[k],!0),j.get("profiles").push(a[k]),h.push(a[k].id);return j.setACL(g),j.set("profileIdsHash",t(h)),j.save({success:function(a){e.resolve(a)},error:function(a,b){e.reject(b)}}),e.promise}function t(a){return h.createHash(a.sort().join(""))}function u(a,b){function d(a){e.reject(a)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.set("sender",b.get("sender")),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}return this.getThreadsForEditing=function(){return m(!0)},this.getThreadsForDisplay=function(){return m(!1)},this.getMessagesFromThreadForEditing=function(a){return o(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return o(a,!1)},this.updateMessageBadge=function(a){return p(!0,a)},this.getThreadsWithUnreadMessages=function(a){return p(!1,a)},this.setMessagesToRead=function(){},this.respond=function(a,d){function e(a){i.error("Parse Error: "+a.message,a.code),g.reject(a)}var f,g=c.defer();return l(a).then(function(a){d.sender=b.User.current().get("profile"),d.recipients=n([a],!0)[0].recipients,d.recipients=d.recipients.map(function(a){return f={profile:a,viewed:!1}}),u(a,d).then(function(){o(a.id,!1).then(function(a){g.resolve(a)},e)},e)},e),g.promise},this.send=function(a){function d(a){i.error("Parse Error: "+a.message,a.code),g.reject(a)}var e,f,g=c.defer(),h=[],k=[];return a.recipients=a.recipients.map(function(a){return e=new j,e.id=a.objectId,h.push(a.user.objectId),k.push(e),f={profile:e,viewed:!1}}),h.push(b.User.current().id),k.push(a.sender),r(k).then(function(b){b?u(b[0],a).then(function(){g.resolve()},d):s(k,h).then(function(b){u(b,a).then(function(){g.resolve()},d)},d)},d),g.promise},this}],this}),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5","$log","Profile","tmAccounts",function(b,c,d,e,f,g,h,i,j,k){function l(g){var h,j,k=c.defer(),l=new b.Query(f),o=a.messageThreadsCacheKey;return g&&(o=a.messageThreadsEditCacheKey),d(function(){j=e.getObject(o,[]),k.notify(j)},0),l.include("profiles"),l.find({success:function(a){h=n(a,g),e.setObject(o,h),h=e.getObject(o,[]),k.resolve(h)},error:function(a){return i.error("Parse Query Error: "+a.message,a.code),119===a.code?m(k,"MessageThread"):void k.reject(a)}}),k.promise}function m(a,c){return c=c?" on a "+c:"",b.User.current()?void k.getUserRoles(b.User.current()).then(function(){return a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+c})},function(){return e.clear(),b.User.logOut(),a.reject({title:"Your account is missing or something is wrong with authorisation.",message:"Please try logging in again or contacting support"})}):a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+c})}function n(a,c){for(var d,e,f=b.User.current().get("profile"),g=[],h=0;h<a.length;h++){e=c?a[h].getNgFormModel():a[h].getNgModel(),e.recipients=[],d=e.profiles;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function o(b,f){var g,h,j,k,l=c.defer(),m=a.messagesCacheKey+"/"+b;return f&&(m=a.messagesEditCacheKey+"/"+b),d(function(){k=e.getObject(m),l.notify(k)},0),p(b).then(function(a){g=a.relation("messages"),h=g.query(),h.ascending("createdAt"),h.include("sender"),h.include("receivers"),h.find({success:function(a){j=[];for(var b=0;b<a.length;b++)j.push(f?a[b].getNgFormModel():a[b].getNgModel());e.setObject(m,j),j=e.getObject(m),l.resolve(j)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),l.reject(a)}})},function(a){l.reject(a)}),l.promise}function p(a){var d=c.defer(),e=new b.Query(f);return e.include("profiles"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),d.reject(a)}}),d.promise}function q(a){for(var d=c.defer(),e=new b.Query(f),g=[],h=0;h<a.length;h++)g.push(a[h].id);return e.equalTo("profileIdsHash",s(g)),e.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function r(a,d){for(var e=c.defer(),g=new b.ACL,h=[],i=new f({profiles:[]}),j=0;j<a.length;j++)g.setReadAccess(d[j],!0),g.setWriteAccess(d[j],!0),i.get("profiles").push(a[j]),h.push(a[j].id);return i.setACL(g),i.set("profileIdsHash",s(h)),i.save({success:function(a){e.resolve(a)},error:function(a,b){e.reject(b)}}),e.promise}function s(a){return h.createHash(a.sort().join(""))}function t(a,b){function d(a){e.reject(a)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}return this.getThreadsForEditing=function(a){return l(!0,a)},this.getThreadsForDisplay=function(a){return l(!1,a)},this.getMessagesFromThreadForEditing=function(a){return o(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return o(a,!1)},this.respond=function(a,d){function e(a){i.error("Parse Error: "+a.message,a.code),f.reject(a)}var f=c.defer();return p(a).then(function(a){d.sender=b.User.current().get("profile"),d.receivers=n([a],!0)[0].recipients,t(a,d).then(function(){o(a.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function d(a){i.error("Parse Error: "+a.message,a.code),e.reject(a)}for(var e=c.defer(),f=[],g=[],h=0;h<a.receivers.length;h++){var k=new j;k.id=a.receivers[h].objectId,g.push(a.receivers[h].user.objectId),f.push(k)}a.receivers=f,g.push(b.User.current().id);var l=a.receivers.concat([a.sender]);return q(l).then(function(b){b?t(b[0],a).then(function(){e.resolve()},d):r(l,g).then(function(b){t(b,a).then(function(){e.resolve()},d)},d)},d),e.promise},this}],this}),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5","$log","Profile","tmAccounts",function(b,c,d,e,f,g,h,i,j,k){function l(g){var h,j,k=c.defer(),l=new b.Query(f),o=a.messageThreadsCacheKey;return g&&(o=a.messageThreadsEditCacheKey),d(function(){j=e.getObject(o,[]),k.notify(j)},0),l.include("profiles"),l.find({success:function(a){h=n(a,g),e.setObject(o,h),h=e.getObject(o,[]),k.resolve(h)},error:function(a){return i.error("Parse Query Error: "+a.message,a.code),119===a.code?m(k,"MessageThread"):void k.reject(a)}}),k.promise}function m(a,c){return c=c?" on a "+c:"",b.User.current()?void k.getUserRoles(b.User.current()).then(function(){return a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+c})},function(){return e.clear(),b.User.logOut(),a.reject({title:"Your account is missing or something is wrong with authorisation.",message:"Please try logging in again or contacting support"})}):a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+c})}function n(a,c){for(var d,e,f=b.User.current().get("profile"),g=[],h=0;h<a.length;h++){e=c?a[h].getNgFormModel():a[h].getNgModel(),e.recipients=[],d=e.profiles;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function o(b,f){var g,h,j,k,l=c.defer(),m=a.messagesCacheKey+"/"+b;return f&&(m=a.messagesEditCacheKey+"/"+b),d(function(){k=e.getObject(m),l.notify(k)},0),p(b).then(function(a){g=a.relation("messages"),h=g.query(),h.ascending("createdAt"),h.include("sender"),h.include("receivers"),h.find({success:function(a){j=[];for(var b=0;b<a.length;b++)j.push(f?a[b].getNgFormModel():a[b].getNgModel());e.setObject(m,j),j=e.getObject(m),l.resolve(j)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),l.reject(a)}})},function(a){l.reject(a)}),l.promise}function p(a){var d=c.defer(),e=new b.Query(f);return e.include("profiles"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),d.reject(a)}}),d.promise}function q(a){for(var d=c.defer(),e=new b.Query(f),g=[],h=0;h<a.length;h++)g.push(a[h].id);return e.equalTo("profileIdsHash",s(g)),e.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function r(a,d){for(var e=c.defer(),g=new b.ACL,h=[],i=new f({profiles:[]}),j=0;j<a.length;j++)g.setReadAccess(d[j],!0),g.setWriteAccess(d[j],!0),i.get("profiles").push(a[j]),h.push(a[j].id);return i.setACL(g),i.set("profileIdsHash",s(h)),i.save({success:function(a){e.resolve(a)},error:function(a,b){e.reject(b)}}),e.promise}function s(a){return h.createHash(a.sort().join(""))}function t(a,b){function d(a){e.reject(a)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}return this.getThreadsForEditing=function(a){return l(!0,a)},this.getThreadsForDisplay=function(a){return l(!1,a)},this.getMessagesFromThreadForEditing=function(a){return o(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return o(a,!1)},this.respond=function(a,d){function e(a){i.error("Parse Error: "+a.message,a.code),f.reject(a)}var f=c.defer();return p(a).then(function(a){d.sender=b.User.current().get("profile"),d.receivers=n([a],!0)[0].recipients,t(a,d).then(function(){o(a.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function d(a){i.error("Parse Error: "+a.message,a.code),e.reject(a)}for(var e=c.defer(),f=[],g=[],h=0;h<a.receivers.length;h++){var k=new j;k.id=a.receivers[h].objectId,g.push(a.receivers[h].user.objectId),f.push(k)}a.receivers=f,g.push(b.User.current().id);var l=a.receivers.concat([a.sender]);return q(l).then(function(b){b?t(b[0],a).then(function(){e.resolve()},d):r(l,g).then(function(b){t(b,a).then(function(){e.resolve()},d)},d)},d),e.promise},this}],this}),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5","$log","Profile","tmAccounts",function(b,c,d,e,f,g,h,i,j,k){function l(g){var h,j,k=c.defer(),l=new b.Query(f),o=a.messageThreadsCacheKey;return g&&(o=a.messageThreadsEditCacheKey),d(function(){j=e.getObject(o,[]),k.notify(j)},0),l.include("profiles"),l.find({success:function(a){h=n(a,g),e.setObject(o,h),h=e.getObject(o,[]),k.resolve(h)},error:function(a){return i.error("Parse Query Error: "+a.message,a.code),119===a.code?m(k,"MessageThread"):void k.reject(a)}}),k.promise}function m(a,c){return c=c?" on a "+c:"",b.User.current()?void k.getUserRoles(b.User.current()).then(function(){return a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+c})},function(){return e.clear(),b.User.logOut(),a.reject({title:"Your account is missing or something is wrong with authorisation.",message:"Please try logging in again or contacting support"})}):a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+c})}function n(a,c){for(var d,e,f=b.User.current().get("profile"),g=[],h=0;h<a.length;h++){e=c?a[h].getNgFormModel():a[h].getNgModel(),e.recipients=[],d=e.profiles;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function o(b,f){var g,h,j,k,l=c.defer(),m=a.messagesCacheKey+"/"+b;return f&&(m=a.messagesEditCacheKey+"/"+b),d(function(){k=e.getObject(m),l.notify(k)},0),p(b).then(function(a){g=a.relation("messages"),h=g.query(),h.ascending("createdAt"),h.include("sender"),h.include("receivers"),h.find({success:function(a){j=[];for(var b=0;b<a.length;b++)j.push(f?a[b].getNgFormModel():a[b].getNgModel());e.setObject(m,j),j=e.getObject(m),l.resolve(j)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),l.reject(a)}})},function(a){l.reject(a)}),l.promise}function p(a){var d=c.defer(),e=new b.Query(f);return e.include("profiles"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),d.reject(a)}}),d.promise}function q(a){for(var d=c.defer(),e=new b.Query(f),g=[],h=0;h<a.length;h++)g.push(a[h].id);return e.equalTo("profileIdsHash",s(g)),e.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function r(a,d){for(var e=c.defer(),g=new b.ACL,h=[],i=new f({profiles:[]}),j=0;j<a.length;j++)g.setReadAccess(d[j],!0),g.setWriteAccess(d[j],!0),i.get("profiles").push(a[j]),h.push(a[j].id);return i.setACL(g),i.set("profileIdsHash",s(h)),i.save({success:function(a){e.resolve(a)},error:function(a,b){e.reject(b)}}),e.promise}function s(a){return h.createHash(a.sort().join(""))}function t(a,b){function d(a){e.reject(a)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}return this.getThreadsForEditing=function(a){return l(!0,a)},this.getThreadsForDisplay=function(a){return l(!1,a)},this.getMessagesFromThreadForEditing=function(a){return o(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return o(a,!1)
},this.respond=function(a,d){function e(a){i.error("Parse Error: "+a.message,a.code),f.reject(a)}var f=c.defer();return p(a).then(function(a){d.sender=b.User.current().get("profile"),d.receivers=n([a],!0)[0].recipients,t(a,d).then(function(){o(a.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function d(a){i.error("Parse Error: "+a.message,a.code),e.reject(a)}for(var e=c.defer(),f=[],g=[],h=0;h<a.receivers.length;h++){var k=new j;k.id=a.receivers[h].objectId,g.push(a.receivers[h].user.objectId),f.push(k)}a.receivers=f,g.push(b.User.current().id);var l=a.receivers.concat([a.sender]);return q(l).then(function(b){b?t(b[0],a).then(function(){e.resolve()},d):r(l,g).then(function(b){t(b,a).then(function(){e.resolve()},d)},d)},d),e.promise},this}],this}),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5","$log","Profile","tmAccounts",function(b,c,d,e,f,g,h,i,j,k){function l(g){var h,j,k=c.defer(),l=new b.Query(f),o=a.messageThreadsCacheKey;return g&&(o=a.messageThreadsEditCacheKey),d(function(){j=e.getObject(o,[]),k.notify(j)},0),l.include("profiles"),l.find({success:function(a){h=n(a,g),e.setObject(o,h),h=e.getObject(o,[]),k.resolve(h)},error:function(a){return i.error("Parse Query Error: "+a.message,a.code),119===a.code?m(k):void k.reject(a)}}),k.promise}function m(a){k.getUserRolesWithErrorHandling(b.User.current(),!0).then(function(){},function(){return a.reject({title:"Your account is missing or something is wrong with authorisation.",message:"Please try logging in again or contacting support"})})}function n(a,c){for(var d,e,f=b.User.current().get("profile"),g=[],h=0;h<a.length;h++){e=c?a[h].getNgFormModel():a[h].getNgModel(),e.recipients=[],d=e.profiles;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function o(b,f){var g,h,j,k,l=c.defer(),m=a.messagesCacheKey+"/"+b;return f&&(m=a.messagesEditCacheKey+"/"+b),d(function(){k=e.getObject(m),l.notify(k)},0),p(b).then(function(a){g=a.relation("messages"),h=g.query(),h.ascending("createdAt"),h.include("sender"),h.include("receivers"),h.find({success:function(a){j=[];for(var b=0;b<a.length;b++)j.push(f?a[b].getNgFormModel():a[b].getNgModel());e.setObject(m,j),j=e.getObject(m),l.resolve(j)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),l.reject(a)}})},function(a){l.reject(a)}),l.promise}function p(a){var d=c.defer(),e=new b.Query(f);return e.include("profiles"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),d.reject(a)}}),d.promise}function q(a){for(var d=c.defer(),e=new b.Query(f),g=[],h=0;h<a.length;h++)g.push(a[h].id);return e.equalTo("profileIdsHash",s(g)),e.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function r(a,d){for(var e=c.defer(),g=new b.ACL,h=[],i=new f({profiles:[]}),j=0;j<a.length;j++)g.setReadAccess(d[j],!0),g.setWriteAccess(d[j],!0),i.get("profiles").push(a[j]),h.push(a[j].id);return i.setACL(g),i.set("profileIdsHash",s(h)),i.save({success:function(a){e.resolve(a)},error:function(a,b){e.reject(b)}}),e.promise}function s(a){return h.createHash(a.sort().join(""))}function t(a,b){function d(a){e.reject(a)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}return this.getThreadsForEditing=function(a){return l(!0,a)},this.getThreadsForDisplay=function(a){return l(!1,a)},this.getMessagesFromThreadForEditing=function(a){return o(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return o(a,!1)},this.respond=function(a,d){function e(a){i.error("Parse Error: "+a.message,a.code),f.reject(a)}var f=c.defer();return p(a).then(function(a){d.sender=b.User.current().get("profile"),d.receivers=n([a],!0)[0].recipients,t(a,d).then(function(){o(a.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function d(a){i.error("Parse Error: "+a.message,a.code),e.reject(a)}for(var e=c.defer(),f=[],g=[],h=0;h<a.receivers.length;h++){var k=new j;k.id=a.receivers[h].objectId,g.push(a.receivers[h].user.objectId),f.push(k)}a.receivers=f,g.push(b.User.current().id);var l=a.receivers.concat([a.sender]);return q(l).then(function(b){b?t(b[0],a).then(function(){e.resolve()},d):r(l,g).then(function(b){t(b,a).then(function(){e.resolve()},d)},d)},d),e.promise},this}],this}),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5","$log","Profile",function(b,c,d,e,f,g,h,i,j){function k(g){var h,j,k=c.defer(),m=new b.Query(f),n=a.messageThreadsCacheKey;return g&&(n=a.messageThreadsEditCacheKey),d(function(){j=e.getObject(n,[]),k.notify(j)},0),m.include("profiles"),m.find({success:function(a){h=l(a,g),e.setObject(n,h),h=e.getObject(n,[]),k.resolve(h)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),k.reject(a)}}),k.promise}function l(a,c){for(var d,e,f=b.User.current().get("profile"),g=[],h=0;h<a.length;h++){e=c?a[h].getNgFormModel():a[h].getNgModel(),e.recipients=[],d=e.profiles;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function m(b,f){var g,h,j,k,l=c.defer(),m=a.messagesCacheKey+"/"+b;return f&&(m=a.messagesEditCacheKey+"/"+b),d(function(){k=e.getObject(m),l.notify(k)},0),n(b).then(function(a){g=a.relation("messages"),h=g.query(),h.ascending("createdAt"),h.include("sender"),h.include("receivers"),h.find({success:function(a){j=[];for(var b=0;b<a.length;b++)j.push(f?a[b].getNgFormModel():a[b].getNgModel());e.setObject(m,j),j=e.getObject(m),l.resolve(j)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),l.reject(a)}})},function(a){l.reject(a)}),l.promise}function n(a){var d=c.defer(),e=new b.Query(f);return e.include("profiles"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),d.reject(a)}}),d.promise}function o(a){for(var d=c.defer(),e=new b.Query(f),g=[],h=0;h<a.length;h++)g.push(a[h].id);return e.equalTo("profileIdsHash",q(g)),e.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function p(a,d){for(var e=c.defer(),g=new b.ACL,h=[],i=new f({profiles:[]}),j=0;j<a.length;j++)g.setReadAccess(d[j],!0),g.setWriteAccess(d[j],!0),i.get("profiles").push(a[j]),h.push(a[j].id);return i.setACL(g),i.set("profileIdsHash",q(h)),i.save({success:function(a){e.resolve(a)},error:function(a,b){e.reject(b)}}),e.promise}function q(a){return h.createHash(a.sort().join(""))}function r(a,b){function d(a){e.reject(a)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}return this.getThreadsForEditing=function(a){return k(!0,a)},this.getThreadsForDisplay=function(a){return k(!1,a)},this.getMessagesFromThreadForEditing=function(a){return m(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return m(a,!1)},this.respond=function(a,d){function e(a){i.error("Parse Error: "+a.message,a.code),f.reject(a)}var f=c.defer();return n(a).then(function(a){d.sender=b.User.current().get("profile"),d.receivers=l([a],!0)[0].recipients,r(a,d).then(function(){m(a.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function d(a){i.error("Parse Error: "+a.message,a.code),e.reject(a)}for(var e=c.defer(),f=[],g=[],h=0;h<a.receivers.length;h++){var k=new j;k.id=a.receivers[h].objectId,g.push(a.receivers[h].user.objectId),f.push(k)}a.receivers=f,g.push(b.User.current().id);var l=a.receivers.concat([a.sender]);return o(l).then(function(b){b?r(b[0],a).then(function(){e.resolve()},d):p(l,g).then(function(b){r(b,a).then(function(){e.resolve()},d)},d)},d),e.promise},this}],this}),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5","$log",function(b,c,d,e,f,g,h,i){function j(g){var h,j,l=c.defer(),m=new b.Query(f),n=a.messageThreadsCacheKey;return g&&(n=a.messageThreadsEditCacheKey),d(function(){j=e.getObject(n,[]),l.notify(j)},0),m.include("users"),m.include("users.profile"),m.find({success:function(a){h=k(a,g),e.setObject(n,h),h=e.getObject(n,[]),l.resolve(h)},error:function(a){i.error("Parse Query Error: "+a.code+" "+a.message),l.reject(a)}}),l.promise}function k(a,c){for(var d,e,f=b.User.current(),g=[],h=0;h<a.length;h++){e=c?a[h].getNgFormModel():a[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function l(b,f){var g,h,j,k,l=c.defer(),n=a.messagesCacheKey+"/"+b;return f&&(n=a.messagesEditCacheKey+"/"+b),d(function(){k=e.getObject(n),l.notify(k)},0),m(b).then(function(a){g=a.relation("messages"),h=g.query(),h.ascending("createdAt"),h.include("sender"),h.include("sender.profile"),h.include("receivers"),h.find({success:function(a){j=[];for(var b=0;b<a.length;b++)j.push(f?a[b].getNgFormModel():a[b].getNgModel());e.setObject(n,j),j=e.getObject(n),l.resolve(j)},error:function(a){i.error("Parse Query Error: "+a.code+" "+a.message),l.reject(a)}})},function(a){l.reject(a)}),l.promise}function m(a){var d=c.defer(),e=new b.Query(f);return e.include("users"),e.include("users.profile"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){i.error("Parse Query Error: "+a.code+" "+a.message),d.reject(a)}}),d.promise}function n(a){for(var d=c.defer(),e=new b.Query(f),g=[],h=0;h<a.length;h++)g.push(a[h].id);return e.equalTo("userIdsHash",p(g)),e.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function o(a){for(var d=c.defer(),e=new b.ACL,g=[],h=new f({users:[]}),i=0;i<a.length;i++)e.setReadAccess(a[i].id,!0),e.setWriteAccess(a[i].id,!0),h.get("users").push(a[i]),g.push(a[i].id);return h.setACL(e),h.set("userIdsHash",p(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function p(a){return h.createHash(a.sort().join(""))}function q(a,b){function d(a){e.reject(a)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}return this.getThreadsForEditing=function(a){return j(!0,a)},this.getThreadsForDisplay=function(a){return j(!1,a)},this.getMessagesFromThreadForEditing=function(a){return l(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return l(a,!1)},this.respond=function(a,d){function e(a){i.error("Parse Error: "+a.code+" "+a.message),f.reject(a)}var f=c.defer();return m(a).then(function(a){d.sender=b.User.current(),d.receivers=k([a],!0)[0].recipients,q(a,d).then(function(){l(a.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function b(a){i.error("Parse Error: "+a.code+" "+a.message),d.reject(a)}var d=c.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),n(e).then(function(c){c?q(c[0],a).then(function(){d.resolve()},b):o(e).then(function(c){q(c,a).then(function(){d.resolve()},b)},b)},b),d.promise},this}],this}),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5","$log",function(b,c,d,e,f,g,h,i){function j(g){var h,j,l=c.defer(),m=new b.Query(f),n=a.messageThreadsCacheKey;return g&&(n=a.messageThreadsEditCacheKey),d(function(){j=e.getObject(n,[]),l.notify(j)},0),m.include("users"),m.include("users.profile"),m.find({success:function(a){h=k(a,g),e.setObject(n,h),h=e.getObject(n,[]),l.resolve(h)},error:function(a){i.error("Parse Query Error: "+a.code+" "+a.message),l.reject(a)}}),l.promise}function k(a,c){for(var d,e,f=b.User.current(),g=[],h=0;h<a.length;h++){e=c?a[h].getNgFormModel():a[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function l(b,f){var g,h,j,k,l=c.defer(),n=a.messagesCacheKey+"/"+b;return f&&(n=a.messagesEditCacheKey+"/"+b),d(function(){k=e.getObject(n),l.notify(k)},0),m(b).then(function(a){g=a.relation("messages"),h=g.query(),h.ascending("createdAt"),h.include("sender"),h.include("sender.profile"),h.include("receivers"),h.find({success:function(a){j=[];for(var b=0;b<a.length;b++)j.push(f?a[b].getNgFormModel():a[b].getNgModel());e.setObject(n,j),j=e.getObject(n),l.resolve(j)},error:function(a){i.error("Parse Query Error: "+a.code+" "+a.message),l.reject(a)}})},function(a){l.reject(a)}),l.promise}function m(a){var d=c.defer(),e=new b.Query(f);return e.include("users"),e.include("users.profile"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){i.error("Parse Query Error: "+a.code+" "+a.message),d.reject(a)}}),d.promise}function n(a){for(var d=c.defer(),e=new b.Query(f),g=[],h=0;h<a.length;h++)g.push(a[h].id);return e.equalTo("userIdsHash",p(g)),e.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function o(a){for(var d=c.defer(),e=new b.ACL,g=[],h=new f({users:[]}),i=0;i<a.length;i++)e.setReadAccess(a[i].id,!0),e.setWriteAccess(a[i].id,!0),h.get("users").push(a[i]),g.push(a[i].id);return h.setACL(e),h.set("userIdsHash",p(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function p(a){return h.createHash(a.sort().join(""))}function q(a,b){function d(a){e.reject(a)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}return this.getThreadsForEditing=function(a){return j(!0,a)},this.getThreadsForDisplay=function(a){return j(!1,a)},this.getMessagesFromThreadForEditing=function(a){return l(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return l(a,!1)},this.respond=function(a,d){function e(a){i.error("Parse Error: "+a.code+" "+a.message),f.reject(a)}var f=c.defer();return m(a).then(function(a){d.sender=b.User.current(),d.receivers=k([a],!0)[0].recipients,q(a,d).then(function(){l(a.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function b(a){i.error("Parse Error: "+a.code+" "+a.message),d.reject(a)}var d=c.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),n(e).then(function(c){c?q(c[0],a).then(function(){d.resolve()},b):o(e).then(function(c){q(c,a).then(function(){d.resolve()},b)},b)},b),d.promise},this}],this}),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5","$log",function(b,c,d,e,f,g,h,i){function j(g){var h,j,l=c.defer(),m=new b.Query(f),n=a.messageThreadsCacheKey;return g&&(n=a.messageThreadsEditCacheKey),d(function(){j=e.getObject(n,[]),l.notify(j)},0),m.include("users"),m.include("users.profile"),m.find({success:function(a){h=k(a,g),e.setObject(n,h),h=e.getObject(n,[]),l.resolve(h)},error:function(a){i.error("Parse Query Error: "+a.code+" "+a.message),l.reject(a)}}),l.promise}function k(a,c){for(var d,e,f=b.User.current(),g=[],h=0;h<a.length;h++){e=c?a[h].getNgFormModel():a[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function l(b,f){var g,h,j,k,l=c.defer(),n=a.messagesCacheKey+"/"+b;return f&&(n=a.messagesEditCacheKey+"/"+b),d(function(){k=e.getObject(n),l.notify(k)},0),m(b).then(function(a){g=a.relation("messages"),h=g.query(),h.ascending("createdAt"),h.include("sender"),h.include("sender.profile"),h.include("receivers"),h.find({success:function(a){j=[];for(var b=0;b<a.length;b++)j.push(f?a[b].getNgFormModel():a[b].getNgModel());e.setObject(n,j),j=e.getObject(n),l.resolve(j)},error:function(a){i.error("Parse Query Error: "+a.code+" "+a.message),l.reject(a)}})},function(a){l.reject(a)}),l.promise}function m(a){var d=c.defer(),e=new b.Query(f);return e.include("users"),e.include("users.profile"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){i.error("Parse Query Error: "+a.code+" "+a.message),d.reject(a)}}),d.promise}function n(a){for(var d=c.defer(),e=new b.Query(f),g=[],h=0;h<a.length;h++)g.push(a[h].id);return e.equalTo("userIdsHash",p(g)),e.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function o(a){for(var d=c.defer(),e=new b.ACL,g=[],h=new f({users:[]}),i=0;i<a.length;i++)e.setReadAccess(a[i].id,!0),e.setWriteAccess(a[i].id,!0),h.get("users").push(a[i]),g.push(a[i].id);return h.setACL(e),h.set("userIdsHash",p(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function p(a){return h.createHash(a.sort().join(""))}function q(a,b){function d(a){e.reject(a)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}return this.getThreadsForEditing=function(a){return j(!0,a)},this.getThreadsForDisplay=function(a){return j(!1,a)},this.getMessagesFromThreadForEditing=function(a){return l(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return l(a,!1)},this.respond=function(a,d){function e(a){i.error("Parse Error: "+a.code+" "+a.message),f.reject(a)}var f=c.defer();return m(a).then(function(a){d.sender=b.User.current(),d.receivers=k([a],!0)[0].recipients,q(a,d).then(function(){l(a.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function b(a){i.error("Parse Error: "+a.code+" "+a.message),d.reject(a)}var d=c.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),n(e).then(function(c){c?q(c[0],a).then(function(){d.resolve()},b):o(e).then(function(c){q(c,a).then(function(){d.resolve()},b)},b)},b),d.promise},this}],this}),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5","$log",function(b,c,d,e,f,g,h,i){function j(g){var h,j,l=c.defer(),m=new b.Query(f),n=a.messageThreadsCacheKey;return g&&(n=a.messageThreadsEditCacheKey),d(function(){j=e.getObject(n,[]),l.notify(j)},0),m.include("users"),m.include("users.profile"),m.find({success:function(a){h=k(a,g),e.setObject(n,h),h=e.getObject(n,[]),l.resolve(h)},error:function(a){i.error("Parse Query Error: "+a.code+" "+a.message),l.reject(a)}}),l.promise}function k(a,c){for(var d,e,f=b.User.current(),g=[],h=0;h<a.length;h++){e=c?a[h].getNgFormModel():a[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function l(b,f){var g,h,j,k,l=c.defer(),n=a.messagesCacheKey+"/"+b;return f&&(n=a.messagesEditCacheKey+"/"+b),d(function(){k=e.getObject(n),l.notify(k)},0),m(b).then(function(a){g=a.relation("messages"),h=g.query(),h.ascending("createdAt"),h.include("sender"),h.include("sender.profile"),h.include("receivers"),h.find({success:function(a){j=[];for(var b=0;b<a.length;b++)j.push(f?a[b].getNgFormModel():a[b].getNgModel());e.setObject(n,j),j=e.getObject(n),l.resolve(j)},error:function(a){i.error("Parse Query Error: "+a.code+" "+a.message),l.reject(a)}})},function(a){l.reject(a)}),l.promise}function m(a){var d=c.defer(),e=new b.Query(f);return e.include("users"),e.include("users.profile"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){i.error("Parse Query Error: "+a.code+" "+a.message),d.reject(a)}}),d.promise}function n(a){for(var d=c.defer(),e=new b.Query(f),g=[],h=0;h<a.length;h++)g.push(a[h].id);return e.equalTo("userIdsHash",p(g)),e.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function o(a){for(var d=c.defer(),e=new b.ACL,g=[],h=new f({users:[]}),i=0;i<a.length;i++)e.setReadAccess(a[i].id,!0),e.setWriteAccess(a[i].id,!0),h.get("users").push(a[i]),g.push(a[i].id);return h.setACL(e),h.set("userIdsHash",p(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function p(a){return h.createHash(a.sort().join(""))}function q(a,b){function d(a){e.reject(a)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}return this.getThreadsForEditing=function(a){return j(!0,a)},this.getThreadsForDisplay=function(a){return j(!1,a)},this.getMessagesFromThreadForEditing=function(a){return l(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return l(a,!1)},this.respond=function(a,d){function e(a){i.error("Parse Error: "+a.code+" "+a.message),f.reject(a)}var f=c.defer();return m(a).then(function(a){d.sender=b.User.current(),d.receivers=k([a],!0)[0].recipients,q(a,d).then(function(){l(a.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function b(a){i.error("Parse Error: "+a.code+" "+a.message),d.reject(a)}var d=c.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),n(e).then(function(c){c?q(c[0],a).then(function(){d.resolve()},b):o(e).then(function(c){q(c,a).then(function(){d.resolve()},b)},b)},b),d.promise},this}],this}),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5","$log",function(b,c,d,e,f,g,h,i){function j(g){var h,j,l=c.defer(),m=new b.Query(f),n=a.messageThreadsCacheKey;return g&&(n=a.messageThreadsEditCacheKey),d(function(){j=e.getObject(n,[]),l.notify(j)},0),m.include("users"),m.include("users.profile"),m.find({success:function(a){h=k(a,g),e.setObject(n,h),h=e.getObject(n,[]),l.resolve(h)},error:function(a){i.error("Parse Query Error: "+a.code+" "+a.message),l.reject(a)}}),l.promise}function k(a,c){for(var d,e,f=b.User.current(),g=[],h=0;h<a.length;h++){e=c?a[h].getNgFormModel():a[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function l(b,f){var g,h,j,k,l=c.defer(),n=a.messagesCacheKey+"/"+b;return f&&(n=a.messagesEditCacheKey+"/"+b),d(function(){k=e.getObject(n),l.notify(k)},0),m(b).then(function(a){g=a.relation("messages"),h=g.query(),h.ascending("createdAt"),h.include("sender"),h.include("sender.profile"),h.include("receivers"),h.find({success:function(a){j=[];for(var b=0;b<a.length;b++)j.push(f?a[b].getNgFormModel():a[b].getNgModel());e.setObject(n,j),j=e.getObject(n),l.resolve(j)},error:function(a){i.error("Parse Query Error: "+a.code+" "+a.message),l.reject(a)}})},function(a){l.reject(a)}),l.promise}function m(a){var d=c.defer(),e=new b.Query(f);return e.include("users"),e.include("users.profile"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){i.error("Parse Query Error: "+a.code+" "+a.message),d.reject(a)}}),d.promise}function n(a){for(var d=c.defer(),e=new b.Query(f),g=[],h=0;h<a.length;h++)g.push(a[h].id);return e.equalTo("userIdsHash",p(g)),e.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function o(a){for(var d=c.defer(),e=new b.ACL,g=[],h=new f({users:[]}),i=0;i<a.length;i++)e.setReadAccess(a[i].id,!0),e.setWriteAccess(a[i].id,!0),h.get("users").push(a[i]),g.push(a[i].id);return h.setACL(e),h.set("userIdsHash",p(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function p(a){return h.createHash(a.sort().join(""))}function q(a,b){function d(a){e.reject(a)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}return this.getThreadsForEditing=function(a){return j(!0,a)},this.getThreadsForDisplay=function(a){return j(!1,a)},this.getMessagesFromThreadForEditing=function(a){return l(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return l(a,!1)},this.respond=function(a,d){function e(a){i.error("Parse Error: "+a.code+" "+a.message),f.reject(a)}var f=c.defer();return m(a).then(function(a){d.sender=b.User.current(),d.receivers=k([a],!0)[0].recipients,q(a,d).then(function(){l(a.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function b(a){i.error("Parse Error: "+a.code+" "+a.message),d.reject(a)}var d=c.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),n(e).then(function(c){c?q(c[0],a).then(function(){d.resolve()},b):o(e).then(function(c){q(c,a).then(function(){d.resolve()},b)},b)},b),d.promise},this}],this}),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5","$log",function(b,c,d,e,f,g,h,i){function j(g){var h,j,l=c.defer(),m=new b.Query(f),n=a.messageThreadsCacheKey;return g&&(n=a.messageThreadsEditCacheKey),d(function(){j=e.getObject(n,[]),l.notify(j)},0),m.include("users"),m.include("users.profile"),m.find({success:function(a){h=k(a,g),e.setObject(n,h),h=e.getObject(n,[]),l.resolve(h)},error:function(a){i.error("Parse Query Error: "+a.code+" "+a.message),l.reject(a)}}),l.promise}function k(a,c){for(var d,e,f=b.User.current(),g=[],h=0;h<a.length;h++){e=c?a[h].getNgFormModel():a[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function l(b,f){var g,h,j,k,l=c.defer(),n=a.messagesCacheKey+"/"+b;return f&&(n=a.messagesEditCacheKey+"/"+b),d(function(){k=e.getObject(n),l.notify(k)},0),m(b).then(function(a){g=a.relation("messages"),h=g.query(),h.ascending("createdAt"),h.include("sender"),h.include("sender.profile"),h.include("receivers"),h.find({success:function(a){j=[];for(var b=0;b<a.length;b++)j.push(f?a[b].getNgFormModel():a[b].getNgModel());e.setObject(n,j),j=e.getObject(n),l.resolve(j)},error:function(a){i.error("Parse Query Error: "+a.code+" "+a.message),l.reject(a)}})},function(a){l.reject(a)}),l.promise}function m(a){var d=c.defer(),e=new b.Query(f);return e.include("users"),e.include("users.profile"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){i.error("Parse Query Error: "+a.code+" "+a.message),d.reject(a)}}),d.promise}function n(a){for(var d=c.defer(),e=new b.Query(f),g=[],h=0;h<a.length;h++)g.push(a[h].id);return e.equalTo("userIdsHash",p(g)),e.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)
},error:function(a){d.reject(a)}}),d.promise}function o(a){for(var d=c.defer(),e=new b.ACL,g=[],h=new f({users:[]}),i=0;i<a.length;i++)e.setReadAccess(a[i].id,!0),e.setWriteAccess(a[i].id,!0),h.get("users").push(a[i]),g.push(a[i].id);return h.setACL(e),h.set("userIdsHash",p(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function p(a){return h.createHash(a.sort().join(""))}function q(a,b){function d(a){e.reject(a)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}return this.getThreadsForEditing=function(a){return j(!0,a)},this.getThreadsForDisplay=function(a){return j(!1,a)},this.getMessagesFromThreadForEditing=function(a){return l(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return l(a,!1)},this.respond=function(a,d){function e(a){i.error("Parse Error: "+a.code+" "+a.message),f.reject(a)}var f=c.defer();return m(a).then(function(a){d.sender=b.User.current(),d.receivers=k([a],!0)[0].recipients,q(a,d).then(function(){l(a.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function b(a){i.error("Parse Error: "+a.code+" "+a.message),d.reject(a)}var d=c.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),n(e).then(function(c){c?q(c[0],a).then(function(){d.resolve()},b):o(e).then(function(c){q(c,a).then(function(){d.resolve()},b)},b)},b),d.promise},this}],this}),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5","$log",function(b,c,d,e,f,g,h,i){function j(g){var h,j,l=c.defer(),m=new b.Query(f),n=a.messageThreadsCacheKey;return g&&(n=a.messageThreadsEditCacheKey),d(function(){j=e.getObject(n,[]),l.notify(j)},0),m.include("users"),m.include("users.profile"),m.find({success:function(a){h=k(a,g),e.setObject(n,h),h=e.getObject(n,[]),l.resolve(h)},error:function(a){i.error("Parse Query Error: "+a.code+" "+a.message),l.reject(a)}}),l.promise}function k(a,c){for(var d,e,f=b.User.current(),g=[],h=0;h<a.length;h++){e=c?a[h].getNgFormModel():a[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function l(b,f){var g,h,j,k,l=c.defer(),n=a.messagesCacheKey+"/"+b;return f&&(n=a.messagesEditCacheKey+"/"+b),d(function(){k=e.getObject(n),l.notify(k)},0),m(b).then(function(a){g=a.relation("messages"),h=g.query(),h.ascending("createdAt"),h.include("sender"),h.include("sender.profile"),h.include("receivers"),h.find({success:function(a){j=[];for(var b=0;b<a.length;b++)j.push(f?a[b].getNgFormModel():a[b].getNgModel());e.setObject(n,j),j=e.getObject(n),l.resolve(j)},error:function(a){i.error("Parse Query Error: "+a.code+" "+a.message),l.reject(a)}})},function(a){l.reject(a)}),l.promise}function m(a){var d=c.defer(),e=new b.Query(f);return e.include("users"),e.include("users.profile"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){i.error("Parse Query Error: "+a.code+" "+a.message),d.reject(a)}}),d.promise}function n(a){for(var d=c.defer(),e=new b.Query(f),g=[],h=0;h<a.length;h++)g.push(a[h].id);return e.equalTo("userIdsHash",p(g)),e.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function o(a){for(var d=c.defer(),e=new b.ACL,g=[],h=new f({users:[]}),i=0;i<a.length;i++)e.setReadAccess(a[i].id,!0),e.setWriteAccess(a[i].id,!0),h.get("users").push(a[i]),g.push(a[i].id);return h.setACL(e),h.set("userIdsHash",p(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function p(a){return h.createHash(a.sort().join(""))}function q(a,b){function d(a){e.reject(a)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}return this.getThreadsForEditing=function(a){return j(!0,a)},this.getThreadsForDisplay=function(a){return j(!1,a)},this.getMessagesFromThreadForEditing=function(a){return l(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return l(a,!1)},this.respond=function(a,d){function e(a){i.error("Parse Error: "+a.code+" "+a.message),f.reject(a)}var f=c.defer();return m(a).then(function(a){d.sender=b.User.current(),d.receivers=k([a],!0)[0].recipients,q(a,d).then(function(){l(a.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function b(a){i.error("Parse Error: "+a.code+" "+a.message),d.reject(a)}var d=c.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),n(e).then(function(c){c?q(c[0],a).then(function(){d.resolve()},b):o(e).then(function(c){q(c,a).then(function(){d.resolve()},b)},b)},b),d.promise},this}],this}),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5","$log",function(b,c,d,e,f,g,h,i){function j(g){var h,j,l=c.defer(),m=new b.Query(f),n=a.messageThreadsCacheKey;return g&&(n=a.messageThreadsEditCacheKey),d(function(){j=e.getObject(n,[]),l.notify(j)},0),m.include("users"),m.include("users.profile"),m.find({success:function(a){h=k(a,g),e.setObject(n,h),h=e.getObject(n,[]),l.resolve(h)},error:function(a){i.error("Parse Query Error: "+a.code+a.message),l.reject(a)}}),l.promise}function k(a,c){for(var d,e,f=b.User.current(),g=[],h=0;h<a.length;h++){e=c?a[h].getNgFormModel():a[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function l(b,f){var g,h,j,k,l=c.defer(),n=a.messagesCacheKey+"/"+b;return f&&(n=a.messagesEditCacheKey+"/"+b),d(function(){k=e.getObject(n),l.notify(k)},0),m(b).then(function(a){g=a.relation("messages"),h=g.query(),h.ascending("createdAt"),h.include("sender"),h.include("sender.profile"),h.include("receivers"),h.find({success:function(a){j=[];for(var b=0;b<a.length;b++)j.push(f?a[b].getNgFormModel():a[b].getNgModel());e.setObject(n,j),j=e.getObject(n),l.resolve(j)},error:function(a){i.error("Parse Query Error: "+a.code+a.message),l.reject(a)}})},function(a){l.reject(a)}),l.promise}function m(a){var d=c.defer(),e=new b.Query(f);return e.include("users"),e.include("users.profile"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){i.error("Parse Query Error: "+a.code+a.message),d.reject(a)}}),d.promise}function n(a){for(var d=c.defer(),e=new b.Query(f),g=[],h=0;h<a.length;h++)g.push(a[h].id);return e.equalTo("userIdsHash",p(g)),e.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function o(a){for(var d=c.defer(),e=new b.ACL,g=[],h=new f({users:[]}),i=0;i<a.length;i++)e.setReadAccess(a[i].id,!0),e.setWriteAccess(a[i].id,!0),h.get("users").push(a[i]),g.push(a[i].id);return h.setACL(e),h.set("userIdsHash",p(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function p(a){return h.createHash(a.sort().join(""))}function q(a,b){function d(a){e.reject(a)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}return this.getThreadsForEditing=function(a){return j(!0,a)},this.getThreadsForDisplay=function(a){return j(!1,a)},this.getMessagesFromThreadForEditing=function(a){return l(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return l(a,!1)},this.respond=function(a,d){function e(a){i.error("Parse Error: "+a.code+a.message),f.reject(a)}var f=c.defer();return m(a).then(function(a){d.sender=b.User.current(),d.receivers=k([a],!0)[0].recipients,q(a,d).then(function(){l(a.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function b(a){i.error("Parse Error: "+a.code+a.message),d.reject(a)}var d=c.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),n(e).then(function(c){c?q(c[0],a).then(function(){d.resolve()},b):o(e).then(function(c){q(c,a).then(function(){d.resolve()},b)},b)},b),d.promise},this}],this}),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(b,c,d,e,f,g,h){function i(g){var h,i,k=c.defer(),l=new b.Query(f),m=a.messageThreadsCacheKey;return g&&(m=a.messageThreadsEditCacheKey),d(function(){i=e.getObject(m,[]),k.notify(i)},0),l.include("users"),l.include("users.profile"),l.find({success:function(a){h=j(a,g),e.setObject(m,h),h=e.getObject(m,[]),k.resolve(h)},error:function(a){k.reject(a)}}),k.promise}function j(a,c){for(var d,e,f=b.User.current(),g=[],h=0;h<a.length;h++){e=c?a[h].getNgFormModel():a[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function k(b,f){var g,h,i,j,k=c.defer(),m=a.messagesCacheKey+"/"+b;return f&&(m=a.messagesEditCacheKey+"/"+b),d(function(){j=e.getObject(m),k.notify(j)},0),l(b).then(function(a){g=a.relation("messages"),h=g.query(),h.ascending("createdAt"),h.include("sender"),h.include("sender.profile"),h.include("receivers"),h.find({success:function(a){i=[];for(var b=0;b<a.length;b++)i.push(f?a[b].getNgFormModel():a[b].getNgModel());e.setObject(m,i),i=e.getObject(m),k.resolve(i)},error:function(a){k.reject(a)}})},function(a){k.reject(a)}),k.promise}function l(a){var d=c.defer(),e=new b.Query(f);return e.include("users"),e.include("users.profile"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function m(a){for(var d=c.defer(),e=new b.Query(f),g=[],h=0;h<a.length;h++)g.push(a[h].id);return e.equalTo("userIdsHash",o(g)),e.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function n(a){for(var d=c.defer(),e=new b.ACL,g=[],h=new f({users:[]}),i=0;i<a.length;i++)e.setReadAccess(a[i].id,!0),e.setWriteAccess(a[i].id,!0),h.get("users").push(a[i]),g.push(a[i].id);return h.setACL(e),h.set("userIdsHash",o(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function o(a){return h.createHash(a.sort().join(""))}function p(a,b){function d(a,b){e.reject(b)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}return this.getThreadsForEditing=function(a){return i(!0,a)},this.getThreadsForDisplay=function(a){return i(!1,a)},this.getMessagesFromThreadForEditing=function(a){return k(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return k(a,!1)},this.respond=function(a,d){function e(a){f.reject(a)}var f=c.defer();return l(a).then(function(a){d.sender=b.User.current(),d.receivers=j([a],!0)[0].recipients,p(a,d).then(function(){k(a.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function b(a){d.reject(a)}var d=c.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),m(e).then(function(c){c?p(c[0],a).then(function(){d.resolve()},b):n(e).then(function(c){p(c,a).then(function(){d.resolve()},b)},b)},b),d.promise},this}],this}),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(b,c,d,e,f,g,h){function i(g){var h,i,k=c.defer(),l=new b.Query(f),m=a.messageThreadsCacheKey;return g&&(m=a.messageThreadsEditCacheKey),d(function(){i=e.getObject(m,[]),k.notify(i)},0),l.include("users"),l.include("users.profile"),l.find({success:function(a){h=j(a,g),e.setObject(m,h),h=e.getObject(m,[]),k.resolve(h)},error:function(a){k.reject(a)}}),k.promise}function j(a,c){for(var d,e,f=b.User.current(),g=[],h=0;h<a.length;h++){e=c?a[h].getNgFormModel():a[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function k(b,f){var g,h,i,j,k=c.defer(),m=a.messagesCacheKey+"/"+b;return f&&(m=a.messagesEditCacheKey+"/"+b),d(function(){j=e.getObject(m),k.notify(j)},0),l(b).then(function(a){g=a.relation("messages"),h=g.query(),h.ascending("createdAt"),h.include("sender"),h.include("sender.profile"),h.include("receivers"),h.find({success:function(a){i=[];for(var b=0;b<a.length;b++)i.push(f?a[b].getNgFormModel():a[b].getNgModel());e.setObject(m,i),i=e.getObject(m),k.resolve(i)},error:function(a){k.reject(a)}})},function(a){k.reject(a)}),k.promise}function l(a){var d=c.defer(),e=new b.Query(f);return e.include("users"),e.include("users.profile"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function m(a){for(var d=c.defer(),e=new b.Query(f),g=[],h=0;h<a.length;h++)g.push(a[h].id);return e.equalTo("userIdsHash",o(g)),e.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function n(a){for(var d=c.defer(),e=new b.ACL,g=[],h=new f({users:[]}),i=0;i<a.length;i++)e.setReadAccess(a[i].id,!0),e.setWriteAccess(a[i].id,!0),h.get("users").push(a[i]),g.push(a[i].id);return h.setACL(e),h.set("userIdsHash",o(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function o(a){return h.createHash(a.sort().join(""))}function p(a,b){function d(a,b){e.reject(b)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}return this.getThreadsForEditing=function(a){return i(!0,a)},this.getThreadsForDisplay=function(a){return i(!1,a)},this.getMessagesFromThreadForEditing=function(a){return k(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return k(a,!1)},this.respond=function(a,d){function e(a){f.reject(a)}var f=c.defer();return l(a).then(function(a){d.sender=b.User.current(),d.receivers=j([a],!0)[0].recipients,p(a,d).then(function(){k(a.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function b(a){d.reject(a)}var d=c.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),m(e).then(function(c){c?p(c[0],a).then(function(){d.resolve()},b):n(e).then(function(c){p(c,a).then(function(){d.resolve()},b)},b)},b),d.promise},this}],this}),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(b,c,d,e,f,g,h){function i(g){var h,i,k=c.defer(),l=new b.Query(f),m=a.messageThreadsCacheKey;return g&&(m=a.messageThreadsEditCacheKey),d(function(){i=e.getObject(m,[]),k.notify(i)},0),l.include("users"),l.include("users.profile"),l.find({success:function(a){h=j(a,g),e.setObject(m,h),h=e.getObject(m,[]),k.resolve(h)},error:function(a){k.reject(a)}}),k.promise}function j(a,c){for(var d,e,f=b.User.current(),g=[],h=0;h<a.length;h++){e=c?a[h].getNgFormModel():a[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function k(b,f){var g,h,i,j,k=c.defer(),m=a.messagesCacheKey+"/"+b;return f&&(m=a.messagesEditCacheKey+"/"+b),d(function(){j=e.getObject(m),k.notify(j)},0),l(b).then(function(a){g=a.relation("messages"),h=g.query(),h.ascending("createdAt"),h.include("sender"),h.include("sender.profile"),h.include("receivers"),h.find({success:function(a){i=[];for(var b=0;b<a.length;b++)i.push(f?a[b].getNgFormModel():a[b].getNgModel());e.setObject(m,i),i=e.getObject(m),k.resolve(i)},error:function(a){k.reject(a)}})},function(a){k.reject(a)}),k.promise}function l(a){var d=c.defer(),e=new b.Query(f);return e.include("users"),e.include("users.profile"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function m(a){for(var d=c.defer(),e=new b.Query(f),g=[],h=0;h<a.length;h++)g.push(a[h].id);return e.equalTo("userIdsHash",o(g)),e.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function n(a){for(var d=c.defer(),e=new b.ACL,g=[],h=new f({users:[]}),i=0;i<a.length;i++)e.setReadAccess(a[i].id,!0),e.setWriteAccess(a[i].id,!0),h.get("users").push(a[i]),g.push(a[i].id);return h.setACL(e),h.set("userIdsHash",o(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function o(a){return h.createHash(a.sort().join(""))}function p(a,b){function d(a,b){e.reject(b)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}return this.getThreadsForEditing=function(a){return i(!0,a)},this.getThreadsForDisplay=function(a){return i(!1,a)},this.getMessagesFromThreadForEditing=function(a){return k(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return k(a,!1)},this.respond=function(a,d){function e(a){f.reject(a)}var f=c.defer();return l(a).then(function(a){d.sender=b.User.current(),d.receivers=j([a],!0)[0].recipients,p(a,d).then(function(){k(a.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function b(a){d.reject(a)}var d=c.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),m(e).then(function(c){c?p(c[0],a).then(function(){d.resolve()},b):n(e).then(function(c){p(c,a).then(function(){d.resolve()},b)},b)},b),d.promise},this}],this}),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(b,c,d,e,f,g,h){function i(g){var h,i,k=c.defer(),l=new b.Query(f),m=a.messageThreadsCacheKey;return g&&(m=a.messageThreadsEditCacheKey),d(function(){i=e.getObject(m,[]),k.notify(i)},0),l.include("users"),l.include("users.profile"),l.find({success:function(a){h=j(a,g),e.setObject(m,h),h=e.getObject(m,[]),k.resolve(h)},error:function(a){k.reject(a)}}),k.promise}function j(a,c){for(var d,e,f=b.User.current(),g=[],h=0;h<a.length;h++){e=c?a[h].getNgFormModel():a[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function k(b,f){var g,h,i,j,k=c.defer(),m=a.messagesCacheKey+"/"+b;return f&&(m=a.messagesEditCacheKey+"/"+b),d(function(){j=e.getObject(m),k.notify(j)},0),l(b).then(function(a){g=a.relation("messages"),h=g.query(),h.ascending("createdAt"),h.include("sender"),h.include("sender.profile"),h.include("receivers"),h.find({success:function(a){i=[];for(var b=0;b<a.length;b++)i.push(f?a[b].getNgFormModel():a[b].getNgModel());e.setObject(m,i),i=e.getObject(m),k.resolve(i)},error:function(a){k.reject(a)}})},function(a){k.reject(a)}),k.promise}function l(a){var d=c.defer(),e=new b.Query(f);return e.include("users"),e.include("users.profile"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function m(a){for(var d=c.defer(),e=new b.Query(f),g=[],h=0;h<a.length;h++)g.push(a[h].id);return e.equalTo("userIdsHash",o(g)),e.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function n(a){for(var d=c.defer(),e=new b.ACL,g=[],h=new f({users:[]}),i=0;i<a.length;i++)e.setReadAccess(a[i].id,!0),e.setWriteAccess(a[i].id,!0),h.get("users").push(a[i]),g.push(a[i].id);return h.setACL(e),h.set("userIdsHash",o(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function o(a){return h.createHash(a.sort().join(""))}function p(a,b){function d(a,b){e.reject(b)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}return this.getThreadsForEditing=function(a){return i(!0,a)},this.getThreadsForDisplay=function(a){return i(!1,a)},this.getMessagesFromThreadForEditing=function(a){return k(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return k(a,!1)},this.respond=function(a,d){function e(a){f.reject(a)}var f=c.defer();return l(a).then(function(a){d.sender=b.User.current(),d.receivers=j([a],!0)[0].recipients,p(a,d).then(function(){k(a.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function b(a){d.reject(a)}var d=c.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),m(e).then(function(c){c?p(c[0],a).then(function(){d.resolve()},b):n(e).then(function(c){p(c,a).then(function(){d.resolve()},b)},b)},b),d.promise},this}],this}),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(b,c,d,e,f,g,h){function i(g){var h,i,k=c.defer(),l=new b.Query(f),m=a.messageThreadsCacheKey;return g&&(m=a.messageThreadsEditCacheKey),d(function(){i=e.getObject(m,[]),k.notify(i)},0),l.include("users"),l.include("users.profile"),l.find({success:function(a){h=j(a,g),e.setObject(m,h),h=e.getObject(m,[]),k.resolve(h)},error:function(a){k.reject(a)}}),k.promise}function j(a,c){for(var d,e,f=b.User.current(),g=[],h=0;h<a.length;h++){e=c?a[h].getNgFormModel():a[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function k(b,f){var g,h,i,j,k=c.defer(),m=a.messagesCacheKey+"/"+b;return f&&(m=a.messagesEditCacheKey+"/"+b),d(function(){j=e.getObject(m),k.notify(j)},0),l(b).then(function(a){g=a.relation("messages"),h=g.query(),h.ascending("createdAt"),h.include("sender"),h.include("sender.profile"),h.include("receivers"),h.find({success:function(a){i=[];for(var b=0;b<a.length;b++)i.push(f?a[b].getNgFormModel():a[b].getNgModel());e.setObject(m,i),i=e.getObject(m),k.resolve(i)},error:function(a){k.reject(a)}})},function(a){k.reject(a)}),k.promise}function l(a){var d=c.defer(),e=new b.Query(f);return e.include("users"),e.include("users.profile"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function m(a){for(var d=c.defer(),e=new b.Query(f),g=[],h=0;h<a.length;h++)g.push(a[h].id);return e.equalTo("userIdsHash",o(g)),e.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function n(a){for(var d=c.defer(),e=new b.ACL,g=[],h=new f({users:[]}),i=0;i<a.length;i++)e.setReadAccess(a[i].id,!0),e.setWriteAccess(a[i].id,!0),h.get("users").push(a[i]),g.push(a[i].id);return h.setACL(e),h.set("userIdsHash",o(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function o(a){return h.createHash(a.sort().join(""))}function p(a,b){function d(a,b){e.reject(b)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}return this.getThreadsForEditing=function(a){return i(!0,a)},this.getThreadsForDisplay=function(a){return i(!1,a)},this.getMessagesFromThreadForEditing=function(a){return k(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return k(a,!1)},this.respond=function(a,d){function e(a){f.reject(a)}var f=c.defer();return l(a).then(function(a){d.sender=b.User.current(),d.receivers=j([a],!0)[0].recipients,p(a,d).then(function(){k(a.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function b(a){d.reject(a)}var d=c.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),m(e).then(function(c){c?p(c[0],a).then(function(){d.resolve()},b):n(e).then(function(c){p(c,a).then(function(){d.resolve()},b)},b)},b),d.promise},this}],this}),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5","CACHEKEYS",function(a,b,c,d,e,f,g,h){function i(f){var g,i,k=b.defer(),l=new a.Query(e),m=h.messagethreads;return f&&(m=h["messagethreads:edit"]),c(function(){i=d.getObject(m,[]),k.notify(i)},0),l.include("users"),l.include("users.profile"),l.find({success:function(a){g=j(a,f),d.setObject(m,g),g=d.getObject(m,[]),k.resolve(g)},error:function(a){k.reject(a)}}),k.promise}function j(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function k(a,e){var f,g,h,i,j=b.defer(),k="messagethread:messages"+a;return e&&(k="messagethread:messages:edit"+a),c(function(){i=d.getObject(k),j.notify(i)},0),l(a).then(function(a){f=a.relation("messages"),g=f.query(),g.ascending("createdAt"),g.include("sender"),g.include("sender.profile"),g.include("receivers"),g.find({success:function(a){h=[];for(var b=0;b<a.length;b++)h.push(e?a[b].getNgFormModel():a[b].getNgModel());d.setObject(k,h),h=d.getObject(k),j.resolve(h)},error:function(a){j.reject(a)}})},function(a){j.reject(a)}),j.promise}function l(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function m(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",o(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function n(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",o(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function o(a){return g.createHash(a.sort().join(""))}function p(a,c){function d(a,b){e.reject(b)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}this.getThreadsForEditing=function(a){return i(!0,a)},this.getThreadsForDisplay=function(a){return i(!1,a)},this.getMessagesFromThreadForEditing=function(a){return k(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return k(a,!1)},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return l(c).then(function(b){d.sender=a.User.current(),d.receivers=j([b],!0)[0].recipients,p(b,d).then(function(){k(b.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),m(e).then(function(b){b?p(b[0],a).then(function(){d.resolve()},c):n(e).then(function(b){p(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});
return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5","CACHEKEYS",function(a,b,c,d,e,f,g,h){function i(f){var g,i,k=b.defer(),l=new a.Query(e),m=h.messagethreads;return f&&(m=h["messagethreads:edit"]),c(function(){i=d.getObject(m,[]),k.notify(i)},0),l.include("users"),l.include("users.profile"),l.find({success:function(a){g=j(a,f),d.setObject(m,g),g=d.getObject(m,[]),k.resolve(g)},error:function(a){k.reject(a)}}),k.promise}function j(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function k(a,e){var f,g,h,i,j=b.defer(),k="messagethread:messages"+a;return e&&(k="messagethread:messages:edit"+a),c(function(){i=d.getObject(k),j.notify(i)},0),l(a).then(function(a){f=a.relation("messages"),g=f.query(),g.ascending("createdAt"),g.include("sender"),g.include("sender.profile"),g.include("receivers"),g.find({success:function(a){h=[];for(var b=0;b<a.length;b++)h.push(e?a[b].getNgFormModel():a[b].getNgModel());d.setObject(k,h),h=d.getObject(k),j.resolve(h)},error:function(a){j.reject(a)}})},function(a){j.reject(a)}),j.promise}function l(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function m(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",o(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function n(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",o(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function o(a){return g.createHash(a.sort().join(""))}function p(a,c){function d(a,b){e.reject(b)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}this.getThreadsForEditing=function(a){return i(!0,a)},this.getThreadsForDisplay=function(a){return i(!1,a)},this.getMessagesFromThreadForEditing=function(a){return k(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return k(a,!1)},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return l(c).then(function(b){d.sender=a.User.current(),d.receivers=j([b],!0)[0].recipients,p(b,d).then(function(){k(b.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),m(e).then(function(b){b?p(b[0],a).then(function(){d.resolve()},c):n(e).then(function(b){p(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5","CACHEKEYS",function(a,b,c,d,e,f,g,h){function i(f){var g,i,k=b.defer(),l=new a.Query(e),m=h.messagethreads;return f&&(m=h["messagethreads:edit"]),c(function(){i=d.getObject(m,[]),k.notify(i)},0),l.include("users"),l.include("users.profile"),l.find({success:function(a){g=j(a,f),d.setObject(m,g),g=d.getObject(m,[]),k.resolve(g)},error:function(a){k.reject(a)}}),k.promise}function j(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function k(a,e){var f,g,h,i,j=b.defer(),k="messagethread:messages"+a;return e&&(k="messagethread:messages:edit"+a),c(function(){i=d.getObject(k),j.notify(i)},0),l(a).then(function(a){f=a.relation("messages"),g=f.query(),g.ascending("createdAt"),g.include("sender"),g.include("sender.profile"),g.include("receivers"),g.find({success:function(a){h=[];for(var b=0;b<a.length;b++)h.push(e?a[b].getNgFormModel():a[b].getNgModel());d.setObject(k,h),h=d.getObject(k),j.resolve(h)},error:function(a){j.reject(a)}})},function(a){j.reject(a)}),j.promise}function l(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function m(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",o(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function n(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",o(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function o(a){return g.createHash(a.sort().join(""))}function p(a,c){function d(a,b){e.reject(b)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}this.getThreadsForEditing=function(a){return i(!0,a)},this.getThreadsForDisplay=function(a){return i(!1,a)},this.getMessagesFromThreadForEditing=function(a){return k(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return k(a,!1)},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return l(c).then(function(b){d.sender=a.User.current(),d.receivers=j([b],!0)[0].recipients,p(b,d).then(function(){k(b.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),m(e).then(function(b){b?p(b[0],a).then(function(){d.resolve()},c):n(e).then(function(b){p(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5","CACHEKEYS",function(a,b,c,d,e,f,g,h){function i(f){var g,i,k=b.defer(),l=new a.Query(e),m=h.messagethreads;return f&&(m=h["messagethreads:edit"]),c(function(){i=d.getObject(m,[]),k.notify(i)},0),l.include("users"),l.include("users.profile"),l.find({success:function(a){g=j(a,f),d.setObject(m,g),g=d.getObject(m,[]),k.resolve(g)},error:function(a){k.reject(a)}}),k.promise}function j(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function k(a,e){var f,g,h,i,j=b.defer(),k="messagethread:messages"+a;return e&&(k="messagethread:messages:edit"+a),c(function(){i=d.getObject(k),j.notify(i)},0),l(a).then(function(a){f=a.relation("messages"),g=f.query(),g.ascending("createdAt"),g.include("sender"),g.include("sender.profile"),g.include("receivers"),g.find({success:function(a){h=[];for(var b=0;b<a.length;b++)h.push(e?a[b].getNgFormModel():a[b].getNgModel());d.setObject(k,h),h=d.getObject(k),j.resolve(h)},error:function(a){j.reject(a)}})},function(a){j.reject(a)}),j.promise}function l(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function m(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",o(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function n(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",o(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function o(a){return g.createHash(a.sort().join(""))}function p(a,c){function d(a,b){e.reject(b)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}this.getThreadsForEditing=function(a){return i(!0,a)},this.getThreadsForDisplay=function(a){return i(!1,a)},this.getMessagesFromThreadForEditing=function(a){return k(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return k(a,!1)},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return l(c).then(function(b){d.sender=a.User.current(),d.receivers=j([b],!0)[0].recipients,p(b,d).then(function(){k(b.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),m(e).then(function(b){b?p(b[0],a).then(function(){d.resolve()},c):n(e).then(function(b){p(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(f,g){var h,j,k,l=b.defer(),m=new a.Query(e),n="message:threads:display";return f&&(n="message:threads:edit"),c(function(){k=d.getObject(n),l.notify(k)},0),m.include("users"),m.include("users.profile"),m.find({success:function(a){if(h=i(a,f),g)for(var b=0;b<h.length;b++)j=d.get(":thread:unread:count:"+h[b].objectId,0),h[b].unreadCount=j;d.setObject("message:threads",h),h=d.getObject("message:threads"),l.resolve(h)},error:function(a){l.reject(a)}}),l.promise}function i(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function j(a,e){var f,g,h,i,j=b.defer(),l="thread:messages:display:"+a;return e&&(l="thread:messages:edit:"+a),c(function(){i=d.getObject(l),j.notify(i)},0),k(a).then(function(a){f=a.relation("messages"),g=f.query(),g.ascending("createdAt"),g.include("sender"),g.include("sender.profile"),g.include("receivers"),g.find({success:function(a){h=[];for(var b=0;b<a.length;b++)h.push(e?a[b].getNgFormModel():a[b].getNgModel());d.setObject(l,h),h=d.getObject(l),j.resolve(h)},error:function(a){j.reject(a)}})},function(a){j.reject(a)}),j.promise}function k(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",n(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function m(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",n(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function n(a){return g.createHash(a.sort().join(""))}function o(a,c){function d(a,b){e.reject(b)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}this.getThreadsForEditing=function(a){return h(!0,a)},this.getThreadsForDisplay=function(a){return h(!1,a)},this.getMessagesFromThreadForEditing=function(a){return j(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return j(a,!1)},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return k(c).then(function(b){d.sender=a.User.current(),d.receivers=i([b],!0)[0].recipients,o(b,d).then(function(){j(b.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),l(e).then(function(b){b?o(b[0],a).then(function(){d.resolve()},c):m(e).then(function(b){o(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(f,g){var h,j,k,l=b.defer(),m=new a.Query(e),n="message:threads:display";return f&&(n="message:threads:edit"),c(function(){k=d.getObject(n),l.notify(k)},0),m.include("users"),m.include("users.profile"),m.find({success:function(a){if(h=i(a,f),g)for(var b=0;b<h.length;b++)j=d.get(":thread:unread:count:"+h[b].objectId,0),h[b].unreadCount=j;d.setObject("message:threads",h),h=d.getObject("message:threads"),l.resolve(h)},error:function(a){l.reject(a)}}),l.promise}function i(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function j(a,e){var f,g,h,i,j=b.defer(),l="thread:messages:display:"+a;return e&&(l="thread:messages:edit:"+a),c(function(){i=d.getObject(l),j.notify(i)},0),k(a).then(function(a){f=a.relation("messages"),g=f.query(),g.ascending("createdAt"),g.include("sender"),g.include("sender.profile"),g.include("receivers"),g.find({success:function(a){h=[];for(var b=0;b<a.length;b++)h.push(e?a[b].getNgFormModel():a[b].getNgModel());d.setObject(l,h),h=d.getObject(l),j.resolve(h)},error:function(a){j.reject(a)}})},function(a){j.reject(a)}),j.promise}function k(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",n(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function m(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",n(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function n(a){return g.createHash(a.sort().join(""))}function o(a,c){function d(a,b){e.reject(b)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}this.getThreadsForEditing=function(a){return h(!0,a)},this.getThreadsForDisplay=function(a){return h(!1,a)},this.getMessagesFromThreadForEditing=function(a){return j(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return j(a,!1)},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return k(c).then(function(b){d.sender=a.User.current(),d.receivers=i([b],!0)[0].recipients,o(b,d).then(function(){j(b.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),l(e).then(function(b){b?o(b[0],a).then(function(){d.resolve()},c):m(e).then(function(b){o(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(f,g){var h,j,k,l=b.defer(),m=new a.Query(e),n="message:threads:display";return f&&(n="message:threads:edit"),c(function(){k=d.getObject(n),l.notify(k)},0),m.include("users"),m.include("users.profile"),m.find({success:function(a){if(h=i(a,f),g)for(var b=0;b<h.length;b++)j=d.get(":thread:unread:count:"+h[b].objectId,0),h[b].unreadCount=j;d.setObject("message:threads",h),h=d.getObject("message:threads"),l.resolve(h)},error:function(a){l.reject(a)}}),l.promise}function i(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function j(a,e){var f,g,h,i,j=b.defer(),l="thread:messages:display:"+a;return e&&(l="thread:messages:edit:"+a),c(function(){i=d.getObject(l),j.notify(i)},0),k(a).then(function(a){f=a.relation("messages"),g=f.query(),g.ascending("createdAt"),g.include("sender"),g.include("sender.profile"),g.include("receivers"),g.find({success:function(a){h=[];for(var b=0;b<a.length;b++)h.push(e?a[b].getNgFormModel():a[b].getNgModel());d.setObject(l,h),h=d.getObject(l),j.resolve(h)},error:function(a){j.reject(a)}})},function(a){j.reject(a)}),j.promise}function k(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",n(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function m(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",n(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function n(a){return g.createHash(a.sort().join(""))}function o(a,c){function d(a,b){e.reject(b)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}this.getThreadsForEditing=function(a){return h(!0,a)},this.getThreadsForDisplay=function(a){return h(!1,a)},this.getMessagesFromThreadForEditing=function(a){return j(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return j(a,!1)},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return k(c).then(function(b){d.sender=a.User.current(),d.receivers=i([b],!0)[0].recipients,o(b,d).then(function(){j(b.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),l(e).then(function(b){b?o(b[0],a).then(function(){d.resolve()},c):m(e).then(function(b){o(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(f,g){var h,j,k,l=b.defer(),m=new a.Query(e),n="message:threads:display";return f&&(n="message:threads:edit"),c(function(){k=d.getObject(n),l.notify(k)},0),m.include("users"),m.include("users.profile"),m.find({success:function(a){if(h=i(a,f),g)for(var b=0;b<h.length;b++)j=d.get(":thread:unread:count:"+h[b].objectId,0),h[b].unreadCount=j;d.setObject("message:threads",h),h=d.getObject("message:threads"),l.resolve(h)},error:function(a){l.reject(a)}}),l.promise}function i(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function j(a,e){var f,g,h,i,j=b.defer(),l="thread:messages:display:"+a;return e&&(l="thread:messages:edit:"+a),c(function(){i=d.getObject(l),j.notify(i)},0),k(a).then(function(a){f=a.relation("messages"),g=f.query(),g.ascending("createdAt"),g.include("sender"),g.include("sender.profile"),g.include("receivers"),g.find({success:function(a){h=[];for(var b=0;b<a.length;b++)h.push(e?a[b].getNgFormModel():a[b].getNgModel());d.setObject(l,h),h=d.getObject(l),j.resolve(h)},error:function(a){j.reject(a)}})},function(a){j.reject(a)}),j.promise}function k(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",n(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function m(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",n(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function n(a){return g.createHash(a.sort().join(""))}function o(a,c){function d(a,b){e.reject(b)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}this.getThreadsForEditing=function(a){return h(!0,a)},this.getThreadsForDisplay=function(a){return h(!1,a)},this.getMessagesFromThreadForEditing=function(a){return j(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return j(a,!1)},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return k(c).then(function(b){d.sender=a.User.current(),d.receivers=i([b],!0)[0].recipients,o(b,d).then(function(){j(b.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),l(e).then(function(b){b?o(b[0],a).then(function(){d.resolve()},c):m(e).then(function(b){o(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(f,g){var h,j,k,l=b.defer(),m=new a.Query(e),n="message:threads:display";return f&&(n="message:threads:edit"),c(function(){k=d.getObject(n),l.notify(k)},0),m.include("users"),m.include("users.profile"),m.find({success:function(a){if(h=i(a,f),g)for(var b=0;b<h.length;b++)j=d.get(":thread:unread:count:"+h[b].objectId,0),h[b].unreadCount=j;d.setObject("message:threads",h),h=d.getObject("message:threads"),l.resolve(h)},error:function(a){l.reject(a)}}),l.promise}function i(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function j(a,e){var f,g,h,i,j=b.defer(),l="thread:messages:display:"+a;return e&&(l="thread:messages:edit:"+a),c(function(){i=d.getObject(l),j.notify(i)},0),k(a).then(function(a){f=a.relation("messages"),g=f.query(),g.ascending("createdAt"),g.include("sender"),g.include("sender.profile"),g.include("receivers"),g.find({success:function(a){h=[];for(var b=0;b<a.length;b++)h.push(e?a[b].getNgFormModel():a[b].getNgModel());d.setObject(l,h),h=d.getObject(l),j.resolve(h)},error:function(a){j.reject(a)}})},function(a){j.reject(a)}),j.promise}function k(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",n(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function m(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",n(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function n(a){return g.createHash(a.sort().join(""))}function o(a,c){function d(a,b){e.reject(b)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}this.getThreadsForEditing=function(a){return h(!0,a)},this.getThreadsForDisplay=function(a){return h(!1,a)},this.getMessagesFromThreadForEditing=function(a){return j(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return j(a,!1)},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return k(c).then(function(b){d.sender=a.User.current(),d.receivers=i([b],!0)[0].recipients,o(b,d).then(function(){j(b.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),l(e).then(function(b){b?o(b[0],a).then(function(){d.resolve()},c):m(e).then(function(b){o(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(f,g){var h,j,k,l=b.defer(),m=new a.Query(e),n="message:threads:display";return f&&(n="message:threads:edit"),c(function(){k=d.getObject(n),l.notify(k)},0),m.include("users"),m.include("users.profile"),m.find({success:function(a){if(h=i(a,f),g)for(var b=0;b<h.length;b++)j=d.get(":thread:unread:count:"+h[b].objectId,0),h[b].unreadCount=j;d.setObject("message:threads",h),h=d.getObject("message:threads"),l.resolve(h)},error:function(a){l.reject(a)}}),l.promise}function i(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function j(a,e){var f,g,h,i,j=b.defer(),l="thread:messages:display:"+a;return e&&(l="thread:messages:edit:"+a),c(function(){i=d.getObject(l),j.notify(i)},0),k(a).then(function(a){f=a.relation("messages"),g=f.query(),g.ascending("createdAt"),g.include("sender"),g.include("sender.profile"),g.include("receivers"),g.find({success:function(a){h=[];for(var b=0;b<a.length;b++)h.push(e?a[b].getNgFormModel():a[b].getNgModel());d.setObject(l,h),h=d.getObject(l),j.resolve(h)},error:function(a){j.reject(a)}})},function(a){j.reject(a)}),j.promise}function k(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",n(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function m(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",n(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function n(a){return g.createHash(a.sort().join(""))}function o(a,c){function d(a,b){e.reject(b)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}this.getThreadsForEditing=function(a){return h(!0,a)},this.getThreadsForDisplay=function(a){return h(!1,a)},this.getMessagesFromThreadForEditing=function(a){return j(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return j(a,!1)},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return k(c).then(function(b){d.sender=a.User.current(),d.receivers=i([b],!0)[0].recipients,o(b,d).then(function(){j(b.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),l(e).then(function(b){b?o(b[0],a).then(function(){d.resolve()},c):m(e).then(function(b){o(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(f,g){var h,j,k,l=b.defer(),m=new a.Query(e),n="message:threads:display";return f&&(n="message:threads:edit"),c(function(){k=d.getObject(n),l.notify(k)},0),m.include("users"),m.include("users.profile"),m.find({success:function(a){if(h=i(a,f),g)for(var b=0;b<h.length;b++)j=d.get(":thread:unread:count:"+h[b].objectId,0),h[b].unreadCount=j;d.setObject("message:threads",h),h=d.getObject("message:threads"),l.resolve(h)
},error:function(a){l.reject(a)}}),l.promise}function i(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function j(a,e){var f,g,h,i,j=b.defer(),l="thread:messages:display:"+a;return e&&(l="thread:messages:edit:"+a),c(function(){i=d.getObject(l),j.notify(i)},0),k(a).then(function(a){f=a.relation("messages"),g=f.query(),g.ascending("createdAt"),g.include("sender"),g.include("sender.profile"),g.include("receivers"),g.find({success:function(a){h=[];for(var b=0;b<a.length;b++)h.push(e?a[b].getNgFormModel():a[b].getNgModel());d.setObject(l,h),h=d.getObject(l),j.resolve(h)},error:function(a){j.reject(a)}})},function(a){j.reject(a)}),j.promise}function k(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",n(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function m(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",n(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function n(a){return g.createHash(a.sort().join(""))}function o(a,c){function d(a,b){e.reject(b)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}this.getThreadsForEditing=function(a){return h(!0,a)},this.getThreadsForDisplay=function(a){return h(!1,a)},this.getMessagesFromThreadForEditing=function(a){return j(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return j(a,!1)},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return k(c).then(function(b){d.sender=a.User.current(),d.receivers=i([b],!0)[0].recipients,o(b,d).then(function(){j(b.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),l(e).then(function(b){b?o(b[0],a).then(function(){d.resolve()},c):m(e).then(function(b){o(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(f,g){var h,j,k,l=b.defer(),m=new a.Query(e),n="message:threads:display";return f&&(n="message:threads:edit"),c(function(){k=d.getObject(n),l.notify(k)},0),m.include("users"),m.include("users.profile"),m.find({success:function(a){if(h=i(a,f),g)for(var b=0;b<h.length;b++)j=d.get(":thread:unread:count:"+h[b].objectId,0),h[b].unreadCount=j;d.setObject("message:threads",h),h=d.getObject("message:threads"),l.resolve(h)},error:function(a){l.reject(a)}}),l.promise}function i(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function j(a,e){var f,g,h,i,j=b.defer(),l="thread:messages:display:"+a;return e&&(l="thread:messages:edit:"+a),c(function(){i=d.getObject(l),j.notify(i)},0),k(a).then(function(a){f=a.relation("messages"),g=f.query(),g.ascending("createdAt"),g.include("sender"),g.include("sender.profile"),g.include("receivers"),g.find({success:function(a){h=[];for(var b=0;b<a.length;b++)h.push(e?a[b].getNgFormModel():a[b].getNgModel());d.setObject(l,h),h=d.getObject(l),j.resolve(h)},error:function(a){j.reject(a)}})},function(a){j.reject(a)}),j.promise}function k(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",n(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function m(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",n(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function n(a){return g.createHash(a.sort().join(""))}function o(a,c){function d(a,b){e.reject(b)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}this.getThreadsForEditing=function(a){return h(!0,a)},this.getThreadsForDisplay=function(a){return h(!1,a)},this.getMessagesFromThreadForEditing=function(a){return j(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return j(a,!1)},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return k(c).then(function(b){d.sender=a.User.current(),d.receivers=i([b],!0)[0].recipients,o(b,d).then(function(){j(b.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),l(e).then(function(b){b?o(b[0],a).then(function(){d.resolve()},c):m(e).then(function(b){o(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(f,g){var h,j,k,l=b.defer(),m=new a.Query(e),n="message:threads:display";return f&&(n="message:threads:edit"),c(function(){k=d.getObject(n),l.notify(k)},0),m.include("users"),m.include("users.profile"),m.find({success:function(a){if(h=i(a,f),g)for(var b=0;b<h.length;b++)j=d.get(":thread:unread:count:"+h[b].objectId,0),h[b].unreadCount=j;d.setObject("message:threads",h),h=d.getObject("message:threads"),l.resolve(h)},error:function(a){l.reject(a)}}),l.promise}function i(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function j(a,e){var f,g,h,i,j=b.defer(),l="thread:messages:display:"+a;return e&&(l="thread:messages:edit:"+a),c(function(){i=d.getObject(l),j.notify(i)},0),k(a).then(function(a){f=a.relation("messages"),g=f.query(),g.ascending("createdAt"),g.include("sender"),g.include("sender.profile"),g.include("receivers"),g.find({success:function(a){h=[];for(var b=0;b<a.length;b++)h.push(e?a[b].getNgFormModel():a[b].getNgModel());d.setObject(l,h),h=d.getObject(l),j.resolve(h)},error:function(a){j.reject(a)}})},function(a){j.reject(a)}),j.promise}function k(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",n(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function m(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",n(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function n(a){return g.createHash(a.sort().join(""))}function o(a,c){function d(a,b){e.reject(b)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}this.getThreadsForEditing=function(a){return h(!0,a)},this.getThreadsForDisplay=function(a){return h(!1,a)},this.getMessagesFromThreadForEditing=function(a){return j(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return j(a,!1)},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return k(c).then(function(b){d.sender=a.User.current(),d.receivers=i([b],!0)[0].recipients,o(b,d).then(function(){j(b.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),l(e).then(function(b){b?o(b[0],a).then(function(){d.resolve()},c):m(e).then(function(b){o(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(f,g){var h,j,k,l=b.defer(),m=new a.Query(e),n="message:threads:display";return f&&(n="message:threads:edit"),c(function(){k=d.getObject(n),l.notify(k)},0),m.include("users"),m.include("users.profile"),m.find({success:function(a){if(h=i(a,f),g)for(var b=0;b<h.length;b++)j=d.get(":thread:unread:count:"+h[b].objectId,0),h[b].unreadCount=j;d.setObject("message:threads",h),h=d.getObject("message:threads"),l.resolve(h)},error:function(a){l.reject(a)}}),l.promise}function i(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function j(a,e){var f,g,h,i,j=b.defer(),l="thread:messages:display:"+a;return e&&(l="thread:messages:edit:"+a),c(function(){i=d.getObject(l),j.notify(i)},0),k(a).then(function(a){f=a.relation("messages"),g=f.query(),g.ascending("createdAt"),g.include("sender"),g.include("sender.profile"),g.include("receivers"),g.find({success:function(a){h=[];for(var b=0;b<a.length;b++)h.push(e?a[b].getNgFormModel():a[b].getNgModel());d.setObject(l,h),h=d.getObject(l),j.resolve(h)},error:function(a){j.reject(a)}})},function(a){j.reject(a)}),j.promise}function k(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",n(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function m(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",n(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function n(a){return g.createHash(a.sort().join(""))}function o(a,c){function d(a,b){e.reject(b)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}this.getThreadsForEditing=function(a){return h(!0,a)},this.getThreadsForDisplay=function(a){return h(!1,a)},this.getMessagesFromThreadForEditing=function(a){return j(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return j(a,!1)},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return k(c).then(function(b){d.sender=a.User.current(),d.receivers=i([b],!0)[0].recipients,o(b,d).then(function(){j(b.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),l(e).then(function(b){b?o(b[0],a).then(function(){d.resolve()},c):m(e).then(function(b){o(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(f,g){var h,j,k,l=b.defer(),m=new a.Query(e),n="message:threads:display";return f&&(n="message:threads:edit"),c(function(){k=d.getObject(n),l.notify(k)},0),m.include("users"),m.include("users.profile"),m.find({success:function(a){if(h=i(a,f),g)for(var b=0;b<h.length;b++)j=d.get(":thread:unread:count:"+h[b].objectId,0),h[b].unreadCount=j;d.setObject("message:threads",h),h=d.getObject("message:threads"),l.resolve(h)},error:function(a){l.reject(a)}}),l.promise}function i(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function j(a,e){var f,g,h,i,j=b.defer(),l="thread:messages:display:"+a;return e&&(l="thread:messages:edit:"+a),c(function(){i=d.getObject(l),j.notify(i)},0),k(a).then(function(a){f=a.relation("messages"),g=f.query(),g.ascending("createdAt"),g.include("sender"),g.include("sender.profile"),g.include("receivers"),g.find({success:function(a){h=[];for(var b=0;b<a.length;b++)h.push(e?a[b].getNgFormModel():a[b].getNgModel());d.setObject(l,h),h=d.getObject(l),j.resolve(h)},error:function(a){j.reject(a)}})},function(a){j.reject(a)}),j.promise}function k(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",n(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function m(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",n(g)),h.save({success:function(a){d.resolve(a)},error:function(a,b){d.reject(b)}}),d.promise}function n(a){return g.createHash(a.sort().join(""))}function o(a,c){function d(a,b){e.reject(b)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}this.getThreadsForEditing=function(a){return h(!0,a)},this.getThreadsForDisplay=function(a){return h(!1,a)},this.getMessagesFromThreadForEditing=function(a){return j(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return j(a,!1)},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return k(c).then(function(b){d.sender=a.User.current(),d.receivers=i([b],!0)[0].recipients,o(b,d).then(function(){j(b.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),l(e).then(function(b){b?o(b[0],a).then(function(){d.resolve()},c):m(e).then(function(b){o(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function i(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",l(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",l(g)),h.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(a){return g.createHash(a.sort().join(""))}function m(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var n=this;this.getThreads=function(){var f=b.defer(),g=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),g.include("users"),g.include("users.profile"),g.find({success:function(a){var b=h(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),i(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return i(c).then(function(b){d.sender=a.User.current(),d.receivers=h([b],!0)[0].recipients,m(b,d).then(function(){n.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),j(e).then(function(b){b?m(b[0],a).then(function(){d.resolve()},c):k(e).then(function(b){m(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function i(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",l(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",l(g)),h.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(a){return g.createHash(a.sort().join(""))}function m(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var n=this;this.getThreads=function(){var f=b.defer(),g=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),g.include("users"),g.include("users.profile"),g.find({success:function(a){var b=h(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),i(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return i(c).then(function(b){d.sender=a.User.current(),d.receivers=h([b],!0)[0].recipients,m(b,d).then(function(){n.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),j(e).then(function(b){b?m(b[0],a).then(function(){d.resolve()},c):k(e).then(function(b){m(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function i(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",l(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",l(g)),h.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(a){return g.createHash(a.sort().join(""))}function m(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var n=this;this.getThreads=function(){var f=b.defer(),g=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),g.include("users"),g.include("users.profile"),g.find({success:function(a){var b=h(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),i(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return i(c).then(function(b){d.sender=a.User.current(),d.receivers=h([b],!0)[0].recipients,m(b,d).then(function(){n.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),j(e).then(function(b){b?m(b[0],a).then(function(){d.resolve()},c):k(e).then(function(b){m(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function i(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",l(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",l(g)),h.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(a){return g.createHash(a.sort().join(""))}function m(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var n=this;this.getThreads=function(){var f=b.defer(),g=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),g.include("users"),g.include("users.profile"),g.find({success:function(a){var b=h(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),i(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return i(c).then(function(b){d.sender=a.User.current(),d.receivers=h([b],!0)[0].recipients,m(b,d).then(function(){n.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),j(e).then(function(b){b?m(b[0],a).then(function(){d.resolve()},c):k(e).then(function(b){m(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function i(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",l(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",l(g)),h.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(a){return g.createHash(a.sort().join(""))}function m(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var n=this;this.getThreads=function(){var f=b.defer(),g=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),g.include("users"),g.include("users.profile"),g.find({success:function(a){var b=h(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),i(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return i(c).then(function(b){d.sender=a.User.current(),d.receivers=h([b],!0)[0].recipients,m(b,d).then(function(){n.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),j(e).then(function(b){b?m(b[0],a).then(function(){d.resolve()},c):k(e).then(function(b){m(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)
}return g}function i(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",l(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",l(g)),h.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(a){return g.createHash(a.sort().join(""))}function m(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var n=this;this.getThreads=function(){var f=b.defer(),g=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),g.include("users"),g.include("users.profile"),g.find({success:function(a){var b=h(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),i(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return i(c).then(function(b){d.sender=a.User.current(),d.receivers=h([b],!0)[0].recipients,m(b,d).then(function(){n.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),j(e).then(function(b){b?m(b[0],a).then(function(){d.resolve()},c):k(e).then(function(b){m(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function i(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",l(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",l(g)),h.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(a){return g.createHash(a.sort().join(""))}function m(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var n=this;this.getThreads=function(){var f=b.defer(),g=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),g.include("users"),g.include("users.profile"),g.find({success:function(a){var b=h(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),i(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return i(c).then(function(b){d.sender=a.User.current(),d.receivers=h([b],!0)[0].recipients,m(b,d).then(function(){n.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),j(e).then(function(b){b?m(b[0],a).then(function(){d.resolve()},c):k(e).then(function(b){m(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function i(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",l(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",l(g)),h.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(a){return g.createHash(a.sort().join(""))}function m(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var n=this;this.getThreads=function(){var f=b.defer(),g=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),g.include("users"),g.include("users.profile"),g.find({success:function(a){var b=h(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),i(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return i(c).then(function(b){d.sender=a.User.current(),d.receivers=h([b],!0)[0].recipients,m(b,d).then(function(){n.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),j(e).then(function(b){b?m(b[0],a).then(function(){d.resolve()},c):k(e).then(function(b){m(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function i(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",l(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",l(g)),h.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(a){return g.createHash(a.sort().join(""))}function m(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var n=this;this.getThreads=function(){var f=b.defer(),g=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),g.include("users"),g.include("users.profile"),g.find({success:function(a){var b=h(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),i(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return i(c).then(function(b){d.sender=a.User.current(),d.receivers=h([b],!0)[0].recipients,m(b,d).then(function(){n.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),j(e).then(function(b){b?m(b[0],a).then(function(){d.resolve()},c):k(e).then(function(b){m(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function i(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",l(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",l(g)),h.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(a){return g.createHash(a.sort().join(""))}function m(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var n=this;this.getThreads=function(){var f=b.defer(),g=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),g.include("users"),g.include("users.profile"),g.find({success:function(a){var b=h(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),i(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return i(c).then(function(b){d.sender=a.User.current(),d.receivers=h([b],!0)[0].recipients,m(b,d).then(function(){n.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),j(e).then(function(b){b?m(b[0],a).then(function(){d.resolve()},c):k(e).then(function(b){m(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function i(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",l(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",l(g)),h.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(a){return g.createHash(a.sort().join(""))}function m(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var n=this;this.getThreads=function(){var f=b.defer(),g=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),g.include("users"),g.include("users.profile"),g.find({success:function(a){var b=h(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),i(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return i(c).then(function(b){d.sender=a.User.current(),d.receivers=h([b],!0)[0].recipients,m(b,d).then(function(){n.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),j(e).then(function(b){b?m(b[0],a).then(function(){d.resolve()},c):k(e).then(function(b){m(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function i(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",l(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",l(g)),h.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(a){return g.createHash(a.sort().join(""))}function m(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var n=this;this.getThreads=function(){var f=b.defer(),g=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),g.include("users"),g.include("users.profile"),g.find({success:function(a){var b=h(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),i(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return i(c).then(function(b){d.sender=a.User.current(),d.receivers=h([b],!0)[0].recipients,m(b,d).then(function(){n.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),j(e).then(function(b){b?m(b[0],a).then(function(){d.resolve()},c):k(e).then(function(b){m(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function i(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",l(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",l(g)),h.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(a){return g.createHash(a.sort().join(""))}function m(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var n=this;this.getThreads=function(){var f=b.defer(),g=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),g.include("users"),g.include("users.profile"),g.find({success:function(a){var b=h(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),i(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return i(c).then(function(b){d.sender=a.User.current(),d.receivers=h([b],!0)[0].recipients,m(b,d).then(function(){n.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),j(e).then(function(b){b?m(b[0],a).then(function(){d.resolve()},c):k(e).then(function(b){m(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function i(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",l(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",l(g)),h.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(a){return g.createHash(a.sort().join(""))}function m(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var n=this;this.getThreads=function(){var f=b.defer(),g=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),g.include("users"),g.include("users.profile"),g.find({success:function(a){var b=h(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),i(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return i(c).then(function(b){d.sender=a.User.current(),d.receivers=h([b],!0)[0].recipients,m(b,d).then(function(){n.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),j(e).then(function(b){b?m(b[0],a).then(function(){d.resolve()},c):k(e).then(function(b){m(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function i(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",l(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",l(g)),h.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(a){return g.createHash(a.sort().join(""))}function m(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var n=this;this.getThreads=function(){var f=b.defer(),g=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),g.include("users"),g.include("users.profile"),g.find({success:function(a){var b=h(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),i(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return i(c).then(function(b){d.sender=a.User.current(),d.receivers=h([b],!0)[0].recipients,m(b,d).then(function(){n.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),j(e).then(function(b){b?m(b[0],a).then(function(){d.resolve()},c):k(e).then(function(b){m(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function i(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",l(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",l(g)),h.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(a){return g.createHash(a.sort().join(""))}function m(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var n=this;this.getThreads=function(){var f=b.defer(),g=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),g.include("users"),g.include("users.profile"),g.find({success:function(a){var b=h(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),i(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return i(c).then(function(b){d.sender=a.User.current(),d.receivers=h([b],!0)[0].recipients,m(b,d).then(function(){n.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),j(e).then(function(b){b?m(b[0],a).then(function(){d.resolve()
},c):k(e).then(function(b){m(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function i(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",l(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",l(g)),h.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(a){return g.createHash(a.sort().join(""))}function m(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var n=this;this.getThreads=function(){var f=b.defer(),g=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),g.include("users"),g.include("users.profile"),g.find({success:function(a){var b=h(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),i(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return i(c).then(function(b){d.sender=a.User.current(),d.receivers=h([b],!0)[0].recipients,m(b,d).then(function(){n.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),j(e).then(function(b){b?m(b[0],a).then(function(){d.resolve()},c):k(e).then(function(b){m(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function i(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",l(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",l(g)),h.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(a){return g.createHash(a.sort().join(""))}function m(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var n=this;this.getThreads=function(){var f=b.defer(),g=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),g.include("users"),g.include("users.profile"),g.find({success:function(a){var b=h(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),i(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return i(c).then(function(b){d.sender=a.User.current(),d.receivers=h([b],!0)[0].recipients,m(b,d).then(function(){n.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),j(e).then(function(b){b?m(b[0],a).then(function(){d.resolve()},c):k(e).then(function(b){m(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message",function(a,b,c,d,e,f){function g(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function h(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function i(c){var d=b.defer(),f=new a.Query(e);return f.containsAll("users",c),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){var d=b.defer(),f=null,g=new a.ACL;f=new e({users:[]});for(var h=0;h<c.length;h++)g.setReadAccess(c[h].id,!0),g.setWriteAccess(c[h].id,!0),f.get("users").push(c[h]);return f.setACL(g),f.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var l=this;this.getThreads=function(){var f=b.defer(),h=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),h.include("users"),h.include("users.profile"),h.find({success:function(a){var b=g(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),h(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return h(c).then(function(b){d.sender=a.User.current(),d.receivers=g([b],!0)[0].recipients,k(b,d).then(function(){l.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),i(e).then(function(b){b?k(b[0],a).then(function(){d.resolve()},c):j(e).then(function(b){k(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message",function(a,b,c,d,e,f){function g(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function h(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function i(c){var d=b.defer(),f=new a.Query(e);return f.containsAll("users",c),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){var d=b.defer(),f=null,g=new a.ACL;f=new e({users:[]});for(var h=0;h<c.length;h++)g.setReadAccess(c[h].id,!0),g.setWriteAccess(c[h].id,!0),f.get("users").push(c[h]);return f.setACL(g),f.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var l=this;this.getThreads=function(){var f=b.defer(),h=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),h.include("users"),h.include("users.profile"),h.find({success:function(a){var b=g(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),h(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return h(c).then(function(b){d.sender=a.User.current(),d.receivers=g([b],!0)[0].recipients,k(b,d).then(function(){l.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),i(e).then(function(b){b?k(b[0],a).then(function(){d.resolve()},c):j(e).then(function(b){k(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message",function(a,b,c,d,e,f){function g(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function h(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function i(c){var d=b.defer(),f=new a.Query(e);return f.containsAll("users",c),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){var d=b.defer(),f=null,g=new a.ACL;f=new e({users:[]});for(var h=0;h<c.length;h++)g.setReadAccess(c[h].id,!0),g.setWriteAccess(c[h].id,!0),f.get("users").push(c[h]);return f.setACL(g),f.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var l=this;this.getThreads=function(){var f=b.defer(),h=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),h.include("users"),h.include("users.profile"),h.find({success:function(a){var b=g(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),h(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return h(c).then(function(b){d.sender=a.User.current(),d.receivers=g([b],!0)[0].recipients,k(b,d).then(function(){l.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),i(e).then(function(b){b?k(b[0],a).then(function(){d.resolve()},c):j(e).then(function(b){k(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message",function(a,b,c,d,e,f){function g(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function h(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function i(c){var d=b.defer(),f=new a.Query(e);return f.containsAll("users",c),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){var d=b.defer(),f=null,g=new a.ACL;f=new e({users:[]});for(var h=0;h<c.length;h++)g.setReadAccess(c[h].id,!0),g.setWriteAccess(c[h].id,!0),f.get("users").push(c[h]);return f.setACL(g),f.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var l=this;this.getThreads=function(){var f=b.defer(),h=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),h.include("users"),h.include("users.profile"),h.find({success:function(a){var b=g(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),h(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return h(c).then(function(b){d.sender=a.User.current(),d.receivers=g([b],!0)[0].recipients,k(b,d).then(function(){l.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),i(e).then(function(b){b?k(b[0],a).then(function(){d.resolve()},c):j(e).then(function(b){k(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message",function(a,b,c,d,e,f){function g(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function h(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function i(c){var d=b.defer(),f=new a.Query(e);return f.containsAll("users",c),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){var d=b.defer(),f=null,g=new a.ACL;f=new e({users:[]});for(var h=0;h<c.length;h++)g.setReadAccess(c[h].id,!0),g.setWriteAccess(c[h].id,!0),f.get("users").push(c[h]);return f.setACL(g),f.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var l=this;this.getThreads=function(){var f=b.defer(),h=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),h.include("users"),h.include("users.profile"),h.find({success:function(a){var b=g(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),h(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return h(c).then(function(b){d.sender=a.User.current(),d.receivers=g([b],!0)[0].recipients,k(b,d).then(function(){l.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),i(e).then(function(b){b?k(b[0],a).then(function(){d.resolve()},c):j(e).then(function(b){k(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.ionic-parse","tm.localstorage"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message",function(a,b,c,d,e,f){function g(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function h(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function i(c){var d=b.defer(),f=new a.Query(e);return f.containsAll("users",c),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){var d=b.defer(),f=null,g=new a.ACL;f=new e({users:[]});for(var h=0;h<c.length;h++)g.setReadAccess(c[h].id,!0),g.setWriteAccess(c[h].id,!0),f.get("users").push(c[h]);return f.setACL(g),f.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var l=this;this.getThreads=function(){var f=b.defer(),h=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),h.include("users"),h.include("users.profile"),h.find({success:function(a){var b=g(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),h(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return h(c).then(function(b){d.sender=a.User.current(),d.receivers=g([b],!0)[0].recipients,k(b,d).then(function(){l.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),i(e).then(function(b){b?k(b[0],a).then(function(){d.resolve()},c):j(e).then(function(b){k(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]);