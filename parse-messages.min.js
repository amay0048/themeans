/**
 * utils-demo - 
 * @version v0.0.1 - 2015-02-20
 * @link 
 * @license 
 */
"use strict";angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function i(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",l(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",l(g)),h.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(a){return g.createHash(a.sort().join(""))}function m(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var n=this;this.getThreads=function(){var f=b.defer(),g=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),g.include("users"),g.include("users.profile"),g.find({success:function(a){var b=h(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),i(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return i(c).then(function(b){d.sender=a.User.current(),d.receivers=h([b],!0)[0].recipients,m(b,d).then(function(){n.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),j(e).then(function(b){b?m(b[0],a).then(function(){d.resolve()},c):k(e).then(function(b){m(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function i(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",l(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",l(g)),h.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(a){return g.createHash(a.sort().join(""))}function m(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var n=this;this.getThreads=function(){var f=b.defer(),g=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),g.include("users"),g.include("users.profile"),g.find({success:function(a){var b=h(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),i(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return i(c).then(function(b){d.sender=a.User.current(),d.receivers=h([b],!0)[0].recipients,m(b,d).then(function(){n.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),j(e).then(function(b){b?m(b[0],a).then(function(){d.resolve()},c):k(e).then(function(b){m(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function i(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",l(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",l(g)),h.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(a){return g.createHash(a.sort().join(""))}function m(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var n=this;this.getThreads=function(){var f=b.defer(),g=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),g.include("users"),g.include("users.profile"),g.find({success:function(a){var b=h(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),i(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return i(c).then(function(b){d.sender=a.User.current(),d.receivers=h([b],!0)[0].recipients,m(b,d).then(function(){n.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),j(e).then(function(b){b?m(b[0],a).then(function(){d.resolve()},c):k(e).then(function(b){m(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function i(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",l(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",l(g)),h.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(a){return g.createHash(a.sort().join(""))}function m(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var n=this;this.getThreads=function(){var f=b.defer(),g=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),g.include("users"),g.include("users.profile"),g.find({success:function(a){var b=h(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),i(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return i(c).then(function(b){d.sender=a.User.current(),d.receivers=h([b],!0)[0].recipients,m(b,d).then(function(){n.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),j(e).then(function(b){b?m(b[0],a).then(function(){d.resolve()},c):k(e).then(function(b){m(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5",function(a,b,c,d,e,f,g){function h(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function i(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){for(var d=b.defer(),f=new a.Query(e),g=[],h=0;h<c.length;h++)g.push(c[h].id);return f.equalTo("userIdsHash",l(g)),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(c){for(var d=b.defer(),f=new a.ACL,g=[],h=new e({users:[]}),i=0;i<c.length;i++)f.setReadAccess(c[i].id,!0),f.setWriteAccess(c[i].id,!0),h.get("users").push(c[i]),g.push(c[i].id);return h.setACL(f),h.set("userIdsHash",l(g)),h.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function l(a){return g.createHash(a.sort().join(""))}function m(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var n=this;this.getThreads=function(){var f=b.defer(),g=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),g.include("users"),g.include("users.profile"),g.find({success:function(a){var b=h(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),i(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return i(c).then(function(b){d.sender=a.User.current(),d.receivers=h([b],!0)[0].recipients,m(b,d).then(function(){n.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),j(e).then(function(b){b?m(b[0],a).then(function(){d.resolve()},c):k(e).then(function(b){m(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message",function(a,b,c,d,e,f){function g(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function h(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function i(c){var d=b.defer(),f=new a.Query(e);return f.containsAll("users",c),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){var d=b.defer(),f=null,g=new a.ACL;f=new e({users:[]});for(var h=0;h<c.length;h++)g.setReadAccess(c[h].id,!0),g.setWriteAccess(c[h].id,!0),f.get("users").push(c[h]);return f.setACL(g),f.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var l=this;this.getThreads=function(){var f=b.defer(),h=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),h.include("users"),h.include("users.profile"),h.find({success:function(a){var b=g(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),h(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return h(c).then(function(b){d.sender=a.User.current(),d.receivers=g([b],!0)[0].recipients,k(b,d).then(function(){l.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),i(e).then(function(b){b?k(b[0],a).then(function(){d.resolve()},c):j(e).then(function(b){k(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message",function(a,b,c,d,e,f){function g(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function h(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function i(c){var d=b.defer(),f=new a.Query(e);return f.containsAll("users",c),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){var d=b.defer(),f=null,g=new a.ACL;f=new e({users:[]});for(var h=0;h<c.length;h++)g.setReadAccess(c[h].id,!0),g.setWriteAccess(c[h].id,!0),f.get("users").push(c[h]);return f.setACL(g),f.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var l=this;this.getThreads=function(){var f=b.defer(),h=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),h.include("users"),h.include("users.profile"),h.find({success:function(a){var b=g(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),h(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return h(c).then(function(b){d.sender=a.User.current(),d.receivers=g([b],!0)[0].recipients,k(b,d).then(function(){l.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),i(e).then(function(b){b?k(b[0],a).then(function(){d.resolve()},c):j(e).then(function(b){k(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message",function(a,b,c,d,e,f){function g(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function h(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function i(c){var d=b.defer(),f=new a.Query(e);return f.containsAll("users",c),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){var d=b.defer(),f=null,g=new a.ACL;f=new e({users:[]});for(var h=0;h<c.length;h++)g.setReadAccess(c[h].id,!0),g.setWriteAccess(c[h].id,!0),f.get("users").push(c[h]);return f.setACL(g),f.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var l=this;this.getThreads=function(){var f=b.defer(),h=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),h.include("users"),h.include("users.profile"),h.find({success:function(a){var b=g(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),h(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return h(c).then(function(b){d.sender=a.User.current(),d.receivers=g([b],!0)[0].recipients,k(b,d).then(function(){l.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),i(e).then(function(b){b?k(b[0],a).then(function(){d.resolve()},c):j(e).then(function(b){k(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message",function(a,b,c,d,e,f){function g(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function h(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function i(c){var d=b.defer(),f=new a.Query(e);return f.containsAll("users",c),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){var d=b.defer(),f=null,g=new a.ACL;f=new e({users:[]});for(var h=0;h<c.length;h++)g.setReadAccess(c[h].id,!0),g.setWriteAccess(c[h].id,!0),f.get("users").push(c[h]);return f.setACL(g),f.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var l=this;this.getThreads=function(){var f=b.defer(),h=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),h.include("users"),h.include("users.profile"),h.find({success:function(a){var b=g(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),h(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return h(c).then(function(b){d.sender=a.User.current(),d.receivers=g([b],!0)[0].recipients,k(b,d).then(function(){l.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),i(e).then(function(b){b?k(b[0],a).then(function(){d.resolve()},c):j(e).then(function(b){k(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.parse","tm.localstorage"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message",function(a,b,c,d,e,f){function g(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function h(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function i(c){var d=b.defer(),f=new a.Query(e);return f.containsAll("users",c),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){var d=b.defer(),f=null,g=new a.ACL;f=new e({users:[]});for(var h=0;h<c.length;h++)g.setReadAccess(c[h].id,!0),g.setWriteAccess(c[h].id,!0),f.get("users").push(c[h]);return f.setACL(g),f.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var l=this;this.getThreads=function(){var f=b.defer(),h=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),h.include("users"),h.include("users.profile"),h.find({success:function(a){var b=g(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),h(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return h(c).then(function(b){d.sender=a.User.current(),d.receivers=g([b],!0)[0].recipients,k(b,d).then(function(){l.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),i(e).then(function(b){b?k(b[0],a).then(function(){d.resolve()},c):j(e).then(function(b){k(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]),angular.module("tm.parse-messages",["tm.ionic-parse","tm.localstorage"]).service("tmMessages",["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message",function(a,b,c,d,e,f){function g(b,c){for(var d,e,f=a.User.current(),g=[],h=0;h<b.length;h++){e=c?b[h].getNgFormModel():b[h].getNgModel(),e.recipients=[],d=e.users;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function h(c){var d=b.defer(),f=new a.Query(e);return f.include("users"),f.include("users.profile"),f.get(c,{success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function i(c){var d=b.defer(),f=new a.Query(e);return f.containsAll("users",c),f.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function j(c){var d=b.defer(),f=null,g=new a.ACL;f=new e({users:[]});for(var h=0;h<c.length;h++)g.setReadAccess(c[h].id,!0),g.setWriteAccess(c[h].id,!0),f.get("users").push(c[h]);return f.setACL(g),f.save({success:function(a){d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function k(a,c){function d(a){e.reject(a)}var e=b.defer(),g=a.relation("messages");return c=new f(c),c.set("thread",a),c.save().then(function(b){g.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var l=this;this.getThreads=function(){var f=b.defer(),h=new a.Query(e);return c(function(){var a=d.getObject("message-threads");f.notify(a)},0),h.include("users"),h.include("users.profile"),h.find({success:function(a){var b=g(a);d.setObject("message-threads",b),b=d.getObject("message-threads"),f.resolve(b)},error:function(a){f.reject(a)}}),f.promise},this.getMessagesFromThread=function(a){var e=b.defer();return c(function(){var b=d.getObject("thread-"+a+"-messages");e.notify(b)},0),h(a).then(function(b){var c=b.relation("messages"),f=c.query();f.ascending("createdAt"),f.include("sender"),f.include("sender.profile"),f.include("receivers"),f.find({success:function(b){for(var c,f=[],g=0;g<b.length;g++)f.push(b[g].getNgModel());d.setObject("thread-"+a+"-messages",f),c=d.getObject("thread-"+a+"-messages"),e.resolve(c)},error:function(a){e.reject(a)}})},function(a){e.reject(a)}),e.promise},this.respond=function(c,d){function e(a){f.reject(a)}var f=b.defer();return h(c).then(function(b){d.sender=a.User.current(),d.receivers=g([b],!0)[0].recipients,k(b,d).then(function(){l.getMessagesFromThread(b.id).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function c(a){d.reject(a)}var d=b.defer(),e=[a.sender,a.receivers];return e=e.concat.apply([],e),i(e).then(function(b){b?k(b[0],a).then(function(){d.resolve()},c):j(e).then(function(b){k(b,a).then(function(){d.resolve()},c)},c)},c),d.promise}}]);