/**
 * themeans-core - 
 * @version v0.1.0 - 2015-04-04
 * @link 
 * @license 
 */
"use strict";angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5","$log","Profile","tmAccounts",function(b,c,d,e,f,g,h,i,j,k){function l(g){var h,j,k=c.defer(),l=new b.Query(f),o=a.messageThreadsCacheKey;return g&&(o=a.messageThreadsEditCacheKey),d(function(){j=e.getObject(o,[]),k.notify(j)},0),l.include("profiles"),l.find({success:function(a){h=n(a,g),e.setObject(o,h),h=e.getObject(o,[]),k.resolve(h)},error:function(a){return i.error("Parse Query Error: "+a.message,a.code),119===a.code?m(k):void k.reject(a)}}),k.promise}function m(a){k.getUserRolesWithErrorHandling(b.User.current(),!0).then(function(){},function(){return a.reject({title:"Your account is missing or something is wrong with authorisation.",message:"Please try logging in again or contacting support"})})}function n(a,c){for(var d,e,f=b.User.current().get("profile"),g=[],h=0;h<a.length;h++){e=c?a[h].getNgFormModel():a[h].getNgModel(),e.recipients=[],d=e.profiles;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function o(b,f){var g,h,j,k,l=c.defer(),m=a.messagesCacheKey+"/"+b;return f&&(m=a.messagesEditCacheKey+"/"+b),d(function(){k=e.getObject(m),l.notify(k)},0),p(b).then(function(a){g=a.relation("messages"),h=g.query(),h.ascending("createdAt"),h.include("sender"),h.include("receivers"),h.find({success:function(a){j=[];for(var b=0;b<a.length;b++)j.push(f?a[b].getNgFormModel():a[b].getNgModel());e.setObject(m,j),j=e.getObject(m),l.resolve(j)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),l.reject(a)}})},function(a){l.reject(a)}),l.promise}function p(a){var d=c.defer(),e=new b.Query(f);return e.include("profiles"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),d.reject(a)}}),d.promise}function q(a){for(var d=c.defer(),e=new b.Query(f),g=[],h=0;h<a.length;h++)g.push(a[h].id);return e.equalTo("profileIdsHash",s(g)),e.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function r(a,d){for(var e=c.defer(),g=new b.ACL,h=[],i=new f({profiles:[]}),j=0;j<a.length;j++)g.setReadAccess(d[j],!0),g.setWriteAccess(d[j],!0),i.get("profiles").push(a[j]),h.push(a[j].id);return i.setACL(g),i.set("profileIdsHash",s(h)),i.save({success:function(a){e.resolve(a)},error:function(a,b){e.reject(b)}}),e.promise}function s(a){return h.createHash(a.sort().join(""))}function t(a,b){function d(a){e.reject(a)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}return this.getThreadsForEditing=function(a){return l(!0,a)},this.getThreadsForDisplay=function(a){return l(!1,a)},this.getMessagesFromThreadForEditing=function(a){return o(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return o(a,!1)},this.respond=function(a,d){function e(a){i.error("Parse Error: "+a.message,a.code),f.reject(a)}var f=c.defer();return p(a).then(function(a){d.sender=b.User.current().get("profile"),d.receivers=n([a],!0)[0].recipients,t(a,d).then(function(){o(a.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function d(a){i.error("Parse Error: "+a.message,a.code),e.reject(a)}for(var e=c.defer(),f=[],g=[],h=0;h<a.receivers.length;h++){var k=new j;k.id=a.receivers[h].objectId,g.push(a.receivers[h].user.objectId),f.push(k)}a.receivers=f,g.push(b.User.current().id);var l=a.receivers.concat([a.sender]);return q(l).then(function(b){b?t(b[0],a).then(function(){e.resolve()},d):r(l,g).then(function(b){t(b,a).then(function(){e.resolve()},d)},d)},d),e.promise},this}],this}),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5","$log","Profile","tmAccounts",function(b,c,d,e,f,g,h,i,j,k){function l(g){var h,j,k=c.defer(),l=new b.Query(f),o=a.messageThreadsCacheKey;return g&&(o=a.messageThreadsEditCacheKey),d(function(){j=e.getObject(o,[]),k.notify(j)},0),l.include("profiles"),l.find({success:function(a){h=n(a,g),e.setObject(o,h),h=e.getObject(o,[]),k.resolve(h)},error:function(a){return i.error("Parse Query Error: "+a.message,a.code),119===a.code?m(k):void k.reject(a)}}),k.promise}function m(a){k.getUserRolesWithErrorHandling(b.User.current(),!0).then(function(){},function(){return a.reject({title:"Your account is missing or something is wrong with authorisation.",message:"Please try logging in again or contacting support"})})}function n(a,c){for(var d,e,f=b.User.current().get("profile"),g=[],h=0;h<a.length;h++){e=c?a[h].getNgFormModel():a[h].getNgModel(),e.recipients=[],d=e.profiles;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function o(b,f){var g,h,j,k,l=c.defer(),m=a.messagesCacheKey+"/"+b;return f&&(m=a.messagesEditCacheKey+"/"+b),d(function(){k=e.getObject(m),l.notify(k)},0),p(b).then(function(a){g=a.relation("messages"),h=g.query(),h.ascending("createdAt"),h.include("sender"),h.include("receivers"),h.find({success:function(a){j=[];for(var b=0;b<a.length;b++)j.push(f?a[b].getNgFormModel():a[b].getNgModel());e.setObject(m,j),j=e.getObject(m),l.resolve(j)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),l.reject(a)}})},function(a){l.reject(a)}),l.promise}function p(a){var d=c.defer(),e=new b.Query(f);return e.include("profiles"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),d.reject(a)}}),d.promise}function q(a){for(var d=c.defer(),e=new b.Query(f),g=[],h=0;h<a.length;h++)g.push(a[h].id);return e.equalTo("profileIdsHash",s(g)),e.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function r(a,d){for(var e=c.defer(),g=new b.ACL,h=[],i=new f({profiles:[]}),j=0;j<a.length;j++)g.setReadAccess(d[j],!0),g.setWriteAccess(d[j],!0),i.get("profiles").push(a[j]),h.push(a[j].id);return i.setACL(g),i.set("profileIdsHash",s(h)),i.save({success:function(a){e.resolve(a)},error:function(a,b){e.reject(b)}}),e.promise}function s(a){return h.createHash(a.sort().join(""))}function t(a,b){function d(a){e.reject(a)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}return this.getThreadsForEditing=function(a){return l(!0,a)},this.getThreadsForDisplay=function(a){return l(!1,a)},this.getMessagesFromThreadForEditing=function(a){return o(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return o(a,!1)},this.respond=function(a,d){function e(a){i.error("Parse Error: "+a.message,a.code),f.reject(a)}var f=c.defer();return p(a).then(function(a){d.sender=b.User.current().get("profile"),d.receivers=n([a],!0)[0].recipients,t(a,d).then(function(){o(a.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function d(a){i.error("Parse Error: "+a.message,a.code),e.reject(a)}for(var e=c.defer(),f=[],g=[],h=0;h<a.receivers.length;h++){var k=new j;k.id=a.receivers[h].objectId,g.push(a.receivers[h].user.objectId),f.push(k)}a.receivers=f,g.push(b.User.current().id);var l=a.receivers.concat([a.sender]);return q(l).then(function(b){b?t(b[0],a).then(function(){e.resolve()},d):r(l,g).then(function(b){t(b,a).then(function(){e.resolve()},d)},d)},d),e.promise},this}],this}),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5","$log","Profile","tmAccounts",function(b,c,d,e,f,g,h,i,j,k){function l(g){var h,j,k=c.defer(),l=new b.Query(f),o=a.messageThreadsCacheKey;return g&&(o=a.messageThreadsEditCacheKey),d(function(){j=e.getObject(o,[]),k.notify(j)},0),l.include("profiles"),l.find({success:function(a){h=n(a,g),e.setObject(o,h),h=e.getObject(o,[]),k.resolve(h)},error:function(a){return i.error("Parse Query Error: "+a.message,a.code),119===a.code?m(k):void k.reject(a)}}),k.promise}function m(a){k.getUserRolesWithErrorHandling(b.User.current(),!0).then(function(){},function(){return a.reject({title:"Your account is missing or something is wrong with authorisation.",message:"Please try logging in again or contacting support"})})}function n(a,c){for(var d,e,f=b.User.current().get("profile"),g=[],h=0;h<a.length;h++){e=c?a[h].getNgFormModel():a[h].getNgModel(),e.recipients=[],d=e.profiles;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function o(b,f){var g,h,j,k,l=c.defer(),m=a.messagesCacheKey+"/"+b;return f&&(m=a.messagesEditCacheKey+"/"+b),d(function(){k=e.getObject(m),l.notify(k)},0),p(b).then(function(a){g=a.relation("messages"),h=g.query(),h.ascending("createdAt"),h.include("sender"),h.include("receivers"),h.find({success:function(a){j=[];for(var b=0;b<a.length;b++)j.push(f?a[b].getNgFormModel():a[b].getNgModel());e.setObject(m,j),j=e.getObject(m),l.resolve(j)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),l.reject(a)}})},function(a){l.reject(a)}),l.promise}function p(a){var d=c.defer(),e=new b.Query(f);return e.include("profiles"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),d.reject(a)}}),d.promise}function q(a){for(var d=c.defer(),e=new b.Query(f),g=[],h=0;h<a.length;h++)g.push(a[h].id);return e.equalTo("profileIdsHash",s(g)),e.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function r(a,d){for(var e=c.defer(),g=new b.ACL,h=[],i=new f({profiles:[]}),j=0;j<a.length;j++)g.setReadAccess(d[j],!0),g.setWriteAccess(d[j],!0),i.get("profiles").push(a[j]),h.push(a[j].id);return i.setACL(g),i.set("profileIdsHash",s(h)),i.save({success:function(a){e.resolve(a)},error:function(a,b){e.reject(b)}}),e.promise}function s(a){return h.createHash(a.sort().join(""))}function t(a,b){function d(a){e.reject(a)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}return this.getThreadsForEditing=function(a){return l(!0,a)},this.getThreadsForDisplay=function(a){return l(!1,a)},this.getMessagesFromThreadForEditing=function(a){return o(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return o(a,!1)},this.respond=function(a,d){function e(a){i.error("Parse Error: "+a.message,a.code),f.reject(a)}var f=c.defer();return p(a).then(function(a){d.sender=b.User.current().get("profile"),d.receivers=n([a],!0)[0].recipients,t(a,d).then(function(){o(a.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function d(a){i.error("Parse Error: "+a.message,a.code),e.reject(a)}for(var e=c.defer(),f=[],g=[],h=0;h<a.receivers.length;h++){var k=new j;k.id=a.receivers[h].objectId,g.push(a.receivers[h].user.objectId),f.push(k)}a.receivers=f,g.push(b.User.current().id);var l=a.receivers.concat([a.sender]);return q(l).then(function(b){b?t(b[0],a).then(function(){e.resolve()},d):r(l,g).then(function(b){t(b,a).then(function(){e.resolve()},d)},d)},d),e.promise},this}],this}),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){var b=a.Object.extend({className:"MessageThread"});return b}]).factory("Message",["Parse",function(a){var b=a.Object.extend({className:"Message",defaults:{status:1}});return b}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5","$log","Profile","tmAccounts",function(b,c,d,e,f,g,h,i,j,k){function l(g){var h,j,k=c.defer(),l=new b.Query(f),o=a.messageThreadsCacheKey;return g&&(o=a.messageThreadsEditCacheKey),d(function(){j=e.getObject(o,[]),k.notify(j)},0),l.include("profiles"),l.find({success:function(a){h=n(a,g),e.setObject(o,h),h=e.getObject(o,[]),k.resolve(h)},error:function(a){return i.error("Parse Query Error: "+a.message,a.code),119===a.code?m(k):void k.reject(a)}}),k.promise}function m(a){k.getUserRolesWithErrorHandling(b.User.current(),!0).then(function(){},function(){return a.reject({title:"Your account is missing or something is wrong with authorisation.",message:"Please try logging in again or contacting support"})})}function n(a,c){for(var d,e,f=b.User.current().get("profile"),g=[],h=0;h<a.length;h++){e=c?a[h].getNgFormModel():a[h].getNgModel(),e.recipients=[],d=e.profiles;for(var i=0;i<d.length;i++)d[i].objectId!==f.id&&e.recipients.push(d[i]);g.push(e)}return g}function o(b,f){var g,h,j,k,l=c.defer(),m=a.messagesCacheKey+"/"+b;return f&&(m=a.messagesEditCacheKey+"/"+b),d(function(){k=e.getObject(m),l.notify(k)},0),p(b).then(function(a){g=a.relation("messages"),h=g.query(),h.ascending("createdAt"),h.include("sender"),h.include("receivers"),h.find({success:function(a){j=[];for(var b=0;b<a.length;b++)j.push(f?a[b].getNgFormModel():a[b].getNgModel());e.setObject(m,j),j=e.getObject(m),l.resolve(j)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),l.reject(a)}})},function(a){l.reject(a)}),l.promise}function p(a){var d=c.defer(),e=new b.Query(f);return e.include("profiles"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),d.reject(a)}}),d.promise}function q(a){for(var d=c.defer(),e=new b.Query(f),g=[],h=0;h<a.length;h++)g.push(a[h].id);return e.equalTo("profileIdsHash",s(g)),e.find({success:function(a){a.length>1&&d.reject({message:"There are duplicate threads. Please contact system admin."}),a.length||d.resolve(!1),d.resolve(a)},error:function(a){d.reject(a)}}),d.promise}function r(a,d){for(var e=c.defer(),g=new b.ACL,h=[],i=new f({profiles:[]}),j=0;j<a.length;j++)g.setReadAccess(d[j],!0),g.setWriteAccess(d[j],!0),i.get("profiles").push(a[j]),h.push(a[j].id);return i.setACL(g),i.set("profileIdsHash",s(h)),i.save({success:function(a){e.resolve(a)},error:function(a,b){e.reject(b)}}),e.promise}function s(a){return h.createHash(a.sort().join(""))}function t(a,b){function d(a){e.reject(a)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}return this.getThreadsForEditing=function(a){return l(!0,a)},this.getThreadsForDisplay=function(a){return l(!1,a)},this.getMessagesFromThreadForEditing=function(a){return o(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return o(a,!1)},this.respond=function(a,d){function e(a){i.error("Parse Error: "+a.message,a.code),f.reject(a)}var f=c.defer();return p(a).then(function(a){d.sender=b.User.current().get("profile"),d.receivers=n([a],!0)[0].recipients,t(a,d).then(function(){o(a.id,!1).then(function(a){f.resolve(a)},e)},e)},e),f.promise},this.send=function(a){function d(a){i.error("Parse Error: "+a.message,a.code),e.reject(a)}for(var e=c.defer(),f=[],g=[],h=0;h<a.receivers.length;h++){var k=new j;k.id=a.receivers[h].objectId,g.push(a.receivers[h].user.objectId),f.push(k)}a.receivers=f,g.push(b.User.current().id);var l=a.receivers.concat([a.sender]);return q(l).then(function(b){b?t(b[0],a).then(function(){e.resolve()},d):r(l,g).then(function(b){t(b,a).then(function(){e.resolve()},d)},d)},d),e.promise},this}],this});