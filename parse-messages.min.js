/**
 * themeans-core - 
 * @version v0.1.0 - 2015-04-04
 * @link 
 * @license 
 */
"use strict";angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){return a.Object.extend("MessageThread")}]).factory("Message",["Parse",function(a){return a.Object.extend("Message")}]).run(["$rootScope","tmMessages",function(a,b){b.setRootScope(a)}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit",profilesForbiddenDisplayName:"No Name Available"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5","$log","Profile","tmAccounts","$document",function(b,c,d,e,f,g,h,i,j,k){function l(a){var d=c.defer(),e=new b.Query(f);return e.include("profiles"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),d.reject(a)}}),d.promise}function m(g){var h,j,k=c.defer(),l=new b.Query(f),m=a.messageThreadsCacheKey;return g&&(m=a.messageThreadsEditCacheKey),d(function(){j=e.getObject(m,[]),k.notify(j)},0),l.include("profiles"),l.find().then(function(b){function c(){b.forEach(function(b){var d=b.get("profiles").indexOf(null);d>=0&&(i.warn("User does not have permissions to view sender or recipient profile(s) for MessageThread/"+b.id),b.get("profiles").splice(d,1,{fullName:a.profilesForbiddenDisplayName}),c())})}c(),h=n(b,g),e.setObject(m,h),p(!1).then(function(a){a.length>0&&h.forEach(function(b){a.forEach(function(a){b.objectId===a.get("thread").id&&(b.unreadMessage=!0)})}),h.sort(function(a,b){return a.unreadMessage===b.unreadMessage?0:a.unreadMessage?-1:1}),k.resolve(h)})},function(a){return i.error("Parse Query Error: "+a.message,a.code),119===a.code?q(k,"MessageThread"):void k.reject(a)}),k.promise}function n(a,c){var d,e,f=b.User.current().get("profile"),g=[];return g=a.map(function(a){return e=c?a.getNgFormModel():a.getNgModel(),e.recipients=[],d=e.profiles,d.forEach(function(a){a.objectId!==f.id&&e.recipients.push(a)}),e})}function o(f,g){var h,j,k,m,n=c.defer(),o=a.messagesCacheKey+"/"+f;return g&&(o=a.messagesEditCacheKey+"/"+f),d(function(){m=e.getObject(o),n.notify(m)},0),l(f).then(function(d){h=d.relation("messages"),j=h.query(),j.ascending("createdAt"),j.include("sender"),j.include("recipients"),j.find({success:function(d){var f=[];k=d.map(function(c){return c.get("recipients").forEach(function(a){a.profile.id===b.User.current().get("profile").id&&(a.viewed=!0)}),f.push(c.save()),c.get("sender")||c.set("sender",{fullName:a.profilesForbiddenDisplayName}),g?c.getNgFormModel():c.getNgModel()}),e.setObject(o,k),k=e.getObject(o),c.all(f).then(function(){n.resolve(k)},function(a){i.error("Parse Save Error: "+a.message,a.code),n.resole(k)})},error:function(a){i.error("Parse Query Error: "+a.message,a.code),n.reject(a)}})},function(a){n.reject(a)}),n.promise}function p(a,d){var e,f=c.defer(),h=new b.Query(g);return d&&d.length||(d=[{profile:b.User.current().get("profile"),viewed:!1}]),e={success:function(b){a&&"number"==typeof b&&v&&v.GLOBALS&&v.GLOBALS.events&&v.GLOBALS.events.updateMessageBadge&&v.$broadcast(v.GLOBALS.events.updateMessageBadge,{unreadCount:b}),f.resolve(b)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),f.resolve()}},h.containedIn("recipients",d),a?h.count(e):h.find(e),f.promise}function q(a,c){return c=c?" on a "+c:"",b.User.current()?void k.getUserRoles(b.User.current()).then(function(){return a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+c})},function(){return e.clear(),b.User.logOut(),a.reject({title:"Your account is missing or something is wrong with authorisation.",message:"Please try logging in again or contacting support"})}):a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+c})}function r(a){var d,e=c.defer(),g=new b.Query(f);return d=a.map(function(a){return a.id}),g.equalTo("profileIdsHash",t(d)),g.find({success:function(a){return a.length>1?e.reject({message:"There are duplicate threads. Please contact system admin."}):a.length?void e.resolve(a):e.resolve(!1)},error:function(a){e.reject(a)}}),e.promise}function s(a,d){var e=c.defer(),g=new b.ACL,h=[];a.length!==d.length&&i.error("Error with message thread participants in createThread(): participantProfiles.length is not equal to userIds to length");for(var j=new f({profiles:[]}),k=0;k<a.length;k++)g.setReadAccess(d[k],!0),g.setWriteAccess(d[k],!0),j.get("profiles").push(a[k]),h.push(a[k].id);return j.setACL(g),j.set("profileIdsHash",t(h)),j.save({success:function(a){e.resolve(a)},error:function(a,b){e.reject(b)}}),e.promise}function t(a){return h.createHash(a.sort().join(""))}function u(a,b){function d(a){e.reject(a)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.set("sender",b.get("sender")),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var v;return this.setRootScope=function(a){v=a},this.getThreadsForEditing=function(){return m(!0)},this.getThreadsForDisplay=function(){return m(!1)},this.getMessagesFromThreadForEditing=function(a){return o(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return o(a,!1)},this.updateMessageBadge=function(a){return p(!0,a)},this.getThreadsWithUnreadMessages=function(a){return p(!1,a)},this.respond=function(a,d){function e(a){i.error("Parse Error: "+a.message,a.code),g.reject(a)}var f,g=c.defer();return l(a).then(function(a){d.sender=b.User.current().get("profile"),d.recipients=n([a],!0)[0].recipients,d.recipients=d.recipients.map(function(a){return f={profile:a,viewed:!1}}),u(a,d).then(function(){o(a.id,!1).then(function(a){g.resolve(a)},e)},e)},e),g.promise},this.send=function(a){function d(a){i.error("Parse Error: "+a.message,a.code),g.reject(a)}var e,f,g=c.defer(),h=[],k=[];return a.recipients=a.recipients.map(function(a){return e=new j,e.id=a.objectId,h.push(a.user.objectId),k.push(e),f={profile:e,viewed:!1}}),h.push(b.User.current().id),k.push(a.sender),r(k).then(function(b){b?u(b[0],a).then(function(){g.resolve()},d):s(k,h).then(function(b){u(b,a).then(function(){g.resolve()},d)},d)},d),g.promise},this}],this}),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){return a.Object.extend("MessageThread")}]).factory("Message",["Parse",function(a){return a.Object.extend("Message")}]).run(["$rootScope","tmMessages",function(a,b){b.setRootScope(a)}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit",profilesForbiddenDisplayName:"No Name Available"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5","$log","Profile","tmAccounts","$document",function(b,c,d,e,f,g,h,i,j,k){function l(a){var d=c.defer(),e=new b.Query(f);return e.include("profiles"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),d.reject(a)}}),d.promise}function m(g){var h,j,k=c.defer(),l=new b.Query(f),m=a.messageThreadsCacheKey;return g&&(m=a.messageThreadsEditCacheKey),d(function(){j=e.getObject(m,[]),k.notify(j)},0),l.include("profiles"),l.find().then(function(b){function c(){b.forEach(function(b){var d=b.get("profiles").indexOf(null);d>=0&&(i.warn("User does not have permissions to view sender or recipient profile(s) for MessageThread/"+b.id),b.get("profiles").splice(d,1,{fullName:a.profilesForbiddenDisplayName}),c())})}c(),h=n(b,g),e.setObject(m,h),p(!1).then(function(a){a.length>0&&h.forEach(function(b){a.forEach(function(a){b.objectId===a.get("thread").id&&(b.unreadMessage=!0)})}),h.sort(function(a,b){return a.unreadMessage===b.unreadMessage?0:a.unreadMessage?-1:1}),k.resolve(h)})},function(a){return i.error("Parse Query Error: "+a.message,a.code),119===a.code?q(k,"MessageThread"):void k.reject(a)}),k.promise}function n(a,c){var d,e,f=b.User.current().get("profile"),g=[];return g=a.map(function(a){return e=c?a.getNgFormModel():a.getNgModel(),e.recipients=[],d=e.profiles,d.forEach(function(a){a.objectId!==f.id&&e.recipients.push(a)}),e})}function o(f,g){var h,j,k,m,n=c.defer(),o=a.messagesCacheKey+"/"+f;return g&&(o=a.messagesEditCacheKey+"/"+f),d(function(){m=e.getObject(o),n.notify(m)},0),l(f).then(function(d){h=d.relation("messages"),j=h.query(),j.ascending("createdAt"),j.include("sender"),j.include("recipients"),j.find({success:function(d){var f=[];k=d.map(function(c){return c.get("recipients").forEach(function(a){a.profile.id===b.User.current().get("profile").id&&(a.viewed=!0)}),f.push(c.save()),c.get("sender")||c.set("sender",{fullName:a.profilesForbiddenDisplayName}),g?c.getNgFormModel():c.getNgModel()}),e.setObject(o,k),k=e.getObject(o),c.all(f).then(function(){n.resolve(k)},function(a){i.error("Parse Save Error: "+a.message,a.code),n.resole(k)})},error:function(a){i.error("Parse Query Error: "+a.message,a.code),n.reject(a)}})},function(a){n.reject(a)}),n.promise}function p(a,d){var e,f=c.defer(),h=new b.Query(g);return d&&d.length||(d=[{profile:b.User.current().get("profile"),viewed:!1}]),e={success:function(b){a&&"number"==typeof b&&v&&v.GLOBALS&&v.GLOBALS.events&&v.GLOBALS.events.updateMessageBadge&&v.$broadcast(v.GLOBALS.events.updateMessageBadge,{unreadCount:b}),f.resolve(b)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),f.resolve()}},h.containedIn("recipients",d),a?h.count(e):h.find(e),f.promise}function q(a,c){return c=c?" on a "+c:"",b.User.current()?void k.getUserRoles(b.User.current()).then(function(){return a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+c})},function(){return e.clear(),b.User.logOut(),a.reject({title:"Your account is missing or something is wrong with authorisation.",message:"Please try logging in again or contacting support"})}):a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+c})}function r(a){var d,e=c.defer(),g=new b.Query(f);return d=a.map(function(a){return a.id}),g.equalTo("profileIdsHash",t(d)),g.find({success:function(a){return a.length>1?e.reject({message:"There are duplicate threads. Please contact system admin."}):a.length?void e.resolve(a):e.resolve(!1)},error:function(a){e.reject(a)}}),e.promise}function s(a,d){var e=c.defer(),g=new b.ACL,h=[];a.length!==d.length&&i.error("Error with message thread participants in createThread(): participantProfiles.length is not equal to userIds to length");for(var j=new f({profiles:[]}),k=0;k<a.length;k++)g.setReadAccess(d[k],!0),g.setWriteAccess(d[k],!0),j.get("profiles").push(a[k]),h.push(a[k].id);return j.setACL(g),j.set("profileIdsHash",t(h)),j.save({success:function(a){e.resolve(a)},error:function(a,b){e.reject(b)}}),e.promise}function t(a){return h.createHash(a.sort().join(""))}function u(a,b){function d(a){e.reject(a)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.set("sender",b.get("sender")),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var v;return this.setRootScope=function(a){v=a},this.getThreadsForEditing=function(){return m(!0)},this.getThreadsForDisplay=function(){return m(!1)},this.getMessagesFromThreadForEditing=function(a){return o(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return o(a,!1)},this.updateMessageBadge=function(a){return p(!0,a)},this.getThreadsWithUnreadMessages=function(a){return p(!1,a)},this.respond=function(a,d){function e(a){i.error("Parse Error: "+a.message,a.code),g.reject(a)}var f,g=c.defer();return l(a).then(function(a){d.sender=b.User.current().get("profile"),d.recipients=n([a],!0)[0].recipients,d.recipients=d.recipients.map(function(a){return f={profile:a,viewed:!1}}),u(a,d).then(function(){o(a.id,!1).then(function(a){g.resolve(a)},e)},e)},e),g.promise},this.send=function(a){function d(a){i.error("Parse Error: "+a.message,a.code),g.reject(a)}var e,f,g=c.defer(),h=[],k=[];return a.recipients=a.recipients.map(function(a){return e=new j,e.id=a.objectId,h.push(a.user.objectId),k.push(e),f={profile:e,viewed:!1}}),h.push(b.User.current().id),k.push(a.sender),r(k).then(function(b){b?u(b[0],a).then(function(){g.resolve()},d):s(k,h).then(function(b){u(b,a).then(function(){g.resolve()},d)},d)},d),g.promise},this}],this}),angular.module("tm.parse-messages",["tm.parse","tm.localstorage","angular-md5"]).factory("MessageThread",["Parse",function(a){return a.Object.extend("MessageThread")}]).factory("Message",["Parse",function(a){return a.Object.extend("Message")}]).run(["$rootScope","tmMessages",function(a,b){b.setRootScope(a)}]).provider("tmMessages",function(){var a={messagesCacheKey:"User/Messages",messagesEditCacheKey:"user/Messages/Edit",messageThreadsCacheKey:"User/Messages/Threads",messageThreadsEditCacheKey:"User/Messages/Threads/Edit",messageThreadCacheKey:"User/Messages/Thread",messageThreadEditCacheKey:"User/Messages/Thread/Edit",profilesForbiddenDisplayName:"No Name Available"};return this.configure=function(b){angular.extend(a,b)},this.$get=["Parse","$q","$timeout","tmLocalStorage","MessageThread","Message","md5","$log","Profile","tmAccounts","$document",function(b,c,d,e,f,g,h,i,j,k){function l(a){var d=c.defer(),e=new b.Query(f);return e.include("profiles"),e.get(a,{success:function(a){d.resolve(a)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),d.reject(a)}}),d.promise}function m(g){var h,j,k=c.defer(),l=new b.Query(f),m=a.messageThreadsCacheKey;return g&&(m=a.messageThreadsEditCacheKey),d(function(){j=e.getObject(m,[]),k.notify(j)},0),l.include("profiles"),l.find().then(function(b){function c(){b.forEach(function(b){var d=b.get("profiles").indexOf(null);d>=0&&(i.warn("User does not have permissions to view sender or recipient profile(s) for MessageThread/"+b.id),b.get("profiles").splice(d,1,{fullName:a.profilesForbiddenDisplayName}),c())})}c(),h=n(b,g),e.setObject(m,h),p(!1).then(function(a){a.length>0&&h.forEach(function(b){a.forEach(function(a){b.objectId===a.get("thread").id&&(b.unreadMessage=!0)})}),h.sort(function(a,b){return a.unreadMessage===b.unreadMessage?0:a.unreadMessage?-1:1}),k.resolve(h)})},function(a){return i.error("Parse Query Error: "+a.message,a.code),119===a.code?q(k,"MessageThread"):void k.reject(a)}),k.promise}function n(a,c){var d,e,f=b.User.current().get("profile"),g=[];return g=a.map(function(a){return e=c?a.getNgFormModel():a.getNgModel(),e.recipients=[],d=e.profiles,d.forEach(function(a){a.objectId!==f.id&&e.recipients.push(a)}),e})}function o(f,g){var h,j,k,m,n=c.defer(),o=a.messagesCacheKey+"/"+f;return g&&(o=a.messagesEditCacheKey+"/"+f),d(function(){m=e.getObject(o),n.notify(m)},0),l(f).then(function(d){h=d.relation("messages"),j=h.query(),j.ascending("createdAt"),j.include("sender"),j.include("recipients"),j.find({success:function(d){var f=[];k=d.map(function(c){return c.get("recipients").forEach(function(a){a.profile.id===b.User.current().get("profile").id&&(a.viewed=!0)}),f.push(c.save()),c.get("sender")||c.set("sender",{fullName:a.profilesForbiddenDisplayName}),g?c.getNgFormModel():c.getNgModel()}),e.setObject(o,k),k=e.getObject(o),c.all(f).then(function(){n.resolve(k)},function(a){i.error("Parse Save Error: "+a.message,a.code),n.resole(k)})},error:function(a){i.error("Parse Query Error: "+a.message,a.code),n.reject(a)}})},function(a){n.reject(a)}),n.promise}function p(a,d){var e,f=c.defer(),h=new b.Query(g);return d&&d.length||(d=[{profile:b.User.current().get("profile"),viewed:!1}]),e={success:function(b){a&&"number"==typeof b&&v&&v.GLOBALS&&v.GLOBALS.events&&v.GLOBALS.events.updateMessageBadge&&v.$broadcast(v.GLOBALS.events.updateMessageBadge,{unreadCount:b}),f.resolve(b)},error:function(a){i.error("Parse Query Error: "+a.message,a.code),f.resolve()}},h.containedIn("recipients",d),a?h.count(e):h.find(e),f.promise}function q(a,c){return c=c?" on a "+c:"",b.User.current()?void k.getUserRoles(b.User.current()).then(function(){return a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+c})},function(){return e.clear(),b.User.logOut(),a.reject({title:"Your account is missing or something is wrong with authorisation.",message:"Please try logging in again or contacting support"})}):a.reject({title:"Authorisation error: ",message:"You cannot perform this operation"+c})}function r(a){var d,e=c.defer(),g=new b.Query(f);return d=a.map(function(a){return a.id}),g.equalTo("profileIdsHash",t(d)),g.find({success:function(a){return a.length>1?e.reject({message:"There are duplicate threads. Please contact system admin."}):a.length?void e.resolve(a):e.resolve(!1)},error:function(a){e.reject(a)}}),e.promise}function s(a,d){var e=c.defer(),g=new b.ACL,h=[];a.length!==d.length&&i.error("Error with message thread participants in createThread(): participantProfiles.length is not equal to userIds to length");for(var j=new f({profiles:[]}),k=0;k<a.length;k++)g.setReadAccess(d[k],!0),g.setWriteAccess(d[k],!0),j.get("profiles").push(a[k]),h.push(a[k].id);return j.setACL(g),j.set("profileIdsHash",t(h)),j.save({success:function(a){e.resolve(a)},error:function(a,b){e.reject(b)}}),e.promise}function t(a){return h.createHash(a.sort().join(""))}function u(a,b){function d(a){e.reject(a)}var e=c.defer(),f=a.relation("messages");return b=new g(b),b.set("thread",a),b.set("sender",b.get("sender")),b.save().then(function(b){f.add(b),a.save().then(function(){e.resolve(b)},d)},d),e.promise}var v;return this.setRootScope=function(a){v=a},this.getThreadsForEditing=function(){return m(!0)},this.getThreadsForDisplay=function(){return m(!1)},this.getMessagesFromThreadForEditing=function(a){return o(a,!0)},this.getMessagesFromThreadForDisplay=function(a){return o(a,!1)},this.updateMessageBadge=function(a){return p(!0,a)},this.getThreadsWithUnreadMessages=function(a){return p(!1,a)},this.respond=function(a,d){function e(a){i.error("Parse Error: "+a.message,a.code),g.reject(a)}var f,g=c.defer();return l(a).then(function(a){d.sender=b.User.current().get("profile"),d.recipients=n([a],!0)[0].recipients,d.recipients=d.recipients.map(function(a){return f={profile:a,viewed:!1}}),u(a,d).then(function(){o(a.id,!1).then(function(a){g.resolve(a)},e)},e)},e),g.promise},this.send=function(a){function d(a){i.error("Parse Error: "+a.message,a.code),g.reject(a)}var e,f,g=c.defer(),h=[],k=[];return a.recipients=a.recipients.map(function(a){return e=new j,e.id=a.objectId,h.push(a.user.objectId),k.push(e),f={profile:e,viewed:!1}}),h.push(b.User.current().id),k.push(a.sender),r(k).then(function(b){b?u(b[0],a).then(function(){g.resolve()},d):s(k,h).then(function(b){u(b,a).then(function(){g.resolve()},d)},d)},d),g.promise},this}],this});